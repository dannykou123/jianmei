<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="健美滷味團購管理系統 - 管理員後台">
  <title>健美滷味 - 管理後台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: { 50: '#FFF5F3', 100: '#FFE5DF', 200: '#FFD4CC', 300: '#FFB8A8', 400: '#FF9B82', 500: '#C84B31', 600: '#B54329', 700: '#9A3921', 800: '#7F2F1A', 900: '#642512' } }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    [v-cloak] { display: none; }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    @keyframes zoom-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    @keyframes slide-down { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fade-in 0.2s ease-out; }
    .animate-zoom-in { animation: zoom-in 0.3s ease-out; }
    .animate-slide-down { animation: slide-down 0.3s ease-out; }
    .hide-scroll::-webkit-scrollbar { display: none; }
    .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    @media print {
      .no-print { display: none !important; }
      body { background: white !important; margin: 0 !important; padding: 0 !important; }
      /* 出貨單列印 75x100mm */
      body.printing-labels .hide-for-label-print { display: none !important; }
      body.printing-labels #label-print-area { display: block !important; }
      body:not(.printing-labels) #label-print-area { display: none !important; }
      /* 備貨單列印 75x100mm */
      body.printing-stock .hide-for-stock-print { display: none !important; }
      body.printing-stock #stock-print-area { display: block !important; }
      body:not(.printing-stock) #stock-print-area { display: none !important; }
      .stock-ticket {
        width: 75mm; height: 100mm;
        page-break-after: always; page-break-inside: avoid;
        padding: 3mm; box-sizing: border-box;
        font-family: Arial, sans-serif; overflow: hidden;
        display: flex; flex-direction: column;
      }
      .stock-ticket:last-child { page-break-after: auto; }
      .stock-ticket-header { border-bottom: 1.5px solid #000; padding-bottom: 2mm; margin-bottom: 2mm; }
      .stock-ticket-title { font-size: 11pt; font-weight: bold; }
      .stock-ticket-meta { font-size: 7pt; color: #444; margin-top: 0.5mm; }
      .stock-ticket-items { flex: 1; overflow: hidden; }
      .stock-ticket-row { font-size: 8.5pt; display: flex; justify-content: space-between; line-height: 1.7; border-bottom: 0.3px solid #ddd; }
      .stock-ticket-name { flex: 1; }
      .stock-ticket-qty { white-space: nowrap; margin-left: 2mm; font-weight: bold; }
      .stock-ticket-footer { border-top: 1px solid #000; padding-top: 1.5mm; margin-top: auto; font-size: 7pt; display: flex; justify-content: space-between; color: #666; }
      .label-ticket {
        width: 75mm; height: 100mm;
        page-break-after: always; page-break-inside: avoid;
        border: 1px solid #000; padding: 3mm;
        box-sizing: border-box; font-family: Arial, sans-serif;
        overflow: hidden; display: flex; flex-direction: column;
      }
      .label-ticket:last-child { page-break-after: auto; }
      .label-header { border-bottom: 1.5px solid #000; padding-bottom: 2mm; margin-bottom: 2mm; }
      .label-company { font-size: 11pt; font-weight: bold; line-height: 1.3; }
      .label-delivery { font-size: 7.5pt; color: #333; margin-top: 0.5mm; }
      .label-customer { font-size: 10pt; font-weight: bold; margin-bottom: 1.5mm; }
      .label-items { flex: 1; overflow: hidden; }
      .label-item-row { font-size: 7.5pt; display: flex; justify-content: space-between; line-height: 1.6; }
      .label-item-name { flex: 1; }
      .label-item-right { white-space: nowrap; margin-left: 2mm; }
      .label-footer { border-top: 1.5px solid #000; padding-top: 1.5mm; margin-top: auto; }
      .label-total { font-size: 11pt; font-weight: bold; text-align: right; }
      .label-note { font-size: 7pt; color: #333; margin-top: 1mm; border-top: 0.5px dashed #aaa; padding-top: 1mm; }
      .label-brand { font-size: 6.5pt; color: #888; text-align: center; margin-top: 1mm; }
    }
    #label-print-area { display: none; }
    #stock-print-area { display: none; }
  </style>
</head>
<body>
  <div id="app" v-cloak>
    
    <!-- 管理員登入頁面 -->
    <div v-if="currentView === 'login'" class="flex flex-col items-center justify-center min-h-screen bg-stone-100 px-6">
      <form @submit.prevent="handleLogin" class="bg-white p-10 rounded-[2rem] shadow-2xl w-full max-w-sm border border-white relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-500 to-brand-600"></div>
        <h2 class="text-2xl font-black mb-10 text-center text-stone-800 tracking-tight">管理後台登入</h2>
        <div class="space-y-6">
          <div class="group">
            <label class="text-[10px] font-black text-stone-400 uppercase ml-1 tracking-widest">Account ID</label>
            <input v-model="loginForm.id" type="text" autocomplete="username" placeholder="請輸入帳號" class="w-full p-4 mt-1 border-2 border-stone-100 bg-stone-50 rounded-2xl focus:border-brand-500 focus:bg-white outline-none transition font-bold text-stone-700 placeholder:font-normal">
          </div>
          <div class="group">
            <label class="text-[10px] font-black text-stone-400 uppercase ml-1 tracking-widest">Password</label>
            <input v-model="loginForm.pass" type="password" autocomplete="current-password" placeholder="請輸入密碼" class="w-full p-4 mt-1 border-2 border-stone-100 bg-stone-50 rounded-2xl focus:border-brand-500 focus:bg-white outline-none transition" required>
          </div>
          <button type="submit" :disabled="loading" class="w-full bg-stone-800 text-white py-4 rounded-2xl shadow-xl font-black hover:bg-black active:scale-[0.98] transition mt-2">
            {{ loading ? '驗證中...' : '確認登入' }}
          </button>
        </div>
      </form>
    </div>

    <!-- 管理員後台 -->
    <div v-else-if="currentView === 'admin'" class="min-h-screen bg-stone-50 pb-20 hide-for-label-print hide-for-stock-print">
      
      <!-- 導航欄 -->
      <div class="bg-white/90 backdrop-blur-md px-4 py-3 shadow-sm sticky top-0 z-50 border-b border-stone-200 no-print">
        <div class="max-w-7xl mx-auto">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
               <button @click="showAdminMenu = !showAdminMenu" class="md:hidden w-10 h-10 bg-stone-100 rounded-xl flex items-center justify-center text-stone-600 hover:bg-stone-200 active:scale-95 transition">
                 <i class="fas fa-bars"></i>
               </button>
               <h1 class="font-black text-base md:text-lg text-stone-900 flex items-center gap-2 whitespace-nowrap">
                 <span class="w-8 h-8 bg-gradient-to-br from-brand-600 to-brand-500 text-white rounded-xl flex items-center justify-center text-base shadow-lg shadow-brand-500/30"><i class="fas fa-chart-pie"></i></span>
                 <span class="hidden sm:inline">管理後台</span>
               </h1>
            </div>
            
            <!-- 桌面版導航 -->
            <div class="hidden md:flex items-center gap-1">
               <button v-if="user && user.role === 'admin'" @click="adminTab='accounts'; fetchAdminAccounts()" :class="['px-3 py-2 rounded-xl text-xs font-bold transition-all whitespace-nowrap border', adminTab=='accounts'?'bg-stone-800 text-white border-stone-800 shadow-md':'bg-white text-stone-500 border-stone-200 hover:bg-stone-50']">
                 <i class="fas fa-users mr-1"></i>帳號管理
               </button>
               <button @click="adminTab='items'; fetchAdminItems()" :class="['px-3 py-2 rounded-xl text-xs font-bold transition-all whitespace-nowrap border', adminTab=='items'?'bg-stone-800 text-white border-stone-800 shadow-md':'bg-white text-stone-500 border-stone-200 hover:bg-stone-50']">
                 <i class="fas fa-box mr-1"></i>產品管理
               </button>
               <button @click="adminTab='review'; fetchReviewList()" :class="['px-3 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-1 whitespace-nowrap border', adminTab=='review'?'bg-red-500 text-white border-red-500 shadow-md shadow-red-500/30':'bg-white text-stone-500 border-stone-200 hover:bg-stone-50']">
                 <i class="fas fa-clock"></i>待審核 <span v-if="adminData.reviewList.length > 0" class="bg-white text-red-500 text-[10px] px-1.5 rounded-md font-black shadow-sm">{{ adminData.reviewList.length }}</span>
               </button>
               <button @click="adminTab='details'; fetchOrderDetails()" :class="['px-3 py-2 rounded-xl text-xs font-bold transition-all whitespace-nowrap border', adminTab=='details'?'bg-stone-800 text-white border-stone-800 shadow-md':'bg-white text-stone-500 border-stone-200 hover:bg-stone-50']">
                 <i class="fas fa-file-alt mr-1"></i>訂單管理
               </button>
               <button @click="adminTab='stock'" :class="['px-3 py-2 rounded-xl text-xs font-bold transition-all whitespace-nowrap border', adminTab=='stock'?'bg-stone-800 text-white border-stone-800 shadow-md':'bg-white text-stone-500 border-stone-200 hover:bg-stone-50']">
                 <i class="fas fa-chart-bar mr-1"></i>備貨單
               </button>
               <button @click="adminTab='labels'" :class="['px-3 py-2 rounded-xl text-xs font-bold transition-all whitespace-nowrap border', adminTab=='labels'?'bg-stone-800 text-white border-stone-800 shadow-md':'bg-white text-stone-500 border-stone-200 hover:bg-stone-50']">
                 <i class="fas fa-print mr-1"></i>出貨單
               </button>
               <div class="w-px h-6 bg-stone-300 mx-1"></div>
               <button @click="logout" class="bg-stone-100 text-stone-500 px-3 py-2 rounded-xl text-xs font-bold hover:bg-stone-200">
                 <i class="fas fa-sign-out-alt"></i>
               </button>
            </div>
            
            <!-- 手機版右側按鈕 -->
            <div class="flex md:hidden items-center gap-2">
               <button v-if="adminData.reviewList.length > 0" @click="adminTab = adminTab === 'review' ? 'details' : 'review'; adminTab === 'review' ? fetchReviewList() : fetchOrderDetails(); showAdminMenu=false" class="relative w-10 h-10 bg-red-50 text-red-500 rounded-xl flex items-center justify-center hover:bg-red-100 active:scale-95 transition border border-red-200">
                 <i class="fas fa-bell"></i>
                 <span class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center font-black">{{ adminData.reviewList.length }}</span>
               </button>
               <button @click="logout" class="w-10 h-10 bg-stone-100 text-stone-500 rounded-xl flex items-center justify-center hover:bg-stone-200 active:scale-95 transition">
                 <i class="fas fa-sign-out-alt"></i>
               </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 手機版側邊選單 -->
      <transition name="mobile-menu">
        <div v-if="showAdminMenu" @click="showAdminMenu = false" class="md:hidden fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-40 no-print">
          <div @click.stop class="bg-white w-72 h-full shadow-2xl p-6 overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
              <h2 class="font-black text-xl text-stone-800">功能選單</h2>
              <button @click="showAdminMenu = false" class="w-8 h-8 bg-stone-100 rounded-lg flex items-center justify-center text-stone-600 hover:bg-stone-200">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="space-y-2">
              <button v-if="user && user.role === 'admin'" @click="adminTab='accounts'; fetchAdminAccounts(); showAdminMenu=false" :class="['w-full text-left px-4 py-3 rounded-xl font-bold transition-all flex items-center gap-3', adminTab=='accounts'?'bg-stone-800 text-white':'text-stone-600 hover:bg-stone-50']">
                <i class="fas fa-users w-5"></i><span>帳號管理</span>
              </button>
              <button @click="adminTab='items'; fetchAdminItems(); showAdminMenu=false" :class="['w-full text-left px-4 py-3 rounded-xl font-bold transition-all flex items-center gap-3', adminTab=='items'?'bg-stone-800 text-white':'text-stone-600 hover:bg-stone-50']">
                <i class="fas fa-box w-5"></i><span>產品管理</span>
              </button>
              <button @click="adminTab='review'; fetchReviewList(); showAdminMenu=false" :class="['w-full text-left px-4 py-3 rounded-xl font-bold transition-all flex items-center gap-3', adminTab=='review'?'bg-red-500 text-white':'text-stone-600 hover:bg-stone-50']">
                <i class="fas fa-clock w-5"></i><span>待審核 <span v-if="adminData.reviewList.length>0" class="text-xs">({{adminData.reviewList.length}})</span></span>
              </button>
              <button @click="adminTab='details'; fetchOrderDetails(); showAdminMenu=false" :class="['w-full text-left px-4 py-3 rounded-xl font-bold transition-all flex items-center gap-3', adminTab=='details'?'bg-stone-800 text-white':'text-stone-600 hover:bg-stone-50']">
                <i class="fas fa-file-alt w-5"></i><span>訂單管理</span>
              </button>
              <button @click="adminTab='stock'; showAdminMenu=false" :class="['w-full text-left px-4 py-3 rounded-xl font-bold transition-all flex items-center gap-3', adminTab=='stock'?'bg-stone-800 text-white':'text-stone-600 hover:bg-stone-50']">
                <i class="fas fa-chart-bar w-5"></i><span>備貨統計</span>
              </button>
              <button @click="adminTab='labels'; showAdminMenu=false" :class="['w-full text-left px-4 py-3 rounded-xl font-bold transition-all flex items-center gap-3', adminTab=='labels'?'bg-stone-800 text-white':'text-stone-600 hover:bg-stone-50']">
                <i class="fas fa-print w-5"></i><span>出貨單</span>
              </button>
            </div>
          </div>
        </div>
      </transition>

      <!-- 主要內容區域 -->
      <div class="max-w-7xl mx-auto p-4 md:p-6">
        
        <!-- 帳號管理 -->
        <div v-if="adminTab === 'accounts'" class="space-y-4">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-black text-stone-800">帳號管理</h2>
            <button @click="openAddAccountModal" class="bg-brand-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-brand-700 transition shadow-lg flex items-center gap-2">
              <i class="fas fa-plus"></i>新增帳號
            </button>
          </div>
          
          <div v-if="loading" class="text-center py-20"><i class="fas fa-circle-notch fa-spin text-3xl text-stone-300"></i></div>
          
          <div v-else-if="adminData.accountsList.length === 0" class="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-stone-200">
            <i class="fas fa-users text-6xl mb-4 text-stone-300"></i>
            <p class="font-bold text-stone-400">目前沒有帳號資料</p>
          </div>
          
          <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div v-for="account in adminData.accountsList" :key="account.id" class="bg-white rounded-2xl p-6 shadow-sm border border-stone-100 hover:shadow-md transition">
              <div class="flex justify-between items-start mb-4">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 bg-gradient-to-br from-brand-500 to-brand-600 rounded-xl flex items-center justify-center text-white font-black text-lg">
                    {{ account.name ? account.name.charAt(0).toUpperCase() : account.accountId.charAt(0) }}
                  </div>
                  <div>
                    <h3 class="font-black text-stone-800">{{ account.name || account.accountId }}</h3>
                    <p class="text-xs text-stone-500">{{ account.accountId }}</p>
                  </div>
                </div>
                <span :class="['text-xs font-bold px-2 py-1 rounded-lg', account.role === 'admin' ? 'bg-brand-100 text-brand-700' : 'bg-stone-100 text-stone-500']">
                  {{ account.role === 'admin' ? '管理者' : '一般使用者' }}
                </span>
              </div>
              
              <div class="space-y-2 mb-4 text-sm">
                <div v-if="account.email" class="flex items-center gap-2 text-stone-600">
                  <i class="fas fa-envelope w-4"></i>
                  <span>{{ account.email }}</span>
                </div>
                <div v-if="account.phone" class="flex items-center gap-2 text-stone-600">
                  <i class="fas fa-phone w-4"></i>
                  <span>{{ account.phone }}</span>
                </div>
              </div>
              
              <div class="flex gap-2 pt-4 border-t border-stone-100">
                <button @click="editAccount(account)" class="flex-1 bg-blue-50 text-blue-600 py-2 rounded-xl font-bold hover:bg-blue-100 transition text-sm">
                  <i class="fas fa-edit mr-1"></i>編輯
                </button>
                <button @click="deleteAccount(account)" class="flex-1 bg-red-50 text-red-600 py-2 rounded-xl font-bold hover:bg-red-100 transition text-sm">
                  <i class="fas fa-trash mr-1"></i>刪除
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- 產品管理 -->
        <div v-if="adminTab === 'items'" class="space-y-4">
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-4">
              <h2 class="text-2xl font-black text-stone-800">產品管理</h2>
              <select v-model="itemsSort" @change="fetchAdminItems" class="w-full sm:w-auto px-4 py-2 bg-white border-2 border-stone-200 rounded-xl font-bold text-stone-700 text-sm hover:border-brand-500 transition">
                <option value="createdAt-asc">建立時間 (舊→新)</option>
                <option value="createdAt-desc">建立時間 (新→舊)</option>
                <option value="name-asc">名稱 (A→Z)</option>
                <option value="name-desc">名稱 (Z→A)</option>
                <option value="price-asc">價格 (低→高)</option>
                <option value="price-desc">價格 (高→低)</option>
              </select>
            </div>
            <button @click="openAddItemModal" class="bg-brand-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-brand-700 transition shadow-lg flex items-center justify-center gap-2">
              <i class="fas fa-plus"></i><span>新增產品</span>
            </button>
          </div>
          
          <div v-if="loading" class="text-center py-20"><i class="fas fa-circle-notch fa-spin text-3xl text-stone-300"></i></div>
          
          <div v-else-if="adminData.itemsList.length === 0" class="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-stone-200">
            <i class="fas fa-box text-6xl mb-4 text-stone-300"></i>
            <p class="font-bold text-stone-400">目前沒有產品資料</p>
          </div>
          
          <div v-else class="space-y-3">
            <div v-for="item in adminData.itemsList" :key="item.id" class="bg-white rounded-xl p-4 shadow-sm border border-stone-100 hover:shadow-md transition">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div class="flex-1 min-w-0">
                  <div class="flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-3 mb-1">
                    <h3 class="font-black text-stone-800 text-base">{{ item.name }}</h3>
                    <p class="text-lg font-black text-brand-600">NT$ {{ item.price }}</p>
                  </div>
                  <p v-if="item.description" class="text-sm text-stone-500 line-clamp-2">{{ item.description }}</p>
                </div>
                
                <div class="flex gap-2 sm:flex-shrink-0">
                  <button @click="editItem(item)" class="flex-1 sm:flex-none px-4 py-2 bg-blue-50 text-blue-600 rounded-lg font-bold hover:bg-blue-100 transition text-sm">
                    <i class="fas fa-edit mr-1"></i>編輯
                  </button>
                  <button @click="deleteItem(item)" class="flex-1 sm:flex-none px-4 py-2 bg-red-50 text-red-600 rounded-lg font-bold hover:bg-red-100 transition text-sm">
                    <i class="fas fa-trash mr-1"></i>刪除
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 待審核 -->
        <div v-if="adminTab === 'review'" class="space-y-4">
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-6">
            <h2 class="text-2xl font-black text-stone-800">待審核訂單</h2>
            <select v-model="reviewSort" class="w-full sm:w-auto px-4 py-2 bg-white border-2 border-stone-200 rounded-xl font-bold text-stone-700 text-sm hover:border-brand-500 transition">
              <option value="createdAt-desc">建立時間 (新→舊)</option>
              <option value="createdAt-asc">建立時間 (舊→新)</option>
              <option value="deliveryTime-desc">配送時間 (新→舊)</option>
              <option value="deliveryTime-asc">配送時間 (舊→新)</option>
              <option value="companyName-asc">公司名稱 (A→Z)</option>
              <option value="companyName-desc">公司名稱 (Z→A)</option>
            </select>
          </div>
          <div v-if="loading" class="text-center py-20"><i class="fas fa-circle-notch fa-spin text-3xl text-stone-300"></i></div>
          <div v-else-if="adminData.reviewList.length === 0" class="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-stone-200">
            <i class="fas fa-check-circle text-6xl mb-4 text-stone-300"></i>
            <p class="font-bold text-stone-400">目前沒有待審核的團購</p>
          </div>
          <div v-else class="space-y-4">
            <div v-for="g in sortedReviewList" :key="g.id" class="bg-white rounded-2xl p-6 shadow-sm border border-stone-100 hover:shadow-md transition">
              <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 mb-4">
                <div class="flex-1">
                  <h3 class="text-xl font-black text-stone-800 mb-2">{{ g.companyName }}</h3>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-stone-600">
                    <div class="flex items-center gap-2">
                      <i class="fas fa-user w-4 text-stone-400"></i>
                      <span>聯絡人：{{ g.contactName }}</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <i class="fas fa-phone w-4 text-stone-400"></i>
                      <span>電話：{{ g.contactPhone }}</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <i class="fas fa-truck w-4 text-stone-400"></i>
                      <span>配送時間：{{ g.deliveryTime ? new Date(g.deliveryTime.seconds * 1000).toLocaleString('zh-TW') : '-' }}</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <i class="fas fa-calendar-plus w-4 text-stone-400"></i>
                      <span>建立時間：{{ g.createdAt ? new Date(g.createdAt.seconds * 1000).toLocaleString('zh-TW') : '-' }}</span>
                    </div>
                  </div>
                  <p v-if="g.address" class="text-sm text-stone-500 mt-3"><i class="fas fa-map-marker-alt mr-2"></i>{{ g.address }}</p>
                  <!-- 顯示總金額 -->
                  <div v-if="groupTotalAmountMap[g.id] > 0" class="mt-3 text-lg font-bold text-blue-600">
                    <i class="fas fa-dollar-sign mr-1"></i>總金額：${{ groupTotalAmountMap[g.id].toLocaleString() }}
                  </div>
                </div>
                <span class="bg-amber-100 text-amber-700 px-3 py-1.5 rounded-full text-xs font-bold inline-block sm:flex-shrink-0">待審核</span>
              </div>
              
              <div class="flex flex-row gap-1 mt-4 pt-4 border-t border-stone-100">
                <button @click="toggleOrders(g.id)" class="flex-1 bg-blue-500 text-white py-2.5 rounded-xl font-bold hover:bg-blue-600 transition flex flex-col sm:flex-row items-center justify-center gap-1 text-xs sm:text-base">
                  <i class="fas fa-receipt"></i>
                  <span class="hidden sm:inline">訂單明細</span>
                  <span class="sm:hidden">訂單</span>
                </button>
                <button @click="toggleStock(g.id)" class="flex-1 bg-amber-500 text-white py-2.5 rounded-xl font-bold hover:bg-amber-600 transition flex flex-col sm:flex-row items-center justify-center gap-1 text-xs sm:text-base">
                  <i class="fas fa-boxes"></i>
                  <span class="hidden sm:inline">備貨統計</span>
                  <span class="sm:hidden">備貨</span>
                </button>
                <button @click="confirmGroup(g)" class="flex-1 bg-green-500 text-white py-2.5 rounded-xl font-bold hover:bg-green-600 transition flex flex-col sm:flex-row items-center justify-center gap-1 text-xs sm:text-base">
                  <i class="fas fa-check"></i>
                  <span class="hidden sm:inline">確認接單</span>
                  <span class="sm:hidden">接單</span>
                </button>
                <button @click="rejectGroup(g)" class="flex-1 bg-red-500 text-white py-2.5 rounded-xl font-bold hover:bg-red-600 transition flex flex-col sm:flex-row items-center justify-center gap-1 text-xs sm:text-base">
                  <i class="fas fa-times"></i>
                  <span class="hidden sm:inline">拒絕接單</span>
                  <span class="sm:hidden">拒絕</span>
                </button>
              </div>
              
              <!-- 展開備貨統計 -->
              <div v-if="expandedStockGroupId === g.id" class="mt-4 pt-4 border-t-2 border-amber-200 bg-amber-50/30">
                <div v-if="loadingGroupOrders" class="text-center py-8">
                  <i class="fas fa-circle-notch fa-spin text-2xl text-stone-300"></i>
                </div>
                <div v-else>
                  <!-- 備貨統計 -->
                  <div>
                    <h4 class="text-lg font-bold text-stone-800 mb-3 flex items-center gap-2">
                      <i class="fas fa-boxes text-amber-600"></i>備貨統計
                    </h4>
                    <div v-if="groupStock.length === 0" class="text-sm text-stone-400 text-center py-4 bg-stone-50 rounded-xl">
                      暫無商品數據
                    </div>
                    <div v-else class="space-y-0 divide-y divide-stone-100">
                      <div v-for="stock in groupStock" :key="stock.name" class="py-3 flex items-center justify-between">
                        <span class="text-stone-700">{{ stock.name }}</span>
                        <span class="text-stone-900 font-semibold tabular-nums">{{ stock.quantity }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 展開訂單明細 -->
              <div v-if="expandedOrdersGroupId === g.id" class="mt-4 pt-4 border-t-2 border-blue-200 bg-blue-50/30">
                <div v-if="loadingGroupOrders" class="text-center py-8">
                  <i class="fas fa-circle-notch fa-spin text-2xl text-stone-300"></i>
                </div>
                <div v-else>
                  <!-- 訂單列表 -->
                  <div>
                    <h4 class="text-lg font-bold text-stone-800 flex items-center gap-2 mb-3">
                      <i class="fas fa-receipt text-blue-600"></i>訂單明細 <span class="text-sm font-normal text-stone-500">(共 {{ groupOrders.length }} 筆)</span>
                    </h4>
                    <div v-if="groupOrders.length === 0" class="text-sm text-stone-400 text-center py-4 bg-stone-50 rounded-xl">
                      暫無訂單數據
                    </div>
                    <div v-else class="space-y-2 max-h-96 overflow-y-auto">
                      <div v-for="order in groupOrders" :key="order.id" class="bg-stone-50 rounded-lg p-4 border border-stone-200">
                        <div class="flex flex-wrap items-start justify-between gap-2 mb-2">
                          <div class="flex items-center gap-2">
                            <i class="fas fa-user-circle text-stone-400"></i>
                            <span class="font-bold text-stone-800">{{ order.customerName || '未知' }}</span>
                            <span v-if="order.customerUnit" class="text-xs text-stone-500 bg-stone-100 px-2 py-0.5 rounded">{{ order.customerUnit }}</span>
                          </div>
                          <div class="text-sm font-bold text-blue-600">${{ (order.totalAmount || 0).toLocaleString() }}</div>
                        </div>
                        <div v-if="order.items && order.items.length > 0" class="space-y-1">
                          <div v-for="(item, idx) in order.items" :key="idx" class="flex justify-between items-center text-sm py-1.5 px-2 bg-white rounded border border-stone-100">
                            <span class="text-stone-700">{{ item.itemName }}</span>
                            <span class="font-bold text-stone-800">x{{ item.qty }}</span>
                          </div>
                        </div>
                        <div v-else class="text-xs text-stone-400 italic">無商品項目</div>
                        <div v-if="order.note" class="mt-2 text-xs text-stone-500 bg-amber-50 p-2 rounded border-l-2 border-amber-300">
                          <i class="fas fa-comment-dots mr-1"></i>{{ order.note }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 訂單詳情 -->
        <div v-if="adminTab === 'details'" class="space-y-4">
          <h2 class="text-2xl font-black text-stone-800 mb-6">訂單管理</h2>
          <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-100 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
              <div class="flex-1">
                <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">起始日期</label>
                <input type="date" v-model="detailsStart" class="w-full px-4 py-2 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none">
              </div>
              <div class="flex-1">
                <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">結束日期</label>
                <input type="date" v-model="detailsEnd" class="w-full px-4 py-2 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none">
              </div>
              <div class="flex-1">
                <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">訂單狀態</label>
                <select v-model="detailsStatus" class="w-full px-4 py-2 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none font-bold text-stone-700 bg-white">
                  <option value="all">全部狀態</option>
                  <option value="pending">待審核</option>
                  <option value="approved">已接單</option>
                  <option value="rejected">已拒絕</option>
                </select>
              </div>
              <div class="flex-1">
                <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">排序方式</label>
                <select v-model="detailsSort" class="w-full px-4 py-2 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none font-bold text-stone-700 bg-white">
                  <option value="deliveryTime-desc">配送時間 (新→舊)</option>
                  <option value="deliveryTime-asc">配送時間 (舊→新)</option>
                  <option value="createdAt-desc">建立時間 (新→舊)</option>
                  <option value="createdAt-asc">建立時間 (舊→新)</option>
                  <option value="companyName-asc">公司名稱 (A→Z)</option>
                  <option value="companyName-desc">公司名稱 (Z→A)</option>
                </select>
              </div>
            </div>
          </div>
          <div v-if="loading" class="text-center py-20"><i class="fas fa-circle-notch fa-spin text-3xl text-stone-300"></i></div>
          <div v-else-if="adminData.detailsList.length === 0" class="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-stone-200">
            <i class="fas fa-inbox text-6xl mb-4 text-stone-300"></i>
            <p class="font-bold text-stone-400">此日期範圍內沒有訂單</p>
          </div>
          <div v-else class="space-y-4">
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-stone-100 mb-4">
              <p class="font-bold text-stone-600">共找到 {{ adminData.detailsList.length }} 筆訂單</p>
            </div>
            <div v-for="order in sortedDetailsList" :key="order.id" class="bg-white rounded-2xl p-6 shadow-sm border border-stone-100 transition" :class="editingOrderId === order.id ? 'ring-2 ring-blue-400' : 'hover:shadow-md'">
              <!-- 查看模式 -->
              <div v-if="editingOrderId !== order.id">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 mb-4">
                  <div class="flex-1">
                    <!-- 狀態徽章（在公司名稱上方） -->
                    <span :class="['inline-block px-3 py-1.5 rounded-full text-xs font-bold mb-2', order.status === 'approved' ? 'bg-green-100 text-green-700' : order.status === 'rejected' ? 'bg-red-100 text-red-700' : 'bg-amber-100 text-amber-700']">
                      {{ order.status === 'approved' ? '已接單' : order.status === 'rejected' ? '已拒絕' : '待審核' }}
                    </span>
                    <h3 class="text-xl font-black text-stone-800 mb-2">{{ order.companyName }}</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-stone-600">
                      <div class="flex items-center gap-2">
                        <i class="fas fa-user w-4 text-stone-400"></i>
                        <span>聯絡人：{{ order.contactName }}</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <i class="fas fa-phone w-4 text-stone-400"></i>
                        <span>電話：{{ order.contactPhone }}</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <i class="fas fa-truck w-4 text-stone-400"></i>
                        <span>配送時間：{{ order.deliveryTime ? new Date(order.deliveryTime.seconds * 1000).toLocaleString('zh-TW') : '-' }}</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <i class="fas fa-calendar-plus w-4 text-stone-400"></i>
                        <span>建立時間：{{ order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleString('zh-TW') : '-' }}</span>
                      </div>
                    </div>
                    <p v-if="order.address" class="text-sm text-stone-500 mt-3"><i class="fas fa-map-marker-alt mr-2"></i>{{ order.address }}</p>
                    <!-- 顯示總金額 -->
                    <div v-if="groupTotalAmountMap[order.id] > 0" class="mt-3 text-lg font-bold text-blue-600">
                      <i class="fas fa-dollar-sign mr-1"></i>總金額：${{ groupTotalAmountMap[order.id].toLocaleString() }}
                    </div>
                  </div>
                  <div class="flex flex-col items-stretch sm:items-center gap-2">
                    <button @click="startEditOrder(order)" class="px-4 py-2 bg-yellow-100 text-yellow-700 rounded-xl hover:bg-yellow-200 transition text-sm font-bold whitespace-nowrap">
                      <i class="fas fa-edit mr-1"></i>編輯
                    </button>
                  </div>
                </div>
                
                <!-- 操作按鈕 -->
                <div class="flex flex-col sm:flex-row gap-2 mt-4">
                  <button @click="toggleOrders(order.id)" class="flex-1 bg-blue-500 text-white py-2 rounded-xl font-bold hover:bg-blue-600 transition flex items-center justify-center gap-2 text-sm">
                    <i class="fas fa-receipt"></i>
                    <span>訂單明細</span>
                  </button>
                  <button @click="toggleStock(order.id)" class="flex-1 bg-amber-500 text-white py-2 rounded-xl font-bold hover:bg-amber-600 transition flex items-center justify-center gap-2 text-sm">
                    <i class="fas fa-boxes"></i>
                    <span>備貨統計</span>
                  </button>
                </div>
                
                <!-- 展開備貨統計 -->
                <div v-if="expandedStockGroupId === order.id" class="mt-4 pt-4 border-t-2 border-amber-200 bg-amber-50/30 rounded-xl p-4">
                  <div v-if="loadingGroupOrders" class="text-center py-8">
                    <i class="fas fa-circle-notch fa-spin text-2xl text-amber-400"></i>
                  </div>
                  <div v-else>
                    <h4 class="text-lg font-bold text-stone-800 mb-3 flex items-center gap-2">
                      <i class="fas fa-boxes text-amber-600"></i>備貨統計
                    </h4>
                    <div v-if="groupStock.length === 0" class="text-sm text-stone-400 text-center py-4 bg-white rounded-xl">
                      暫無商品數據
                    </div>
                    <div v-else class="bg-white rounded-xl overflow-hidden">
                      <div v-for="stock in groupStock" :key="stock.name" class="py-3 px-4 flex items-center justify-between border-b border-stone-100 last:border-b-0 hover:bg-stone-50 transition">
                        <span class="text-stone-700 font-medium">{{ stock.name }}</span>
                        <span class="text-stone-900 font-bold tabular-nums">{{ stock.quantity }}</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- 展開訂單明細 -->
                <div v-if="expandedOrdersGroupId === order.id" class="mt-4 pt-4 border-t-2 border-blue-200 bg-blue-50/30 rounded-xl p-4">
                  <div v-if="loadingGroupOrders" class="text-center py-8">
                    <i class="fas fa-circle-notch fa-spin text-2xl text-blue-400"></i>
                  </div>
                  <div v-else>
                    <h4 class="text-lg font-bold text-stone-800 flex items-center gap-2 mb-3">
                      <i class="fas fa-receipt text-blue-600"></i>訂單明細 <span class="text-sm font-normal text-stone-500">(共 {{ groupOrders.length }} 筆)</span>
                    </h4>
                    <div v-if="groupOrders.length === 0" class="text-sm text-stone-400 text-center py-4 bg-white rounded-xl">
                      暫無訂單數據
                    </div>
                    <div v-else class="space-y-2 max-h-96 overflow-y-auto">
                      <div v-for="customerOrder in groupOrders" :key="customerOrder.id" class="bg-white p-4 rounded-xl shadow-sm border border-blue-100">
                        <div class="flex items-center justify-between mb-2">
                          <div class="flex items-center gap-2">
                            <span class="font-bold text-stone-800">{{ customerOrder.customerName }}</span>
                            <span v-if="customerOrder.customerUnit" class="text-xs text-stone-500 bg-stone-100 px-2 py-0.5 rounded">{{ customerOrder.customerUnit }}</span>
                          </div>
                          <span class="text-sm font-bold text-blue-600">${{ (customerOrder.totalAmount || 0).toLocaleString() }}</span>
                        </div>
                        <div class="space-y-1">
                          <div v-for="(item, idx) in customerOrder.items" :key="idx" class="flex justify-between text-sm">
                            <span class="text-stone-600">{{ item.itemName }}</span>
                            <span class="text-stone-900 font-semibold tabular-nums">x{{ item.qty }}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 編輯模式 -->
              <div v-else>
                <div class="space-y-4">
                  <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-black text-blue-600"><i class="fas fa-edit mr-2"></i>編輯訂單</h3>
                    <div class="flex gap-2">
                      <button @click="saveEditOrder" class="px-4 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition text-sm font-bold">
                        <i class="fas fa-save mr-1"></i>保存
                      </button>
                      <button @click="cancelEditOrder" class="px-4 py-2 bg-gray-400 text-white rounded-xl hover:bg-gray-500 transition text-sm font-bold">
                        <i class="fas fa-times mr-1"></i>取消
                      </button>
                    </div>
                  </div>
                  
                  <!-- 基本資訊編輯 -->
                  <div class="bg-stone-50 p-4 rounded-xl space-y-3">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                      <div>
                        <label class="text-xs font-bold text-stone-500 mb-1 block">公司名稱</label>
                        <input v-model="editFormData.companyName" type="text" class="w-full px-3 py-2 border-2 border-stone-200 rounded-lg focus:border-blue-400 outline-none">
                      </div>
                      <div>
                        <label class="text-xs font-bold text-stone-500 mb-1 block">聯絡人</label>
                        <input v-model="editFormData.contactName" type="text" class="w-full px-3 py-2 border-2 border-stone-200 rounded-lg focus:border-blue-400 outline-none">
                      </div>
                      <div>
                        <label class="text-xs font-bold text-stone-500 mb-1 block">聯絡電話</label>
                        <input v-model="editFormData.contactPhone" type="text" class="w-full px-3 py-2 border-2 border-stone-200 rounded-lg focus:border-blue-400 outline-none">
                      </div>
                      <div>
                        <label class="text-xs font-bold text-stone-500 mb-1 block">配送時間</label>
                        <input v-model="editFormData.deliveryTime" type="datetime-local" class="w-full px-3 py-2 border-2 border-stone-200 rounded-lg focus:border-blue-400 outline-none">
                      </div>
                    </div>
                    <div>
                      <label class="text-xs font-bold text-stone-500 mb-1 block">配送地址</label>
                      <input v-model="editFormData.address" type="text" class="w-full px-3 py-2 border-2 border-stone-200 rounded-lg focus:border-blue-400 outline-none">
                    </div>
                    <div>
                      <label class="text-xs font-bold text-stone-500 mb-1 block">狀態</label>
                      <select v-model="editFormData.status" class="w-full px-3 py-2 border-2 border-stone-200 rounded-lg focus:border-blue-400 outline-none">
                        <option value="pending">待審核</option>
                        <option value="approved">已接單</option>
                        <option value="rejected">已拒絕</option>
                      </select>
                    </div>
                  </div>
                  
                  <!-- 訂單明細編輯 -->
                  <div class="bg-blue-50 p-4 rounded-xl">
                    <div class="flex justify-between items-center mb-3">
                      <h4 class="font-bold text-blue-800"><i class="fas fa-list mr-2"></i>訂單明細</h4>
                      <button @click="addNewOrder" class="px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-xs font-bold">
                        <i class="fas fa-plus mr-1"></i>新增訂單
                      </button>
                    </div>
                    <div v-if="loadingGroupOrders" class="text-center py-4"><i class="fas fa-circle-notch fa-spin text-blue-400"></i></div>
                    <div v-else-if="editOrdersList.length === 0" class="text-center py-4 text-stone-400 text-sm">尚無訂單</div>
                    <div v-else class="space-y-3">
                      <div v-for="(orderItem, idx) in editOrdersList" :key="orderItem.id || idx" class="bg-white p-3 rounded-lg border-2 border-blue-200">
                        <div class="flex justify-between items-start mb-2">
                          <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-2">
                            <div>
                              <label class="text-xs font-bold text-stone-500 mb-1 block">訂購人</label>
                              <input v-model="orderItem.customerName" type="text" class="w-full px-3 py-1.5 border border-stone-300 rounded focus:border-blue-400 outline-none text-sm">
                            </div>
                            <div>
                              <label class="text-xs font-bold text-stone-500 mb-1 block">單位</label>
                              <input v-model="orderItem.customerUnit" type="text" placeholder="例：部門、公司" class="w-full px-3 py-1.5 border border-stone-300 rounded focus:border-blue-400 outline-none text-sm">
                            </div>
                          </div>
                          <button @click="removeOrder(idx)" class="ml-2 text-red-500 hover:text-red-700 transition">
                            <i class="fas fa-trash-alt"></i>
                          </button>
                        </div>
                        <div class="space-y-2">
                          <div class="flex justify-between items-center">
                            <label class="text-xs font-bold text-stone-500">訂購項目</label>
                            <button @click="addOrderItem(idx)" class="text-xs text-blue-500 hover:text-blue-700 font-bold">
                              <i class="fas fa-plus mr-1"></i>新增項目
                            </button>
                          </div>
                          <div v-for="(item, itemIdx) in orderItem.items" :key="itemIdx" class="flex gap-2 items-center">
                            <select v-model="item.itemName" class="flex-1 px-2 py-1 border border-stone-300 rounded text-sm focus:border-blue-400 outline-none">
                              <option value="" disabled>請選擇品項</option>
                              <option 
                                v-for="product in adminData.itemsList" 
                                :key="product.id" 
                                :value="product.name"
                                :disabled="isItemSelected(idx, itemIdx, product.name)"
                                :class="isItemSelected(idx, itemIdx, product.name) ? 'text-gray-400' : ''"
                              >
                                {{ product.name }}{{ isItemSelected(idx, itemIdx, product.name) ? ' (已選擇)' : '' }}
                              </option>
                            </select>
                            <input v-model.number="item.qty" type="number" placeholder="數量" min="1" class="w-20 px-2 py-1 border border-stone-300 rounded text-sm focus:border-blue-400 outline-none">
                            <button @click="removeOrderItem(idx, itemIdx)" class="text-red-500 hover:text-red-700 text-sm">
                              <i class="fas fa-times"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 備貨統計 -->
        <div v-if="adminTab === 'stock'" class="space-y-4">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-black text-stone-800">備貨統計</h2>
            <button v-if="adminData.stockList.length > 0" @click="printStockLabels" class="no-print bg-green-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-green-700 transition shadow-lg flex items-center gap-2">
              <i class="fas fa-print"></i>列印備貨單
            </button>
          </div>
          <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-100 mb-6">
            <div class="flex flex-col gap-4">
              <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-1">
                  <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">起始日期</label>
                  <input type="date" v-model="stockStart" class="w-full px-4 py-2 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none">
                </div>
                <div class="flex-1">
                  <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">結束日期</label>
                  <input type="date" v-model="stockEnd" class="w-full px-4 py-2 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none">
                </div>
                <div class="flex-1">
                  <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">訂單狀態</label>
                  <select v-model="stockStatus" class="w-full px-4 py-2 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none bg-white">
                    <option value="all">全部</option>
                    <option value="pending">待審核</option>
                    <option value="approved">已接單</option>
                    <option value="rejected">已拒絕</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div v-if="loading" class="text-center py-20"><i class="fas fa-circle-notch fa-spin text-3xl text-stone-300"></i></div>
          <div v-else-if="adminData.stockList.length === 0" class="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-stone-200">
            <i class="fas fa-box-open text-6xl mb-4 text-stone-300"></i>
            <p class="font-bold text-stone-400">此日期範圍內沒有備貨資料</p>
          </div>
          <div v-else class="space-y-3">
            <div class="flex justify-between items-center px-2">
              <h3 class="font-bold text-stone-500 text-sm">備貨清單</h3>
              <span class="text-sm text-stone-400">共 {{ adminData.stockList.length }} 項產品</span>
            </div>

            <div v-for="item in adminData.stockList" :key="item.name" class="bg-white rounded-xl px-5 py-4 shadow-sm border border-stone-100 hover:shadow-md transition flex justify-between items-center">
              <span class="font-black text-stone-800">{{ item.name }}</span>
              <span class="text-lg font-black text-brand-600 tabular-nums">× {{ item.qty }}</span>
            </div>
          </div>
        </div>

        <!-- 出貨單 -->
        <div v-if="adminTab === 'labels'" class="space-y-4">
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6">
            <h2 class="text-2xl font-black text-stone-800">出貨單</h2>
            <div class="flex flex-wrap items-center gap-3">
              <div class="flex items-center gap-2">
                <label class="text-xs font-bold text-stone-400 whitespace-nowrap">起始</label>
                <input type="date" v-model="labelStart" class="px-3 py-2 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none font-bold text-stone-700">
              </div>
              <div class="flex items-center gap-2">
                <label class="text-xs font-bold text-stone-400 whitespace-nowrap">結束</label>
                <input type="date" v-model="labelEnd" class="px-3 py-2 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none font-bold text-stone-700">
              </div>
              <button v-if="labelSelectedIds.length > 0" @click="printLabels" class="bg-green-600 text-white px-5 py-2 rounded-xl font-bold hover:bg-green-700 transition flex items-center gap-2 whitespace-nowrap shadow-lg">
                <i class="fas fa-print"></i>列印 ({{ labelSelectedIds.length }} 張)
              </button>
            </div>
          </div>

          <div v-if="loading" class="text-center py-20"><i class="fas fa-circle-notch fa-spin text-3xl text-stone-300"></i></div>
          <div v-else-if="labelGroupsWithOrders.length === 0" class="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-stone-200">
            <i class="fas fa-file-invoice text-6xl mb-4 text-stone-300"></i>
            <p class="font-bold text-stone-400">該日期沒有已接單的訂單</p>
          </div>
          <div v-else class="space-y-3">
            <!-- 全選 bar -->
            <div class="bg-white rounded-2xl px-5 py-3 shadow-sm border border-stone-100 flex items-center justify-between">
              <label class="flex items-center gap-3 cursor-pointer select-none">
                <input type="checkbox" :checked="isAllLabelSelected" @change="toggleAllLabels" class="w-5 h-5 rounded accent-stone-800 cursor-pointer">
                <span class="font-bold text-stone-700">全選 / 全取消</span>
              </label>
              <span class="text-sm text-stone-500">{{ labelSelectedIds.length }} / {{ labelTotalOrderCount }} 張已勾選</span>
            </div>

            <!-- 每個 GroupOrder -->
            <div v-for="(group, gIdx) in labelGroupsWithOrders" :key="group.id"
              class="bg-white rounded-2xl shadow-sm border border-stone-200 overflow-hidden">
              <!-- Group 標題列 -->
              <div class="flex items-center gap-3 px-5 py-4 border-b border-stone-200 bg-stone-100">
                <input type="checkbox" :checked="isGroupAllSelected(group)" @change="toggleGroupLabels(group)" class="w-5 h-5 rounded accent-stone-800 cursor-pointer flex-shrink-0">
                <div class="flex-1 min-w-0">
                  <p class="font-black text-stone-800 truncate">{{ group.companyName }}</p>
                  <p class="text-xs text-stone-500 mt-0.5">
                    <i class="fas fa-truck mr-1"></i>{{ group.deliveryTime ? new Date(group.deliveryTime.seconds * 1000).toLocaleString('zh-TW') : '-' }}
                    <span class="ml-3"><i class="fas fa-user mr-1"></i>{{ group.contactName }} {{ group.contactPhone }}</span>
                  </p>
                </div>
                <span class="text-xs font-bold text-stone-500 flex-shrink-0 bg-stone-200 px-2 py-1 rounded-lg">{{ group.orders.length }} 人</span>
              </div>

              <!-- 個人訂單 -->
              <div v-for="order in group.orders" :key="order.id" class="flex items-start gap-3 px-5 py-3 border-b border-stone-50 last:border-b-0 hover:bg-stone-50/50 transition">
                <input type="checkbox" :checked="labelSelectedIds.includes(order.id)" @change="toggleLabel(order.id)" class="w-5 h-5 rounded accent-stone-800 cursor-pointer flex-shrink-0 mt-0.5">
                <div class="flex-1 min-w-0">
                  <p class="font-bold text-stone-800">
                    {{ order.customerName }}
                    <span v-if="order.customerUnit" class="text-xs font-normal text-stone-500 ml-1">({{ order.customerUnit }})</span>
                  </p>
                  <p class="text-xs text-stone-500 mt-0.5">
                    <span v-for="(item, i) in order.items" :key="i">
                      {{ item.itemName }} ×{{ item.qty }}<span v-if="i < order.items.length - 1">、</span>
                    </span>
                  </p>
                </div>
                <span class="text-sm font-black text-brand-600 flex-shrink-0">${{ order.totalAmount.toLocaleString() }}</span>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- 出貨單列印區 (平時隱藏，列印時顯示) -->
    <div id="label-print-area">
      <template v-for="orderId in labelSelectedIds" :key="orderId">
        <div v-for="info in getLabelInfo(orderId)" :key="info.orderId" class="label-ticket">
          <div class="label-header">
            <div class="label-company">{{ info.companyName }}</div>
            <div class="label-delivery">配送：{{ info.deliveryTimeStr }}</div>
          </div>
          <div style="margin-bottom:2mm">
            <div class="label-customer">
              {{ info.customerName }}<span v-if="info.customerUnit" style="font-size:8pt;font-weight:normal">　{{ info.customerUnit }}</span>
            </div>
          </div>
          <div class="label-items">
            <div v-for="(item, i) in info.items" :key="i" class="label-item-row">
              <span class="label-item-name">{{ item.itemName }}</span>
              <span class="label-item-right">×{{ item.qty }}　${{ item.subtotal }}</span>
            </div>
          </div>
          <div class="label-footer">
            <div class="label-total">合計 ${{ info.totalAmount }}</div>
            <div v-if="info.note" class="label-note">備註：{{ info.note }}</div>
            <div class="label-brand">健美滷味</div>
          </div>
        </div>
      </template>
    </div>

    <!-- 備貨單列印區 (75x100mm, 平時隱藏) -->
    <div id="stock-print-area">
      <div v-for="(chunk, ci) in stockPrintChunks" :key="ci" class="stock-ticket">
        <div class="stock-ticket-header">
          <div class="stock-ticket-title">健美滷味 備貨清單</div>
          <div class="stock-ticket-meta">{{ stockStart }}{{ stockStart !== stockEnd ? ' ~ ' + stockEnd : '' }}</div>
        </div>
        <div class="stock-ticket-items">
          <div v-for="item in chunk" :key="item.name" class="stock-ticket-row">
            <span class="stock-ticket-name">{{ item.name }}</span>
            <span class="stock-ticket-qty">× {{ item.qty }}</span>
          </div>
        </div>
        <div class="stock-ticket-footer">
          <span>健美滷味</span>
          <span>{{ ci + 1 }} / {{ stockPrintChunks.length }}</span>
        </div>
      </div>
    </div>

    <!-- 產品編輯對話框 -->
    <div v-if="showItemModal" class="fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-[60] flex items-center justify-center p-6">
      <div class="bg-white w-full max-w-lg rounded-[2rem] p-8 shadow-2xl max-h-[90vh] overflow-y-auto border border-white/20">
        <h3 class="text-xl font-black mb-6 text-stone-800">{{ editingItem.id ? '編輯產品' : '新增產品' }}</h3>
        
        <div class="space-y-4">
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">產品名稱 <span class="text-red-500">*</span></label>
            <input v-model="itemForm.name" type="text" placeholder="例如：蘋果、香蕉" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
          </div>
          
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">價格 <span class="text-red-500">*</span></label>
            <input v-model.number="itemForm.price" type="number" placeholder="0" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
          </div>
          
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">產品描述</label>
            <textarea v-model="itemForm.description" rows="3" placeholder="產品詳細說明..." class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700 resize-none"></textarea>
          </div>
        </div>
        
        <div class="flex gap-3 mt-8">
          <button @click="closeItemModal" class="flex-1 py-3 bg-stone-100 text-stone-500 rounded-xl font-bold hover:bg-stone-200 transition">
            取消
          </button>
          <button @click="saveItem" class="flex-1 py-3 bg-brand-600 text-white rounded-xl font-bold hover:bg-brand-700 shadow-lg shadow-brand-500/30 transition">
            {{ editingItem.id ? '更新資料' : '確認新增' }}
          </button>
        </div>
      </div>
    </div>

    <!-- 帳號編輯對話框 -->
    <div v-if="showAccountModal" class="fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-[60] flex items-center justify-center p-6">
      <div class="bg-white w-full max-w-lg rounded-[2rem] p-8 shadow-2xl max-h-[90vh] overflow-y-auto border border-white/20">
        <h3 class="text-xl font-black mb-6 text-stone-800">{{ editingAccount.id ? '編輯帳號' : '新增帳號' }}</h3>
        
        <div class="space-y-4">
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">帳號 <span class="text-red-500">*</span></label>
            <input v-model="accountForm.accountId" :disabled="!!editingAccount.id" type="text" placeholder="例如：admin、User001" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700 disabled:bg-stone-100 disabled:cursor-not-allowed">
          </div>
          
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">密碼 <span class="text-red-500">*</span></label>
            <input v-model="accountForm.password" type="text" placeholder="請輸入密碼" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
            <p class="text-xs text-stone-400 mt-1 ml-1">{{ editingAccount.id ? '留空表示不修改密碼' : '必填欄位' }}</p>
          </div>
          
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">姓名</label>
            <input v-model="accountForm.name" type="text" placeholder="真實姓名" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
          </div>
          
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">電話</label>
            <input v-model="accountForm.phone" type="tel" placeholder="0912-345-678" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
          </div>
          
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">Email</label>
            <input v-model="accountForm.email" type="email" placeholder="example@email.com" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
          </div>
          
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">權限身份 <span class="text-red-500">*</span></label>
            <select v-model="accountForm.role" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
              <option value="user">一般使用者</option>
              <option value="admin">管理者</option>
            </select>
          </div>
        </div>
        
        <div class="flex gap-3 mt-8">
          <button @click="closeAccountModal" class="flex-1 py-3 bg-stone-100 text-stone-500 rounded-xl font-bold hover:bg-stone-200 transition">
            取消
          </button>
          <button @click="saveAccount" class="flex-1 py-3 bg-brand-600 text-white rounded-xl font-bold hover:bg-brand-700 shadow-lg shadow-brand-500/30 transition">
            {{ editingAccount.id ? '更新資料' : '確認新增' }}
          </button>
        </div>
      </div>
    </div>

    <!-- 自訂提示對話框 -->
    <div v-if="customAlert.show" class="fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-[100] flex items-center justify-center p-6 animate-fade-in">
      <div class="bg-white rounded-[2rem] p-8 max-w-sm w-full shadow-2xl relative border border-white overflow-hidden animate-zoom-in">
        <div :class="['absolute top-0 left-0 w-full h-2', customAlert.type === 'success' ? 'bg-green-500' : customAlert.type === 'error' ? 'bg-red-500' : 'bg-brand-500']"></div>
        <div class="flex flex-col items-center text-center">
          <div :class="['w-16 h-16 rounded-full flex items-center justify-center mb-4', customAlert.type === 'success' ? 'bg-green-100 text-green-600' : customAlert.type === 'error' ? 'bg-red-100 text-red-600' : 'bg-brand-100 text-brand-600']">
            <i :class="['text-2xl', customAlert.type === 'success' ? 'fas fa-check' : customAlert.type === 'error' ? 'fas fa-times' : 'fas fa-info']"></i>
          </div>
          <p class="font-bold text-lg text-stone-800 mb-6">{{ customAlert.message }}</p>
          <button @click="customAlert.show = false" class="w-full bg-stone-800 text-white py-3 rounded-xl font-bold hover:bg-black transition">
            確定
          </button>
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    import { createApp, ref, computed, watch, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, getDoc, doc, updateDoc, deleteDoc, query, where, setDoc, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDb3xTmnkscf9tC5znTBzkCfSzD0zLJTYk",
      authDomain: "jianmei-food-54760.firebaseapp.com",
      projectId: "jianmei-food-54760",
      storageBucket: "jianmei-food-54760.firebasestorage.app",
      messagingSenderId: "367136535654",
      appId: "1:367136535654:web:119d8cb066dfb378e1a9a7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    createApp({
      setup() {
        // 狀態管理
        const currentView = ref('login');
        const loading = ref(false);
        const showAdminMenu = ref(false);
        const adminTab = ref('accounts');
        const customAlert = ref({ show: false, message: '', type: 'info' });
        
        // 用戶資料
        const user = ref(null);
        const loginForm = ref({ id: '', pass: '' });
        
        // Admin 資料
        const adminData = ref({
          accountsList: [],
          itemsList: [],
          reviewList: [],
          detailsList: [],
          stockList: [],
          labelList: []
        });
        
        // 團購訂單展開狀態
        const expandedOrdersGroupId = ref(null);
        const expandedStockGroupId = ref(null);
        const groupOrders = ref([]);
        const groupStock = ref([]);
        const groupTotalAmount = ref(0);
        const loadingGroupOrders = ref(false);
        const groupTotalAmountMap = ref({}); // 儲存每個訂單的總金額
        
        // 訂單編輯狀態
        const editingOrderId = ref(null);
        const editFormData = ref({});
        const editOrdersList = ref([]);
        
        // 帳號管理
        const showAccountModal = ref(false);
        const editingAccount = ref({});
        const accountForm = ref({
          accountId: '',
          password: '',
          name: '',
          phone: '',
          email: '',
          role: 'user'
        });
        
        // 產品管理
        const showItemModal = ref(false);
        const editingItem = ref({});
        const itemForm = ref({
          name: '',
          price: 0,
          description: ''
        });
        const itemsSort = ref('createdAt-asc'); // 預設排序：建立時間從舊到新
        
        // 查詢及篩選
        const detailsStart = ref('');
        const detailsEnd = ref('');
        const detailsStatus = ref('approved'); // 預設狀態為 approved
        const detailsSort = ref('deliveryTime-desc'); // 訂單管理排序
        const reviewSort = ref('createdAt-desc'); // 待審核排序
        const stockStart = ref('');
        const stockEnd = ref('');
        const stockStatus = ref('approved'); // 備貨統計狀態篩選
        const labelStart = ref('');
        const labelEnd = ref('');
        // 出貨單相關
        const labelGroupsWithOrders = ref([]); // [{id, companyName, deliveryTime, ..., orders:[{id, customerName, customerUnit, items, note, totalAmount}]}]
        const labelSelectedIds = ref([]); // 已勾選的個人訂單 ID
        const labelPriceMap = ref({});
        const stockPrintChunks = ref([]);

        // computed: 出貨單總筆數
        const labelTotalOrderCount = computed(() =>
          labelGroupsWithOrders.value.reduce((sum, g) => sum + g.orders.length, 0)
        );

        // computed: 是否全選
        const isAllLabelSelected = computed(() =>
          labelTotalOrderCount.value > 0 && labelSelectedIds.value.length === labelTotalOrderCount.value
        );

        // 取得指定 orderId 的列印資料
        const getLabelInfo = (orderId) => {
          for (const group of labelGroupsWithOrders.value) {
            const order = group.orders.find(o => o.id === orderId);
            if (order) {
              return [{
                orderId: order.id,
                companyName: group.companyName,
                deliveryTimeStr: group.deliveryTime
                  ? new Date(group.deliveryTime.seconds * 1000).toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
                  : '-',
                customerName: order.customerName,
                customerUnit: order.customerUnit || '',
                items: order.items.map(item => ({
                  itemName: item.itemName,
                  qty: item.qty,
                  subtotal: ((labelPriceMap.value[item.itemName] || 0) * (parseInt(item.qty) || 0)).toLocaleString()
                })),
                totalAmount: order.totalAmount.toLocaleString(),
                note: order.note || ''
              }];
            }
          }
          return [];
        };

        // 切換單張勾選
        const toggleLabel = (orderId) => {
          const idx = labelSelectedIds.value.indexOf(orderId);
          if (idx === -1) labelSelectedIds.value.push(orderId);
          else labelSelectedIds.value.splice(idx, 1);
        };

        // 判斷該 group 是否全選
        const isGroupAllSelected = (group) =>
          group.orders.length > 0 && group.orders.every(o => labelSelectedIds.value.includes(o.id));

        // 切換整個 group 的勾選狀態
        const toggleGroupLabels = (group) => {
          if (isGroupAllSelected(group)) {
            group.orders.forEach(o => {
              const idx = labelSelectedIds.value.indexOf(o.id);
              if (idx !== -1) labelSelectedIds.value.splice(idx, 1);
            });
          } else {
            group.orders.forEach(o => {
              if (!labelSelectedIds.value.includes(o.id)) labelSelectedIds.value.push(o.id);
            });
          }
        };

        // 全選 / 全取消
        const toggleAllLabels = () => {
          if (isAllLabelSelected.value) {
            labelSelectedIds.value = [];
          } else {
            const allIds = labelGroupsWithOrders.value.flatMap(g => g.orders.map(o => o.id));
            labelSelectedIds.value = allIds;
          }
        };

        // 列印選中的出貨單
        const printStockLabels = () => {
          const items = adminData.value.stockList;
          if (!items.length) return;
          const size = 12;
          stockPrintChunks.value = [];
          for (let i = 0; i < items.length; i += size) {
            stockPrintChunks.value.push(items.slice(i, i + size));
          }
          const style = document.createElement('style');
          style.id = 'stock-page-size';
          style.textContent = '@page { size: 75mm 100mm; margin: 0; }';
          document.head.appendChild(style);
          document.body.classList.add('printing-stock');
          setTimeout(() => {
            window.print();
            setTimeout(() => {
              const s = document.getElementById('stock-page-size');
              if (s) document.head.removeChild(s);
              document.body.classList.remove('printing-stock');
            }, 500);
          }, 50);
        };

        const printLabels = () => {
          // 動態加入 75x100mm 的列印樣式
          const style = document.createElement('style');
          style.id = 'label-page-size';
          style.textContent = '@page { size: 75mm 100mm; margin: 0; }';
          document.head.appendChild(style);
          document.body.classList.add('printing-labels');
          window.print();
          setTimeout(() => {
            const s = document.getElementById('label-page-size');
            if (s) document.head.removeChild(s);
            document.body.classList.remove('printing-labels');
          }, 500);
        };

        // 顯示提示訊息
        const showAlert = (message, type = 'info') => {
          customAlert.value = { show: true, message, type };
        };

        // 排序待審核列表
        const sortedReviewList = computed(() => {
          const list = [...adminData.value.reviewList];
          const [field, order] = reviewSort.value.split('-');
          
          return list.sort((a, b) => {
            let valA, valB;
            
            if (field === 'createdAt' || field === 'deliveryTime') {
              valA = a[field]?.seconds || 0;
              valB = b[field]?.seconds || 0;
            } else if (field === 'companyName') {
              valA = (a.companyName || '').toLowerCase();
              valB = (b.companyName || '').toLowerCase();
            }
            
            if (order === 'asc') {
              return valA > valB ? 1 : valA < valB ? -1 : 0;
            } else {
              return valA < valB ? 1 : valA > valB ? -1 : 0;
            }
          });
        });

        // 排序訂單列表
        const sortedDetailsList = computed(() => {
          const list = [...adminData.value.detailsList];
          const [field, order] = detailsSort.value.split('-');
          
          return list.sort((a, b) => {
            let valA, valB;
            
            if (field === 'createdAt' || field === 'deliveryTime') {
              valA = a[field]?.seconds || 0;
              valB = b[field]?.seconds || 0;
            } else if (field === 'companyName') {
              valA = (a.companyName || '').toLowerCase();
              valB = (b.companyName || '').toLowerCase();
            }
            
            if (order === 'asc') {
              return valA > valB ? 1 : valA < valB ? -1 : 0;
            } else {
              return valA < valB ? 1 : valA > valB ? -1 : 0;
            }
          });
        });

        // 獲取帳號列表
        const fetchAdminAccounts = async () => {
          loading.value = true;
          try {
            const q = query(collection(db, "Accounts"));
            const querySnapshot = await getDocs(q);
            adminData.value.accountsList = querySnapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
          } catch (error) {
            console.error('獲取帳號列表錯誤:', error);
            showAlert('獲取失敗', 'error');
          } finally {
            loading.value = false;
          }
        };
        
        // 打開新增帳號對話框
        const openAddAccountModal = () => {
          editingAccount.value = {};
          accountForm.value = {
            accountId: '',
            password: '',
            name: '',
            phone: '',
            email: '',
            role: 'user'
          };
          showAccountModal.value = true;
        };
        
        // 編輯帳號
        const editAccount = (account) => {
          editingAccount.value = { ...account };
          accountForm.value = {
            accountId: account.accountId || '',
            password: '',
            name: account.name || '',
            phone: account.phone || '',
            email: account.email || '',
            role: account.role || 'user'
          };
          showAccountModal.value = true;
        };
        
        // 關閉帳號對話框
        const closeAccountModal = () => {
          showAccountModal.value = false;
          editingAccount.value = {};
          accountForm.value = {
            accountId: '',
            password: '',
            name: '',
            phone: '',
            email: '',
            role: 'user'
          };
        };
        
        // 儲存帳號
        const saveAccount = async () => {
          if (!accountForm.value.accountId) {
            showAlert('請輸入帳號', 'error');
            return;
          }
          
          if (!editingAccount.value.id && !accountForm.value.password) {
            showAlert('請輸入密碼', 'error');
            return;
          }
          
          loading.value = true;
          try {
            const accountData = {
              accountId: accountForm.value.accountId,
              name: accountForm.value.name,
              phone: accountForm.value.phone,
              email: accountForm.value.email,
              role: accountForm.value.role || 'user',
              updatedAt: new Date().toISOString()
            };
            
            // 如果有輸入密碼，則更新密碼
            if (accountForm.value.password) {
              accountData.password = accountForm.value.password;
            }
            
            if (editingAccount.value.id) {
              // 更新現有帳號
              const docRef = doc(db, "Accounts", editingAccount.value.id);
              await updateDoc(docRef, accountData);
              showAlert('帳號更新成功！', 'success');
            } else {
              // 新增帳號 - 使用自動生成的文檔 ID
              accountData.createdAt = new Date().toISOString();
              await addDoc(collection(db, "Accounts"), accountData);
              showAlert('帳號新增成功！', 'success');
            }
            
            closeAccountModal();
            fetchAdminAccounts();
          } catch (error) {
            console.error('儲存帳號錯誤:', error);
            showAlert('儲存失敗：' + error.message, 'error');
          } finally {
            loading.value = false;
          }
        };
        
        // 刪除帳號
        const deleteAccount = async (account) => {
          if (account.accountId === 'ADMIN') {
            showAlert('無法刪除管理員帳號', 'error');
            return;
          }
          
          if (!confirm(`確定要刪除帳號「${account.name || account.accountId}」嗎？此操作無法復原。`)) {
            return;
          }
          
          loading.value = true;
          try {
            const docRef = doc(db, "Accounts", account.id);
            await deleteDoc(docRef);
            showAlert('帳號已刪除', 'success');
            fetchAdminAccounts();
          } catch (error) {
            console.error('刪除帳號錯誤:', error);
            showAlert('刪除失敗：' + error.message, 'error');
          } finally {
            loading.value = false;
          }
        };

        // 登入處理
        const handleLogin = async () => {
          if (!loginForm.value.id || !loginForm.value.pass) {
            showAlert('請輸入帳號和密碼', 'error');
            return;
          }
          
          loading.value = true;
          try {
            // 檢查是否為 ADMIN
            if (loginForm.value.id.toUpperCase() === 'ADMIN') {
              // 先檢查硬編碼的管理員密碼（備用方案）
              if (loginForm.value.pass === '8888') {
                user.value = { id: 'ADMIN', name: '系統管理員', role: 'admin' };
                currentView.value = 'admin';
                sessionStorage.setItem('user', JSON.stringify(user.value));
                sessionStorage.setItem('currentView', 'admin');
                showAlert('登入成功！', 'success');
                // 載入帳號列表
                fetchAdminAccounts();
              } else {
                // 如果不是硬編碼密碼，再查詢 Firebase
                try {
                  const docRef = doc(db, 'users', 'ADMIN');
                  const docSnap = await getDoc(docRef);
                  
                  if (docSnap.exists()) {
                    const userData = docSnap.data();
                    if (userData.password === loginForm.value.pass) {
                      user.value = { id: 'ADMIN', role: 'admin', ...userData };
                      currentView.value = 'admin';
                      sessionStorage.setItem('user', JSON.stringify(user.value));
                      sessionStorage.setItem('currentView', 'admin');
                      showAlert('登入成功！', 'success');
                      // 載入帳號列表
                      fetchAdminAccounts();
                    } else {
                      showAlert('密碼錯誤', 'error');
                    }
                  } else {
                    showAlert('密碼錯誤', 'error');
                  }
                } catch (fbError) {
                  console.error('Firebase查詢錯誤:', fbError);
                  showAlert('密碼錯誤', 'error');
                }
              }
            } else {
              // 查詢 Accounts collection
              const q = query(collection(db, 'Accounts'), where('accountId', '==', loginForm.value.id));
              const snap = await getDocs(q);
              if (snap.empty) {
                showAlert('帳號或密碼錯誤', 'error');
              } else {
                const accData = snap.docs[0].data();
                if (accData.password === loginForm.value.pass) {
                  user.value = { id: accData.accountId, name: accData.name || accData.accountId, role: accData.role || 'user', ...accData };
                  currentView.value = 'admin';
                  sessionStorage.setItem('user', JSON.stringify(user.value));
                  sessionStorage.setItem('currentView', 'admin');
                  adminTab.value = user.value.role === 'admin' ? 'accounts' : 'details';
                  sessionStorage.setItem('adminTab', adminTab.value);
                  showAlert('登入成功！', 'success');
                  if (user.value.role === 'admin') fetchAdminAccounts();
                  else fetchOrderDetails();
                } else {
                  showAlert('帳號或密碼錯誤', 'error');
                }
              }
            }
          } catch (error) {
            console.error('登入錯誤:', error);
            showAlert('登入失敗：' + error.message, 'error');
          } finally {
            loading.value = false;
          }
        };

        // 登出
        const logout = () => {
          user.value = null;
          currentView.value = 'login';
          sessionStorage.clear();
          loginForm.value = { id: '', pass: '' };
          showAlert('已登出', 'info');
        };

        // 獲取產品列表
        const fetchAdminItems = async () => {
          loading.value = true;
          try {
            // 解析排序設定
            const [field, direction] = itemsSort.value.split('-');
            const q = query(
              collection(db, "Items"),
              orderBy(field, direction)
            );
            const querySnapshot = await getDocs(q);
            adminData.value.itemsList = querySnapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
          } catch (error) {
            console.error('獲取產品列表錯誤:', error);
            showAlert('獲取失敗', 'error');
          } finally {
            loading.value = false;
          }
        };
        
        // 打開新增產品對話框
        const openAddItemModal = () => {
          editingItem.value = {};
          itemForm.value = {
            name: '',
            price: 0,
            description: ''
          };
          showItemModal.value = true;
        };
        
        // 編輯產品
        const editItem = (item) => {
          editingItem.value = { ...item };
          itemForm.value = {
            name: item.name || '',
            price: item.price || 0,
            description: item.description || ''
          };
          showItemModal.value = true;
        };
        
        // 關閉產品對話框
        const closeItemModal = () => {
          showItemModal.value = false;
          editingItem.value = {};
          itemForm.value = {
            name: '',
            price: 0,
            description: ''
          };
        };
        
        // 儲存產品
        const saveItem = async () => {
          if (!itemForm.value.name) {
            showAlert('請輸入產品名稱', 'error');
            return;
          }
          
          if (!itemForm.value.price || itemForm.value.price <= 0) {
            showAlert('請輸入有效價格', 'error');
            return;
          }
          
          loading.value = true;
          try {
            const itemData = {
              name: itemForm.value.name,
              price: itemForm.value.price,
              description: itemForm.value.description,
              updatedAt: new Date().toISOString()
            };
            
            if (editingItem.value.id) {
              // 更新現有產品
              const docRef = doc(db, "Items", editingItem.value.id);
              await updateDoc(docRef, itemData);
              showAlert('產品更新成功！', 'success');
            } else {
              // 新增產品
              itemData.createdAt = new Date().toISOString();
              await addDoc(collection(db, "Items"), itemData);
              showAlert('產品新增成功！', 'success');
            }
            
            closeItemModal();
            fetchAdminItems();
          } catch (error) {
            console.error('儲存產品錯誤:', error);
            showAlert('儲存失敗：' + error.message, 'error');
          } finally {
            loading.value = false;
          }
        };
        
        // 刪除產品
        const deleteItem = async (item) => {
          if (!confirm(`確定要刪除產品「${item.name}」嗎？此操作無法復原。`)) {
            return;
          }
          
          loading.value = true;
          try {
            const docRef = doc(db, "Items", item.id);
            await deleteDoc(docRef);
            showAlert('產品已刪除', 'success');
            fetchAdminItems();
          } catch (error) {
            console.error('刪除產品錯誤:', error);
            showAlert('刪除失敗：' + error.message, 'error');
          } finally {
            loading.value = false;
          }
        };

        // 獲取待審核列表
        const fetchReviewList = async () => {
          loading.value = true;
          try {
            const q = query(
              collection(db, "GroupOrders"),
              where("status", "==", "pending"),
              orderBy("createdAt", "desc")
            );
            const querySnapshot = await getDocs(q);
            adminData.value.reviewList = querySnapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            
            // 自动计算每个订单的总金额
            for (const order of adminData.value.reviewList) {
              await calculateOrderTotal(order.id);
            }
          } catch (error) {
            console.error('獲取待審核列表錯誤:', error);
            showAlert('獲取失敗', 'error');
          } finally {
            loading.value = false;
          }
        };

        // 確認團購
        const confirmGroup = async (group) => {
          if (!confirm(`確定要確認「${group.companyName}」嗎？`)) return;
          
          loading.value = true;
          try {
            const docRef = doc(db, "GroupOrders", group.id);
            await updateDoc(docRef, {
              status: "approved",
              approvedAt: new Date().toISOString(),
              approvedBy: user.value.id
            });
            showAlert('已確認團購', 'success');
            fetchReviewList();
          } catch (error) {
            console.error('確認團購錯誤:', error);
            showAlert('確認失敗', 'error');
          } finally {
            loading.value = false;
          }
        };

        // 駁回團購
        const rejectGroup = async (group) => {
          if (!confirm(`確定要拒絕「${group.companyName}」的接單嗎？`)) return;
          
          loading.value = true;
          try {
            const docRef = doc(db, "GroupOrders", group.id);
            await updateDoc(docRef, {
              status: "rejected",
              rejectedAt: new Date().toISOString(),
              rejectedBy: user.value.id
            });
            showAlert('已拒絕接單', 'success');
            fetchReviewList();
          } catch (error) {
            console.error('駁回團購錯誤:', error);
            showAlert('駁回失敗', 'error');
          } finally {
            loading.value = false;
          }
        };

        // 切換訂單明細
        const toggleOrders = async (groupId) => {
          if (expandedOrdersGroupId.value === groupId) {
            expandedOrdersGroupId.value = null;
            groupOrders.value = [];
          } else {
            expandedOrdersGroupId.value = groupId;
            expandedStockGroupId.value = null; // 關閉備貨統計
            await fetchGroupOrders(groupId);
          }
        };

        // 切換備貨統計
        const toggleStock = async (groupId) => {
          if (expandedStockGroupId.value === groupId) {
            expandedStockGroupId.value = null;
            groupStock.value = [];
          } else {
            expandedStockGroupId.value = groupId;
            expandedOrdersGroupId.value = null; // 關閉訂單明細
            await fetchGroupOrders(groupId);
          }
        };

        // 獲取團購訂單
        const fetchGroupOrders = async (groupId) => {
          loadingGroupOrders.value = true;
          try {
            // 確保產品列表已載入
            if (adminData.value.itemsList.length === 0) {
              await fetchAdminItems();
            }
            
            // 建立價格映射表
            const priceMap = {};
            adminData.value.itemsList.forEach(item => {
              priceMap[item.name] = item.price || 0;
            });
            
            const q = query(
              collection(db, "Orders"),
              where("groupOrderId", "==", groupId)
            );
            const querySnapshot = await getDocs(q);
            const orders = querySnapshot.docs.map(doc => {
              const orderData = doc.data();
              let orderTotal = 0;
              
              // 計算每個訂單的金額
              if (orderData.items && Array.isArray(orderData.items)) {
                orderData.items.forEach(item => {
                  const price = priceMap[item.itemName] || 0;
                  const qty = parseInt(item.qty) || 0;
                  orderTotal += price * qty;
                });
              }
              
              return {
                id: doc.id,
                ...orderData,
                totalAmount: orderTotal
              };
            });
            
            groupOrders.value = orders;
            
            // 計算總金額
            groupTotalAmount.value = orders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
            
            // 儲存當前訂單的總金額
            groupTotalAmountMap.value = { ...groupTotalAmountMap.value, [groupId]: groupTotalAmount.value };
            
            // 計算備貨統計
            const stockMap = {};
            orders.forEach(order => {
              if (order.items && Array.isArray(order.items)) {
                order.items.forEach(item => {
                  const key = item.itemName;
                  if (!stockMap[key]) {
                    stockMap[key] = {
                      name: item.itemName,
                      quantity: 0
                    };
                  }
                  stockMap[key].quantity += parseInt(item.qty) || 0;
                });
              }
            });
            groupStock.value = Object.values(stockMap);
          } catch (error) {
            console.error('獲取訂單錯誤:', error);
            showAlert('獲取訂單失敗', 'error');
          } finally {
            loadingGroupOrders.value = false;
          }
        };

        // 計算單個訂單的總金額
        const calculateOrderTotal = async (groupId) => {
          try {
            // 確保產品列表已載入
            if (adminData.value.itemsList.length === 0) {
              await fetchAdminItems();
            }
            
            // 建立價格映射表
            const priceMap = {};
            adminData.value.itemsList.forEach(item => {
              priceMap[item.name] = item.price || 0;
            });
            
            const q = query(
              collection(db, "Orders"),
              where("groupOrderId", "==", groupId)
            );
            const querySnapshot = await getDocs(q);
            
            let totalAmount = 0;
            querySnapshot.docs.forEach(doc => {
              const orderData = doc.data();
              if (orderData.items && Array.isArray(orderData.items)) {
                orderData.items.forEach(item => {
                  const price = priceMap[item.itemName] || 0;
                  const qty = parseInt(item.qty) || 0;
                  totalAmount += price * qty;
                });
              }
            });
            
            // 儲存總金額
            groupTotalAmountMap.value = { ...groupTotalAmountMap.value, [groupId]: totalAmount };
          } catch (error) {
            console.error('計算訂單總金額錯誤:', error);
          }
        };

        // 更新訂單狀態
        const updateOrderStatus = async (order, newStatus) => {
          if (order.status === newStatus) return;
          
          const statusText = newStatus === 'approved' ? '已接單' : newStatus === 'rejected' ? '已拒絕' : '待審核';
          if (!confirm(`確定要將「${order.companyName}」的狀態改為「${statusText}」嗎？`)) {
            // 如果取消，需要重新渲染來恢複原始選項
            fetchOrderDetails();
            return;
          }
          
          loading.value = true;
          try {
            const docRef = doc(db, "GroupOrders", order.id);
            const updateData = {
              status: newStatus,
              updatedAt: new Date().toISOString(),
              updatedBy: user.value.id
            };
            
            // 根據新狀態添加對應的時間戳記
            if (newStatus === 'approved') {
              updateData.approvedAt = new Date().toISOString();
              updateData.approvedBy = user.value.id;
            } else if (newStatus === 'rejected') {
              updateData.rejectedAt = new Date().toISOString();
              updateData.rejectedBy = user.value.id;
            }
            
            await updateDoc(docRef, updateData);
            showAlert('狀態已更新', 'success');
            fetchOrderDetails();
          } catch (error) {
            console.error('更新訂單狀態錯誤:', error);
            showAlert('更新失敗', 'error');
            fetchOrderDetails();
          } finally {
            loading.value = false;
          }
        };
        
        // 開始編輯訂單
        const startEditOrder = async (order) => {
          editingOrderId.value = order.id;
          
          // 複製基本資料
          editFormData.value = {
            companyName: order.companyName || '',
            contactName: order.contactName || '',
            contactPhone: order.contactPhone || '',
            address: order.address || '',
            status: order.status || 'pending',
            deliveryTime: order.deliveryTime ? new Date(order.deliveryTime.seconds * 1000).toISOString().slice(0, 16) : ''
          };
          
          // 確保產品列表已載入
          if (adminData.value.itemsList.length === 0) {
            await fetchAdminItems();
          }
          
          // 載入訂單明細
          loadingGroupOrders.value = true;
          try {
            const q = query(
              collection(db, "Orders"),
              where("groupOrderId", "==", order.id)
            );
            const querySnapshot = await getDocs(q);
            editOrdersList.value = querySnapshot.docs.map(doc => ({
              id: doc.id,
              customerName: doc.data().customerName || '',
              customerUnit: doc.data().customerUnit || '',
              items: doc.data().items || []
            }));
          } catch (error) {
            console.error('載入訂單明細錯誤:', error);
            showAlert('載入訂單明細失敗', 'error');
            editOrdersList.value = [];
          } finally {
            loadingGroupOrders.value = false;
          }
        };
        
        // 取消編輯
        const cancelEditOrder = () => {
          if (confirm('確定要取消編輯嗎？未保存的更改將會遺失。')) {
            editingOrderId.value = null;
            editFormData.value = {};
            editOrdersList.value = [];
          }
        };
        
        // 保存編輯
        const saveEditOrder = async () => {
          if (!editFormData.value.companyName || !editFormData.value.contactName) {
            showAlert('請填寫公司名稱和聯絡人', 'error');
            return;
          }
          
          if (!confirm('確定要保存所有更改嗎？')) return;
          
          loading.value = true;
          try {
            // 更新 GroupOrder
            const groupDocRef = doc(db, "GroupOrders", editingOrderId.value);
            const groupUpdateData = {
              companyName: editFormData.value.companyName,
              contactName: editFormData.value.contactName,
              contactPhone: editFormData.value.contactPhone,
              address: editFormData.value.address,
              status: editFormData.value.status,
              updatedAt: new Date().toISOString(),
              updatedBy: user.value.id
            };
            
            // 處理配送時間
            if (editFormData.value.deliveryTime) {
              groupUpdateData.deliveryTime = new Date(editFormData.value.deliveryTime);
            }
            
            // 根據狀態添加時間戳
            if (editFormData.value.status === 'approved') {
              groupUpdateData.approvedAt = new Date().toISOString();
              groupUpdateData.approvedBy = user.value.id;
            } else if (editFormData.value.status === 'rejected') {
              groupUpdateData.rejectedAt = new Date().toISOString();
              groupUpdateData.rejectedBy = user.value.id;
            }
            
            await updateDoc(groupDocRef, groupUpdateData);
            
            // 更新所有訂單
            for (const orderItem of editOrdersList.value) {
              // 過濾掉空的項目（沒有選擇品項或沒填數量）
              const validItems = orderItem.items.filter(item => 
                item.itemName && item.itemName.trim() !== '' && item.qty && item.qty > 0
              );
              
              // 如果沒有有效項目，跳過此訂單（如果是新訂單）或刪除（如果是現有訂單）
              if (validItems.length === 0) {
                if (orderItem.id) {
                  // 刪除現有訂單
                  await deleteDoc(doc(db, "Orders", orderItem.id));
                }
                continue;
              }
              
              if (orderItem.id) {
                // 更新現有訂單
                const orderDocRef = doc(db, "Orders", orderItem.id);
                await updateDoc(orderDocRef, {
                  customerName: orderItem.customerName,
                  customerUnit: orderItem.customerUnit || '',
                  items: validItems,
                  updatedAt: new Date().toISOString()
                });
              } else {
                // 新增訂單（只有有訂購人且有有效項目才新增）
                if (orderItem.customerName && orderItem.customerName.trim() !== '') {
                  await addDoc(collection(db, "Orders"), {
                    groupOrderId: editingOrderId.value,
                    customerName: orderItem.customerName,
                    customerUnit: orderItem.customerUnit || '',
                    items: validItems,
                    createdAt: new Date()
                  });
                }
              }
            }
            
            showAlert('保存成功', 'success');
            editingOrderId.value = null;
            editFormData.value = {};
            editOrdersList.value = [];
            fetchOrderDetails();
          } catch (error) {
            console.error('保存訂單錯誤:', error);
            showAlert('保存失敗：' + error.message, 'error');
          } finally {
            loading.value = false;
          }
        };
        
        // 新增訂單
        const addNewOrder = () => {
          editOrdersList.value.push({
            id: null,
            customerName: '',
            customerUnit: '',
            items: [{ itemName: '', qty: null }]
          });
        };
        
        // 移除訂單
        const removeOrder = async (idx) => {
          const orderItem = editOrdersList.value[idx];
          if (orderItem.id) {
            if (!confirm('確定要刪除此訂單嗎？此操作無法復原。')) return;
            try {
              await deleteDoc(doc(db, "Orders", orderItem.id));
              showAlert('訂單已刪除', 'success');
            } catch (error) {
              console.error('刪除訂單錯誤:', error);
              showAlert('刪除失敗', 'error');
              return;
            }
          }
          editOrdersList.value.splice(idx, 1);
        };
        
        // 新增訂單項目
        const addOrderItem = (orderIdx) => {
          editOrdersList.value[orderIdx].items.push({ 
            itemName: '', 
            qty: null 
          });
        };
        
        // 檢查品項是否已被選擇（用於禁用選項）
        const isItemSelected = (orderIdx, currentItemIdx, itemName) => {
          const currentItems = editOrdersList.value[orderIdx].items;
          return currentItems.some((item, idx) => idx !== currentItemIdx && item.itemName === itemName);
        };
        
        // 移除訂單項目
        const removeOrderItem = (orderIdx, itemIdx) => {
          editOrdersList.value[orderIdx].items.splice(itemIdx, 1);
        };

        // 獲取訂單詳情
        const fetchOrderDetails = async () => {
          if (!detailsStart.value || !detailsEnd.value) {
            showAlert('請選擇日期範圍', 'error');
            return;
          }
          
          loading.value = true;
          try {
            // 將日期轉換為 Firestore Timestamp
            const startDate = new Date(detailsStart.value);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(detailsEnd.value);
            endDate.setHours(23, 59, 59, 999);
            
            const startTimestamp = Timestamp.fromDate(startDate);
            const endTimestamp = Timestamp.fromDate(endDate);
            
            let q;
            if (detailsStatus.value === 'all') {
              q = query(
                collection(db, "GroupOrders"),
                where("deliveryTime", ">=", startTimestamp),
                where("deliveryTime", "<=", endTimestamp),
                orderBy("deliveryTime", "desc")
              );
            } else {
              q = query(
                collection(db, "GroupOrders"),
                where("deliveryTime", ">=", startTimestamp),
                where("deliveryTime", "<=", endTimestamp),
                where("status", "==", detailsStatus.value),
                orderBy("deliveryTime", "desc")
              );
            }
            
            const querySnapshot = await getDocs(q);
            adminData.value.detailsList = querySnapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            })).sort((a, b) => {
              // 先按 deliveryTime 降序，再按 createdAt 降序
              const deliveryDiff = (b.deliveryTime?.seconds || 0) - (a.deliveryTime?.seconds || 0);
              if (deliveryDiff !== 0) return deliveryDiff;
              return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
            });
            
            // 自动计算每个订单的总金额
            for (const order of adminData.value.detailsList) {
              await calculateOrderTotal(order.id);
            }
          } catch (error) {
            console.error('獲取訂單詳情錯誤:', error);
            showAlert('獲取失敗', 'error');
          } finally {
            loading.value = false;
          }
        };

        // 獲取備貨統計
        const fetchStockList = async () => {
          if (!stockStart.value || !stockEnd.value) {
            return; // 靜默返回，不顯示錯誤
          }
          
          loading.value = true;
          try {
            // 確保產品列表已載入
            if (adminData.value.itemsList.length === 0) {
              await fetchAdminItems();
            }
            
            // 將日期轉換為 Firestore Timestamp
            const startDate = new Date(stockStart.value);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(stockEnd.value);
            endDate.setHours(23, 59, 59, 999);
            
            const startTimestamp = Timestamp.fromDate(startDate);
            const endTimestamp = Timestamp.fromDate(endDate);
            
            // 查詢 GroupOrders
            let q;
            if (stockStatus.value === 'all') {
              q = query(
                collection(db, "GroupOrders"),
                where("deliveryTime", ">=", startTimestamp),
                where("deliveryTime", "<=", endTimestamp)
              );
            } else {
              q = query(
                collection(db, "GroupOrders"),
                where("deliveryTime", ">=", startTimestamp),
                where("deliveryTime", "<=", endTimestamp),
                where("status", "==", stockStatus.value)
              );
            }
            
            const groupOrdersSnapshot = await getDocs(q);
            const groupOrderIds = groupOrdersSnapshot.docs.map(doc => doc.id);
            
            if (groupOrderIds.length === 0) {
              adminData.value.stockList = [];
              return;
            }
            
            // 查詢所有相關的訂單（分批查詢，因為 Firestore in 查詢最多 10 個）
            const stockMap = {};
            
            // 分批處理，每次最多 10 個 ID
            for (let i = 0; i < groupOrderIds.length; i += 10) {
              const batchIds = groupOrderIds.slice(i, i + 10);
              const ordersQuery = query(
                collection(db, "Orders"),
                where("groupOrderId", "in", batchIds)
              );
              const ordersSnapshot = await getDocs(ordersQuery);
              
              ordersSnapshot.docs.forEach(doc => {
                const orderData = doc.data();
                if (orderData.items && Array.isArray(orderData.items)) {
                  orderData.items.forEach(item => {
                    const itemName = item.itemName;
                    const qty = parseInt(item.qty) || 0;
                    if (itemName) {
                      stockMap[itemName] = (stockMap[itemName] || 0) + qty;
                    }
                  });
                }
              });
            }
            
            // 轉換為陣列並排序
            adminData.value.stockList = Object.keys(stockMap)
              .map(name => ({
                name,
                qty: stockMap[name]
              }))
              .sort((a, b) => b.qty - a.qty); // 按數量降序排序
              
          } catch (error) {
            console.error('獲取備貨統計錯誤:', error);
            showAlert('獲取失敗：' + error.message, 'error');
            adminData.value.stockList = [];
          } finally {
            loading.value = false;
          }
        };

        // 獲取出貨單列表
        const fetchLabelOrders = async () => {
          if (!labelStart.value || !labelEnd.value) return;
          loading.value = true;
          labelGroupsWithOrders.value = [];
          labelSelectedIds.value = [];
          try {
            if (adminData.value.itemsList.length === 0) await fetchAdminItems();
            adminData.value.itemsList.forEach(item => { labelPriceMap.value[item.name] = item.price || 0; });
            const startDate = new Date(labelStart.value); startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(labelEnd.value); endDate.setHours(23, 59, 59, 999);
            const q = query(
              collection(db, "GroupOrders"),
              where("deliveryTime", ">=", Timestamp.fromDate(startDate)),
              where("deliveryTime", "<=", Timestamp.fromDate(endDate)),
              where("status", "==", "approved")
            );
            const groupSnap = await getDocs(q);
            const groups = groupSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            if (groups.length === 0) { labelGroupsWithOrders.value = []; return; }
            const result = [];
            for (let i = 0; i < groups.length; i += 10) {
              const batchIds = groups.slice(i, i + 10).map(g => g.id);
              const ordersQ = query(collection(db, "Orders"), where("groupOrderId", "in", batchIds));
              const ordersSnap = await getDocs(ordersQ);
              for (const gid of batchIds) {
                const group = groups.find(g => g.id === gid);
                const orders = ordersSnap.docs
                  .filter(d => d.data().groupOrderId === gid)
                  .map(d => {
                    const data = d.data(); let totalAmount = 0;
                    const items = (data.items || []).map(item => {
                      const price = labelPriceMap.value[item.itemName] || 0;
                      const qty = parseInt(item.qty) || 0;
                      totalAmount += price * qty; return item;
                    });
                    return { id: d.id, ...data, items, totalAmount };
                  })
                  .sort((a, b) => (a.customerName || '').localeCompare(b.customerName || '', 'zh-TW'));
                if (orders.length > 0) result.push({ ...group, orders });
              }
            }
            result.sort((a, b) => (a.deliveryTime?.seconds || 0) - (b.deliveryTime?.seconds || 0));
            labelGroupsWithOrders.value = result;
            labelSelectedIds.value = result.flatMap(g => g.orders.map(o => o.id));
          } catch (error) {
            console.error('獲取出貨單錯誤:', error);
            showAlert('獲取失敗：' + error.message, 'error');
          } finally { loading.value = false; }
        };

        // 監聽 adminTab 切換
        watch(adminTab, (newTab) => {
          // 保存當前標籤狀態
          sessionStorage.setItem('adminTab', newTab);
          
          if (newTab === 'accounts') {
            fetchAdminAccounts();
          } else if (newTab === 'items') {
            fetchAdminItems();
          } else if (newTab === 'review') {
            fetchReviewList();
          } else if (newTab === 'stock') {
            fetchStockList();
          } else if (newTab === 'labels') {
            fetchLabelOrders();
          }
        });

        // 監聽訂單築選條件變化
        watch([detailsStart, detailsEnd, detailsStatus], () => {
          // 只有當日期都有值且在訂單管理分頁時才查詢
          if (detailsStart.value && detailsEnd.value && adminTab.value === 'details') {
            fetchOrderDetails();
          }
        });
        
        // 監聽備貨統計條件變化
        watch([stockStart, stockEnd, stockStatus], () => {
          if (stockStart.value && stockEnd.value && adminTab.value === 'stock') {
            fetchStockList();
          }
        });

        // 監聽出貨單日期變化
        watch([labelStart, labelEnd], () => {
          if (labelStart.value && labelEnd.value && adminTab.value === 'labels') {
            fetchLabelOrders();
          }
        });

        // 初始化
        onMounted(() => {
          const savedUser = sessionStorage.getItem('user');
          const savedView = sessionStorage.getItem('currentView');
          const savedTab = sessionStorage.getItem('adminTab');
          
          // 設定預設日期為明天
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          const dateStr = tomorrow.toISOString().split('T')[0];
          detailsStart.value = dateStr;
          detailsEnd.value = dateStr;
          stockStart.value = dateStr;
          stockEnd.value = dateStr;
          labelStart.value = dateStr;
          labelEnd.value = dateStr;
          
          if (savedUser && savedView) {
            user.value = JSON.parse(savedUser);
            currentView.value = savedView;
            
            if (currentView.value === 'admin') {
              // 恢復上次的標籤頁
              if (savedTab) {
                adminTab.value = savedTab;
              }
              // 非管理者不可進入帳號管理
              if (adminTab.value === 'accounts' && user.value?.role !== 'admin') {
                adminTab.value = 'details';
              }
              
              // 根據當前分頁載入對應資料
              if (adminTab.value === 'accounts') {
                fetchAdminAccounts();
              } else if (adminTab.value === 'items') {
                fetchAdminItems();
              } else if (adminTab.value === 'review') {
                fetchReviewList();
              } else if (adminTab.value === 'details') {
                fetchOrderDetails(); // 自動查詢當天的 approved 訂單
              } else if (adminTab.value === 'stock') {
                fetchStockList();
              } else if (adminTab.value === 'labels') {
                fetchLabelOrders();
              }
            }
          }
        });

        return {
          currentView,
          loading,
          showAdminMenu,
          adminTab,
          user,
          loginForm,
          adminData,
          detailsStart,
          detailsEnd,
          detailsStatus,
          detailsSort,
          reviewSort,
          stockStart,
          stockEnd,
          stockStatus,
          labelStart,
          labelEnd,
          customAlert,
          showAccountModal,
          editingAccount,
          accountForm,
          showItemModal,
          editingItem,
          itemForm,
          itemsSort,
          sortedReviewList,
          sortedDetailsList,
          expandedOrdersGroupId,
          expandedStockGroupId,
          groupOrders,
          groupStock,
          groupTotalAmount,
          loadingGroupOrders,
          groupTotalAmountMap,
          editingOrderId,
          editFormData,
          editOrdersList,
          showAlert,
          handleLogin,
          logout,
          fetchAdminAccounts,
          openAddAccountModal,
          editAccount,
          closeAccountModal,
          saveAccount,
          deleteAccount,
          fetchAdminItems,
          openAddItemModal,
          editItem,
          closeItemModal,
          saveItem,
          deleteItem,
          fetchReviewList,
          confirmGroup,
          rejectGroup,
          toggleOrders,
          toggleStock,
          fetchGroupOrders,
          calculateOrderTotal,
          updateOrderStatus,
          startEditOrder,
          cancelEditOrder,
          saveEditOrder,
          addNewOrder,
          removeOrder,
          addOrderItem,
          removeOrderItem,
          isItemSelected,
          fetchOrderDetails,
          fetchStockList,
          labelGroupsWithOrders,
          labelSelectedIds,
          labelTotalOrderCount,
          isAllLabelSelected,
          getLabelInfo,
          toggleLabel,
          isGroupAllSelected,
          toggleGroupLabels,
          toggleAllLabels,
          stockPrintChunks,
          printStockLabels,
          printLabels,
          fetchLabelOrders,
          window
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
