<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>健美滷味 - 官方訂購系統</title>
  
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['"Noto Sans TC"', 'sans-serif'],
          },
          colors: {
            brand: {
              50: '#fff7ed',
              100: '#ffedd5',
              500: '#f97316',
              600: '#ea580c',
              700: '#c2410c',
              dark: '#431407'
            }
          },
          boxShadow: {
            'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.05)',
          },
          animation: {
            'slide-down': 'slideDown 0.3s ease-out',
          },
          keyframes: {
            slideDown: {
              '0%': { opacity: '0', transform: 'translateY(-10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            }
          }
        }
      }
    }
  </script>

  <style>
    [v-cloak] { display: none !important; }
    body { background-color: #fafaf9; color: #44403c; -webkit-tap-highlight-color: transparent; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    
    @media print {
      .no-print { display: none !important; }
      @page { size: 62mm auto; margin: 0; }
      body { background: white; margin: 0; padding: 0; width: 62mm; font-size: 12pt; }
      .print-area { display: block !important; width: 100%; padding: 0; }
      .label-card { width: 100% !important; border: 2px solid #000 !important; page-break-inside: avoid; margin-bottom: 3mm; padding: 2mm !important; background: white; color: black; }
      .text-stone-400, .text-brand-600, .text-stone-500 { color: black !important; }
    }
  </style>
</head>
<body class="min-h-screen font-sans antialiased selection:bg-brand-100 selection:text-brand-700">

  <div id="app" v-cloak>
    
    <div v-if="previewImage" class="fixed inset-0 z-[100] bg-stone-900/90 backdrop-blur-sm flex items-center justify-center p-4 cursor-zoom-out transition-opacity" @click="previewImage = null">
      <img :src="previewImage" class="max-w-full max-h-[90vh] rounded-xl shadow-2xl border-4 border-white/10">
    </div>

    <div v-if="currentView === 'home'" class="flex flex-col items-center justify-center min-h-screen px-6 bg-stone-50 no-print relative overflow-hidden">
      <div class="absolute top-[-10%] right-[-10%] w-64 h-64 bg-brand-100 rounded-full blur-3xl opacity-50 pointer-events-none"></div>
      <div class="absolute bottom-[-10%] left-[-10%] w-80 h-80 bg-stone-200 rounded-full blur-3xl opacity-50 pointer-events-none"></div>

      <div class="relative bg-white/80 backdrop-blur-xl p-10 rounded-[2.5rem] shadow-soft w-full max-w-sm text-center border border-white/50">
        <div class="mb-8 inline-flex items-center justify-center w-20 h-20 rounded-full bg-brand-50 text-brand-600 text-3xl shadow-inner">
          <i class="fas fa-utensils"></i>
        </div>
        <h1 class="text-4xl font-black text-stone-800 mb-3 tracking-tight">健美滷味</h1>
        <p class="text-stone-500 text-base mb-10 font-medium tracking-wide leading-relaxed">輸入團購序號<br>開啟美味旅程</p>
        
        <div class="space-y-6">
          <div class="relative group">
             <input v-model="inputCode" type="text" placeholder="例如：BUI6OH" class="w-full text-center text-3xl font-bold tracking-[0.2em] py-5 border-2 border-stone-100 rounded-2xl focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 focus:outline-none uppercase transition-all placeholder:text-stone-200 text-stone-800 bg-white shadow-sm group-hover:border-stone-200">
          </div>
          
          <button @click="verifyCode" :disabled="!inputCode || loading" class="w-full bg-gradient-to-r from-brand-600 to-brand-500 text-white text-lg font-bold py-5 rounded-2xl shadow-lg hover:shadow-xl hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50 disabled:shadow-none disabled:cursor-not-allowed disabled:transform-none">
            <span v-if="loading"><i class="fas fa-circle-notch fa-spin mr-2"></i>驗證中...</span>
            <span v-else>開始點餐 <i class="fas fa-arrow-right ml-1"></i></span>
          </button>
        </div>
        
        <div class="mt-12 pt-8 border-t border-stone-100/50">
          <button @click="currentView = 'login'" class="text-xs text-stone-400 hover:text-brand-600 font-bold transition-colors flex items-center justify-center mx-auto gap-2 py-2 px-4 rounded-full hover:bg-stone-50">
            <i class="fas fa-lock"></i>管理員 / 團主登入
          </button>
        </div>
      </div>
    </div>

    <div v-else-if="currentView === 'order'" class="max-w-lg mx-auto bg-stone-50 min-h-screen pb-48 relative no-print shadow-2xl shadow-stone-200/50">
      <div class="bg-white/90 backdrop-blur-md px-6 py-4 sticky top-0 z-30 shadow-sm border-b border-stone-100 transition-all">
        <div class="flex justify-between items-start">
          <div class="flex-1 min-w-0 pr-4">
            <h2 class="font-black text-2xl text-stone-800 mb-1 truncate">{{ sessionInfo.groupName || sessionInfo.companyName }}</h2>
            <div class="flex flex-wrap items-center gap-2 mb-1">
              <span class="bg-brand-50 text-brand-700 text-[10px] font-bold px-2 py-0.5 rounded-md tracking-wide ring-1 ring-brand-100">團購進行中</span>
              <span class="text-xs font-mono text-stone-400">#{{ sessionInfo.code }}</span>
            </div>
            <div class="flex flex-col gap-1 mt-1 text-xs text-stone-500 font-medium">
               <span v-if="sessionInfo.deliveryDate" class="flex items-center text-brand-600 font-bold"><i class="far fa-calendar-alt mr-1.5 opacity-70"></i>預計交貨：{{ sessionInfo.deliveryDate }}</span>
               <div class="flex items-center gap-2">
                   <span v-if="sessionInfo.contactName" class="flex items-center"><i class="fas fa-user-circle mr-1 opacity-70"></i>{{ sessionInfo.contactName }}</span>
                   <span v-if="sessionInfo.contactPhone" class="flex items-center"><i class="fas fa-phone mr-1 opacity-70"></i>{{ sessionInfo.contactPhone }}</span>
               </div>
            </div>
          </div>
          <button @click="currentView='home'" class="w-10 h-10 flex flex-shrink-0 items-center justify-center bg-stone-100 rounded-full text-stone-400 hover:bg-stone-200 hover:text-stone-600 transition active:scale-90">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="px-5 pt-6">
        <div class="mb-8">
          <label class="block text-xs font-bold text-stone-400 uppercase mb-2 ml-1 tracking-wider">您的姓名</label>
          <input v-model="buyerName" class="w-full p-4 text-lg font-bold text-stone-700 border-none bg-white rounded-2xl shadow-sm ring-1 ring-stone-100 focus:ring-2 focus:ring-brand-500 outline-none transition placeholder:text-stone-300 placeholder:font-normal" placeholder="請輸入姓名以利對帳">
        </div>
        
        <div class="flex overflow-x-auto space-x-3 pb-4 mb-2 hide-scroll sticky top-[95px] z-20 bg-stone-50/95 backdrop-blur-sm py-2 -mx-5 px-5">
          <button v-for="cat in categories" @click="filterCat = cat" 
            :class="['px-5 py-2.5 rounded-full text-sm whitespace-nowrap font-bold transition-all transform active:scale-95 border', 
            filterCat === cat ? 'bg-brand-600 text-white border-brand-600 shadow-md shadow-brand-500/30' : 'bg-white text-stone-500 border-stone-100 shadow-sm']">
            {{ cat }}
          </button>
        </div>

        <div v-if="items.length === 0" class="text-center py-20 text-stone-300 italic flex flex-col items-center">
            <i class="fas fa-cloud-download-alt text-4xl mb-2 opacity-50"></i>
            <span>載入菜單中...</span>
        </div>

        <div class="space-y-4">
          <div v-for="item in filteredItems" :key="item.docId" class="group bg-white p-4 rounded-2xl shadow-sm border border-stone-100 flex gap-4 items-center transition hover:shadow-md">
            <div v-if="item.image" class="w-24 h-24 flex-shrink-0 bg-stone-100 rounded-xl overflow-hidden cursor-zoom-in relative" @click.stop="previewImage = item.image">
              <img :src="item.image" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
            </div>
            <div v-else class="w-24 h-24 flex-shrink-0 bg-stone-50 rounded-xl flex items-center justify-center text-stone-200 border border-stone-100">
               <i class="fas fa-utensils text-2xl opacity-30"></i>
            </div>

            <div class="flex-1 min-w-0 flex flex-col justify-between h-24 py-1">
              <div>
                <div class="font-bold text-stone-800 text-lg leading-tight mb-1 line-clamp-1">{{ item.name }}</div>
              </div>
              <div class="flex justify-between items-end">
                <div class="text-brand-600 font-black text-xl tracking-tight">$ {{ item.price }}</div>
                <div class="flex items-center bg-stone-50 rounded-xl p-1 border border-stone-100 shadow-inner">
                  <button @click="item.qty = Math.max(0, (item.qty||0)-1)" 
                    class="w-8 h-8 flex items-center justify-center bg-white rounded-lg text-stone-400 shadow-sm active:scale-90 transition hover:text-brand-600 disabled:opacity-30 disabled:cursor-not-allowed"
                    :disabled="!item.qty">
                    <i class="fas fa-minus text-[10px]"></i>
                  </button>
                  <span class="w-8 text-center font-bold text-lg text-stone-700 tabular-nums">{{ item.qty || 0 }}</span>
                  <button @click="item.qty = (item.qty||0)+1" class="w-8 h-8 flex items-center justify-center bg-brand-500 rounded-lg text-white shadow-md shadow-brand-500/20 active:scale-90 transition hover:bg-brand-600">
                    <i class="fas fa-plus text-[10px]"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-10 mb-8">
           <label class="block text-xs font-bold text-stone-400 uppercase mb-2 ml-1 tracking-wider">備註需求</label>
           <div class="relative">
             <i class="fas fa-pen absolute left-4 top-4 text-stone-300"></i>
             <input v-model="note" class="w-full pl-10 pr-4 py-4 text-sm font-medium bg-white rounded-2xl border-none shadow-sm ring-1 ring-stone-100 focus:ring-2 focus:ring-brand-500 outline-none transition" placeholder="例如：要大辣、不切、分裝...">
           </div>
        </div>
      </div>

      <div v-if="totalAmount > 0" class="fixed bottom-6 left-4 right-4 max-w-[480px] mx-auto z-40">
        <div class="bg-stone-900/90 backdrop-blur-lg text-white p-4 pl-6 rounded-[2rem] shadow-2xl shadow-stone-900/30 flex items-center justify-between border border-white/10">
          <div class="flex flex-col">
            <span class="text-stone-400 text-[10px] font-bold uppercase tracking-widest mb-0.5">Total</span>
            <div class="flex items-baseline gap-2">
              <span class="text-3xl font-black text-white tracking-tight">${{ totalAmount }}</span>
              <span class="text-sm text-stone-400 font-medium">/ {{ totalQty }} 項</span>
            </div>
          </div>
          <button @click="submitOrder" :disabled="submitting || !buyerName" class="bg-brand-500 text-white px-8 py-3.5 rounded-2xl font-bold text-lg shadow-lg hover:bg-brand-400 active:scale-95 transition disabled:bg-stone-700 disabled:text-stone-500 disabled:shadow-none disabled:cursor-not-allowed">
            {{ submitting ? '處理中' : '送出訂單' }}
          </button>
        </div>
      </div>
    </div>

    <div v-else-if="currentView === 'login'" class="flex flex-col items-center justify-center min-h-screen bg-stone-100 px-6 no-print">
      <form @submit.prevent="handleLogin" class="bg-white p-10 rounded-[2rem] shadow-2xl w-full max-w-sm border border-white relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-500 to-brand-600"></div>
        <h2 class="text-2xl font-black mb-10 text-center text-stone-800 tracking-tight">後台管理登入</h2>
        <div class="space-y-6">
          <div class="group">
            <label class="text-[10px] font-black text-stone-400 uppercase ml-1 tracking-widest group-focus-within:text-brand-600 transition-colors">Account ID</label>
            <input v-model="loginForm.id" type="text" autocomplete="username" placeholder="例如: ADMIN" class="w-full p-4 mt-1 border-2 border-stone-100 bg-stone-50 rounded-2xl uppercase focus:border-brand-500 focus:bg-white outline-none transition font-bold text-stone-700 placeholder:font-normal placeholder:normal-case">
          </div>
          <div class="group">
            <label class="text-[10px] font-black text-stone-400 uppercase ml-1 tracking-widest group-focus-within:text-brand-600 transition-colors">Password</label>
            <input v-model="loginForm.pass" type="password" autocomplete="current-password" placeholder="請輸入密碼" class="w-full p-4 mt-1 border-2 border-stone-100 bg-stone-50 rounded-2xl focus:border-brand-500 focus:bg-white outline-none transition" required>
          </div>
          <button type="submit" :disabled="loading" class="w-full bg-stone-800 text-white py-4 rounded-2xl shadow-xl font-black hover:bg-black active:scale-[0.98] transition mt-2">
            {{ loading ? '驗證中...' : '確認登入' }}
          </button>
          <button type="button" @click="currentView='home'" class="w-full text-center text-stone-400 text-xs mt-6 hover:text-stone-600 transition font-bold">返回首頁</button>
        </div>
      </form>
    </div>

    <div v-else-if="currentView === 'leader'" class="min-h-screen bg-stone-50 pb-20 no-print">
      <div class="bg-white px-6 py-6 shadow-sm sticky top-0 z-30 border-b border-stone-100">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
          <div class="flex items-center justify-between w-full md:w-auto">
            <div>
              <h2 class="text-xl font-black text-stone-800">{{ user.companyName }}</h2>
              <p class="text-xs text-stone-400 font-medium mt-0.5 flex items-center gap-2">
                  團主專區
                  <span v-if="user.leaderName" class="bg-stone-100 px-1.5 py-0.5 rounded text-stone-500">{{ user.leaderName }}</span>
              </p>
            </div>
            
            <div class="flex items-center gap-2 md:hidden">
                 <button @click="openProfileModal" class="bg-stone-100 text-stone-600 w-9 h-9 flex items-center justify-center rounded-xl text-xs font-bold hover:bg-brand-50 hover:text-brand-600 transition border border-stone-200">
                    <i class="fas fa-cog"></i>
                 </button>
                 <button @click="logout" class="bg-stone-800 text-white w-9 h-9 flex items-center justify-center rounded-xl text-xs font-bold hover:bg-black transition shadow-md"><i class="fas fa-sign-out-alt"></i></button>
            </div>
          </div>
          
          <div class="flex bg-stone-100 p-1 rounded-xl w-full md:w-auto">
             <button @click="leaderTab='active'; fetchActiveGroups()" :class="['flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all', leaderTab==='active' ? 'bg-white text-brand-600 shadow-sm' : 'text-stone-400 hover:text-stone-600']">
               <i class="fas fa-tasks mr-2"></i>開團管理
             </button>
             <button @click="leaderTab='history'; fetchHistoryGroups()" :class="['flex-1 md:flex-none px-6 py-2 rounded-lg text-sm font-bold transition-all', leaderTab==='history' ? 'bg-white text-stone-800 shadow-sm' : 'text-stone-400 hover:text-stone-600']">
               <i class="fas fa-history mr-2"></i>歷史紀錄
             </button>
          </div>

          <div class="hidden md:flex items-center gap-2">
             <button @click="openProfileModal" class="bg-stone-100 text-stone-600 px-3 py-2 rounded-xl text-xs font-bold hover:bg-brand-50 hover:text-brand-600 transition border border-stone-200">
                <i class="fas fa-cog mr-1"></i>帳號
             </button>
             <button @click="logout" class="bg-stone-800 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-black transition shadow-md">登出</button>
          </div>
        </div>
      </div>

      <div class="max-w-7xl mx-auto p-6">
        
        <div v-if="leaderTab === 'active'" class="animate-slide-down">
            <div class="flex justify-between items-center mb-6">
               <h3 class="font-bold text-stone-400 uppercase tracking-widest text-xs ml-1">進行中的團購清單</h3>
               <button @click="openCreateModal" :disabled="loading" class="bg-brand-600 text-white px-6 py-3 rounded-2xl font-black shadow-lg hover:bg-brand-700 active:scale-95 transition flex items-center gap-2">
                 <i class="fas fa-plus"></i> 建立新團購
               </button>
            </div>
            
            <div v-if="activeGroups.length === 0" class="text-center py-20 bg-white rounded-[2rem] border-2 border-dashed border-stone-200">
                <div class="text-stone-300 text-4xl mb-3"><i class="fas fa-clipboard-check"></i></div>
                <p class="text-stone-400 font-bold">目前沒有進行中的團購</p>
            </div>
            
            <div class="space-y-3">
                <div v-for="g in activeGroups" :key="g.id" class="bg-white rounded-[1.2rem] p-4 shadow-sm border border-stone-100 hover:shadow-md transition-all">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <div :class="['w-2.5 h-2.5 rounded-full flex-shrink-0', g.status === 'OPEN' ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.5)]' : 'bg-yellow-400 animate-pulse']"></div>
                            <div class="flex flex-col lg:flex-row lg:items-center gap-1 lg:gap-4 min-w-0">
                                <span class="font-black text-lg text-stone-800 truncate">{{ g.groupName }}</span>
                                <span class="text-xs font-bold text-stone-400 bg-stone-50 px-2.5 py-1 rounded-full border border-stone-100 flex-shrink-0">
                                    <i class="far fa-calendar-alt mr-1.5 text-brand-500"></i>{{ g.deliveryDate }}
                                </span>
                            </div>
                        </div>

                        <div class="flex items-center gap-2 flex-wrap lg:flex-nowrap">
                            <button @click="copyCode(g.code)" class="bg-stone-50 text-stone-500 px-4 py-2.5 rounded-xl text-sm font-black border border-stone-200 hover:bg-brand-50 hover:text-brand-600 hover:border-brand-200 transition flex items-center gap-2">
                                <span class="font-mono">{{ g.code }}</span>
                                <i class="far fa-copy"></i>
                            </button>

                            <div class="h-6 w-px bg-stone-200 hidden lg:block mx-1"></div>

                            <button @click="viewDetail(g)" class="flex-1 lg:flex-none bg-white text-stone-600 px-4 py-2.5 rounded-xl text-sm font-bold border border-stone-200 hover:bg-stone-50 transition">
                                {{ selectedGroup && selectedGroup.id === g.id ? '收合明細' : '訂單明細' }}
                            </button>
                            
                            <button v-if="g.status === 'OPEN'" @click="openEditModal(g)" class="bg-blue-50 text-blue-600 px-4 py-2.5 rounded-xl text-sm font-bold border border-blue-100 hover:bg-blue-100 transition">
                                <i class="fas fa-edit mr-1"></i>編輯
                            </button>
                            
                            <button v-if="g.status === 'OPEN'" @click="submitGroup(g)" class="bg-red-50 text-red-500 px-4 py-2.5 rounded-xl text-sm font-bold border border-red-100 hover:bg-red-100 transition">
                                結單送出
                            </button>
                            
                            <button v-if="g.status === 'SUBMITTED'" @click="recallGroup(g)" class="bg-yellow-50 text-yellow-600 px-4 py-2.5 rounded-xl text-sm font-bold border border-yellow-100 hover:bg-yellow-100 transition">
                                <i class="fas fa-undo mr-1"></i>收回
                            </button>
                        </div>
                    </div>
                    
                    <div v-if="selectedGroup && selectedGroup.id === g.id" class="mt-4 pt-4 border-t border-dashed border-stone-200 animate-slide-down">
                      <div v-if="loadingDetail" class="text-center py-6 text-stone-300"><i class="fas fa-spinner fa-spin text-xl"></i></div>
                      <div v-else>
                        <div class="flex justify-between items-center mb-3 bg-stone-50 p-3 rounded-xl border border-stone-100">
                          <span class="font-bold text-stone-600 text-xs">目前訂單列表 ({{ selectedDetail.list.length }})</span>
                          <span class="text-lg font-black text-brand-600">總額: ${{ selectedDetail.totalAmount }}</span>
                        </div>
                        <div class="overflow-x-auto rounded-xl border border-stone-100">
                          <table class="w-full text-left text-xs whitespace-nowrap">
                            <thead class="text-stone-400 uppercase tracking-wider bg-stone-50 border-b border-stone-100">
                              <tr><th class="py-2.5 pl-4">姓名</th><th class="py-2.5">內容</th><th class="py-2.5 text-right">金額</th><th class="py-2.5 pr-4 text-center">已收</th></tr>
                            </thead>
                            <tbody class="divide-y divide-stone-50 bg-white">
                              <tr v-for="order in selectedDetail.list" :key="order.id" class="group hover:bg-stone-50 transition-colors">
                                <td class="py-3 pl-4 font-bold text-stone-700">{{ order.buyerName }}</td>
                                <td class="py-3 text-stone-500 leading-relaxed max-w-[250px] whitespace-normal">
                                  <span v-for="i in order.items" class="inline-block bg-white border border-stone-100 px-1.5 py-0.5 rounded mr-1 mb-1 shadow-sm">{{ i.name }} <span class="text-brand-600 font-bold">x{{ i.qty }}</span></span>
                                </td>
                                <td class="py-3 text-right font-bold text-stone-800">${{ order.totalAmount }}</td>
                                <td class="py-3 pr-4 text-center"><input type="checkbox" v-model="order.isPaid" @change="togglePaid(order)" class="w-4.5 h-4.5 rounded border-stone-300 text-brand-600 focus:ring-brand-500 cursor-pointer transition"></td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="leaderTab === 'history'" class="animate-slide-down">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 bg-white p-4 rounded-2xl shadow-sm border border-stone-100">
                 <h3 class="font-bold text-stone-800 text-lg">查詢歷史紀錄</h3>
                 <div class="flex items-center gap-2 w-full sm:w-auto">
                    <input type="date" v-model="historyStart" class="flex-1 bg-stone-50 rounded-xl px-3 py-2 text-sm font-bold border border-stone-200 outline-none focus:border-brand-500 transition">
                    <span class="text-stone-300">~</span>
                    <input type="date" v-model="historyEnd" class="flex-1 bg-stone-50 rounded-xl px-3 py-2 text-sm font-bold border border-stone-200 outline-none focus:border-brand-500 transition">
                    <button @click="fetchHistoryGroups" class="bg-brand-600 text-white w-10 h-10 rounded-xl flex items-center justify-center hover:bg-brand-700 shadow-md transition"><i class="fas fa-search"></i></button>
                 </div>
            </div>
            
            <div v-if="loading" class="text-center py-16"><i class="fas fa-circle-notch fa-spin text-stone-300 text-2xl"></i></div>

            <div v-else-if="historyGroups.length === 0" class="text-center py-20 bg-white rounded-[2rem] border-2 border-dashed border-stone-200">
                <p class="text-stone-400 font-bold">此日期範圍內沒有歷史紀錄</p>
            </div>
            
            <div v-else class="space-y-3">
                <div v-for="g in historyGroups" :key="g.id" class="bg-white rounded-[1.2rem] p-4 shadow-sm border border-stone-100">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <div class="w-2.5 h-2.5 rounded-full bg-stone-300"></div>
                            <div class="flex flex-col lg:flex-row lg:items-center gap-1 lg:gap-4">
                                <span class="font-black text-lg text-stone-500">{{ g.groupName }}</span>
                                <span class="text-xs font-bold text-stone-400 bg-stone-50 px-2 py-0.5 rounded-full">{{ g.deliveryDate }}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                             <span class="text-xs font-bold text-stone-400 bg-stone-50 px-3 py-1.5 rounded-lg border border-stone-100 mr-2">序號: {{ g.code }}</span>
                             <button @click="viewDetail(g)" class="bg-stone-50 text-stone-600 px-4 py-2 rounded-xl text-sm font-bold border border-stone-200 hover:bg-stone-100 transition">明細</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

      </div>
      
      <div v-if="editingProfile" class="fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-[60] flex items-center justify-center p-6">
          <div class="bg-white w-full max-w-md rounded-[2rem] p-8 shadow-2xl overflow-y-auto max-h-[90vh] border border-white/20">
             <h3 class="text-xl font-black mb-6 text-stone-800">編輯帳號資訊</h3>
             <div class="space-y-4">
                 <div class="bg-stone-50 p-4 rounded-xl border border-stone-100 mb-2">
                     <span class="text-[10px] font-bold text-stone-400 uppercase tracking-widest">Account ID</span>
                     <div class="font-black text-xl text-stone-700 font-mono">{{ editingProfile.id }}</div>
                 </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-stone-400 ml-1">團主姓名</label><input v-model="editingProfile.leaderName" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700"></div>
                    <div><label class="text-xs font-bold text-stone-400 ml-1">聯絡電話</label><input v-model="editingProfile.phone" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700"></div>
                 </div>
                 <div><label class="text-xs font-bold text-stone-400 ml-1">部門 / 單位</label><input v-model="editingProfile.department" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700"></div>
                 <div><label class="text-xs font-bold text-stone-400 ml-1">送貨地址</label><input v-model="editingProfile.address" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700"></div>
                 <div><label class="text-xs font-bold text-stone-400 ml-1">登入密碼</label><input v-model="editingProfile.password" type="text" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700"></div>
             </div>
             <div class="flex gap-3 mt-8">
                 <button @click="editingProfile = null" class="flex-1 py-3 bg-stone-100 text-stone-500 rounded-xl font-bold hover:bg-stone-200 transition">取消</button>
                 <button @click="saveProfile" class="flex-1 py-3 bg-brand-600 text-white rounded-xl font-bold hover:bg-brand-700 shadow-lg shadow-brand-500/30 transition">儲存變更</button>
             </div>
          </div>
      </div>

      <div v-if="showGroupModal" class="fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-[60] flex items-center justify-center p-6">
          <div class="bg-white w-full max-w-md rounded-[2rem] p-8 shadow-2xl overflow-y-auto max-h-[90vh] border border-white/20">
             <h3 class="text-xl font-black mb-6 text-stone-800">{{ isEditingGroup ? '編輯團購資訊' : '建立新團購' }}</h3>
             <div class="space-y-4">
                 <div>
                    <label class="text-xs font-bold text-stone-400 ml-1">開團名稱</label>
                    <input v-model="groupForm.groupName" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700" placeholder="例如：2/14 下午茶團">
                 </div>
                 <div>
                    <label class="text-xs font-bold text-stone-400 ml-1">交貨日期</label>
                    <input v-model="groupForm.deliveryDate" type="date" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
                 </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-stone-400 ml-1">聯絡人</label><input v-model="groupForm.contactName" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700"></div>
                    <div><label class="text-xs font-bold text-stone-400 ml-1">連絡電話</label><input v-model="groupForm.contactPhone" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700"></div>
                 </div>
                 <div>
                    <label class="text-xs font-bold text-stone-400 ml-1">交貨地址</label>
                    <input v-model="groupForm.deliveryAddress" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
                 </div>
             </div>
             <div class="flex gap-3 mt-8">
                 <button @click="showGroupModal = false" class="flex-1 py-3 bg-stone-100 text-stone-500 rounded-xl font-bold hover:bg-stone-200 transition">取消</button>
                 <button @click="saveGroup" class="flex-1 py-3 bg-brand-600 text-white rounded-xl font-bold hover:bg-brand-700 shadow-lg shadow-brand-500/30 transition">{{ isEditingGroup ? '更新資訊' : '確認開團' }}</button>
             </div>
          </div>
      </div>

    </div>

    <div v-else-if="currentView === 'admin'" class="min-h-screen bg-stone-50 pb-20">
      
      <div class="bg-white/90 backdrop-blur-md px-6 py-4 shadow-sm sticky top-0 z-50 border-b border-stone-200 no-print">
        <div class="max-w-7xl mx-auto flex flex-col xl:flex-row justify-between items-center gap-4">
          <div class="flex flex-col md:flex-row items-center gap-6 w-full xl:w-auto">
            <h1 class="font-black text-xl text-stone-800 flex items-center gap-2">管理後台</h1>
          </div>
          <div class="flex gap-2">
             <button @click="adminTab='review'; fetchReviewList()" class="px-4 py-2.5 rounded-xl text-sm font-bold border bg-white">待審核</button>
             <button @click="adminTab='details'; fetchOrderDetails()" class="px-4 py-2.5 rounded-xl text-sm font-bold border bg-white">訂單</button>
             <button @click="logout" class="bg-stone-100 text-stone-500 px-3 py-2.5 rounded-xl text-sm font-bold">登出</button>
          </div>
        </div>
      </div>
      </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, addDoc, serverTimestamp, orderBy, doc, updateDoc, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const { createApp, ref, computed } = Vue;

    const firebaseConfig = {
      apiKey: "AIzaSyDb3xTmnkscf9tC5znTBzkCfSzD0zLJTYk",
      authDomain: "jianmei-food-54760.firebaseapp.com",
      projectId: "jianmei-food-54760",
      storageBucket: "jianmei-food-54760.firebasestorage.app",
      messagingSenderId: "367136535654",
      appId: "1:367136535654:web:119d8cb066dfb378e1a9a7"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const db = getFirestore(firebaseApp);

    createApp({
      setup() {
        const currentView = ref('home');
        const loading = ref(false);
        const loadingDetail = ref(false);
        const submitting = ref(false);
        const inputCode = ref('');
        const buyerName = ref('');
        const note = ref('');
        const filterCat = ref('全部');
        const sessionInfo = ref({});
        const items = ref([]);
        const loginForm = ref({ id: '', pass: '' });
        const user = ref({});
        
        const leaderTab = ref('active');
        const activeGroups = ref([]);
        const historyGroups = ref([]);
        const selectedGroup = ref(null);
        const selectedDetail = ref({ list: [], totalAmount: 0 });
        
        const todayStr = new Date().toISOString().split('T')[0];
        const historyStart = ref(todayStr);
        const historyEnd = ref(todayStr);

        const orderDate = ref(todayStr);
        const stockStart = ref(todayStr);
        const stockEnd = ref(todayStr);
        const labelDate = ref(todayStr);

        const adminTab = ref('details'); 
        const adminData = ref({ stockList: [], groupList: [], labelList: [], reviewList: [] });
        const adminItems = ref([]);
        const editingItem = ref(null);
        const previewImage = ref(null);
        const adminAccounts = ref([]);
        const editingAccount = ref(null);
        const editingProfile = ref(null);
        const showGroupModal = ref(false);
        const isEditingGroup = ref(false);
        const groupForm = ref({ id: null, groupName: '', deliveryDate: '', contactName: '', contactPhone: '', deliveryAddress: '' });

        const verifyCode = async () => {
          if (!inputCode.value) return;
          loading.value = true;
          try {
            const q = query(collection(db, "groupOrders"), where("code", "==", inputCode.value.toUpperCase()), where("status", "==", "OPEN"));
            const snap = await getDocs(q);
            if (!snap.empty) {
              sessionInfo.value = { id: snap.docs[0].id, ...snap.docs[0].data() };
              await fetchItems();
              currentView.value = 'order';
            } else { alert("序號錯誤，或該團已結單"); }
          } catch(e) { alert("連線超時"); } finally { loading.value = false; }
        };

        const fetchItems = async () => {
          const snap = await getDocs(collection(db, "items"));
          items.value = snap.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
        };

        const submitOrder = async () => {
          if (!buyerName.value) return alert('請輸入您的姓名');
          submitting.value = true;
          try {
            const cart = items.value.filter(i => i.qty > 0);
            await addDoc(collection(db, "orders"), {
              groupOrderId: sessionInfo.value.id,
              groupCode: sessionInfo.value.code,
              companyName: sessionInfo.value.companyName,
              buyerName: buyerName.value,
              items: cart,
              totalAmount: totalAmount.value,
              note: note.value,
              createdAt: serverTimestamp(),
              orderDate: new Date().toISOString().split('T')[0],
              isPaid: false,
              status: "PENDING"
            });
            alert('訂購成功！');
            currentView.value = 'home';
            inputCode.value = ''; buyerName.value = ''; note.value = '';
          } catch(e) { alert("送出失敗"); } finally { submitting.value = false; }
        };

        const handleLogin = async () => {
          if (!loginForm.value.id || !loginForm.value.pass) return alert('請輸入帳密');
          loading.value = true;
          try {
            const inputId = loginForm.value.id.toUpperCase().trim();
            const inputPass = String(loginForm.value.pass).trim();
            const q = query(collection(db, "companies"), where("id", "==", inputId), where("password", "==", inputPass));
            const snap = await getDocs(q);
            if (!snap.empty) {
              const docSnap = snap.docs[0];
              const userData = docSnap.data();
              user.value = { id: inputId, companyName: userData.name || inputId, ...userData, docId: docSnap.id };
              if (inputId === 'ADMIN') {
                currentView.value = 'admin';
                await fetchOrderDetails();
              } else {
                currentView.value = 'leader';
                await fetchActiveGroups();
              }
            } else { alert("帳號或密碼錯誤"); }
          } catch (e) { alert("資料庫錯誤"); } finally { loading.value = false; }
        };

        const fetchActiveGroups = async () => {
            loading.value = true;
            try {
                const q = query(collection(db, "groupOrders"), where("companyId", "==", user.value.id));
                const snap = await getDocs(q);
                const list = snap.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .filter(g => g.status === 'OPEN' || g.status === 'SUBMITTED');
                activeGroups.value = list.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                selectedGroup.value = null;
            } catch(e) { console.error(e); } finally { loading.value = false; }
        };

        const fetchHistoryGroups = async () => {
            loading.value = true;
            try {
                const q = query(collection(db, "groupOrders"), where("companyId", "==", user.value.id));
                const snap = await getDocs(q);
                let list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                list = list.filter(g => {
                    const d = new Date(g.createdAt?.seconds * 1000).toISOString().split('T')[0];
                    return d >= historyStart.value && d <= historyEnd.value;
                });
                historyGroups.value = list.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            } catch(e) { console.error(e); } finally { loading.value = false; }
        };

        const openCreateModal = () => {
            const now = new Date();
            groupForm.value = { id: null, groupName: `${now.getMonth() + 1}/${now.getDate()} 下午茶團`, deliveryDate: '', contactName: user.value.leaderName || '', contactPhone: user.value.phone || '', deliveryAddress: user.value.address || '' };
            isEditingGroup.value = false;
            showGroupModal.value = true;
        };

        const openEditModal = (group) => {
            groupForm.value = { id: group.id, groupName: group.groupName || '', deliveryDate: group.deliveryDate || '', contactName: group.contactName || '', contactPhone: group.contactPhone || '', deliveryAddress: group.deliveryAddress || '' };
            isEditingGroup.value = true;
            showGroupModal.value = true;
        };

        const saveGroup = async () => {
            const form = groupForm.value;
            if(!form.groupName || !form.deliveryDate) return alert("必填欄位不可為空");
            loading.value = true;
            try {
                const groupData = { groupName: form.groupName, deliveryDate: form.deliveryDate, contactName: form.contactName, contactPhone: form.contactPhone, deliveryAddress: form.deliveryAddress };
                if (isEditingGroup.value) {
                    await updateDoc(doc(db, "groupOrders", form.id), groupData);
                    alert("更新成功");
                } else {
                    const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                    await addDoc(collection(db, "groupOrders"), { ...groupData, code, companyId: user.value.id, companyName: user.value.companyName, status: "OPEN", createdAt: serverTimestamp() });
                    alert(`開團成功！序號：${code}`);
                }
                showGroupModal.value = false;
                await fetchActiveGroups();
            } catch(e) { alert("儲存失敗"); } finally { loading.value = false; }
        };

        const copyCode = (code) => {
             navigator.clipboard.writeText(code).then(() => alert("序號已複製！")).catch(() => alert("複製失敗"));
        };

        const viewDetail = async (group) => {
          if (selectedGroup.value?.id === group.id) { selectedGroup.value = null; return; }
          selectedGroup.value = group;
          loadingDetail.value = true;
          try {
            const q = query(collection(db, "orders"), where("groupOrderId", "==", group.id));
            const snap = await getDocs(q);
            const orders = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            selectedDetail.value = { list: orders, totalAmount: orders.reduce((sum, o) => sum + (o.totalAmount || 0), 0) };
          } catch (e) { console.error(e); } finally { loadingDetail.value = false; }
        };

        const togglePaid = async (order) => {
          try { await updateDoc(doc(db, "orders", order.id), { isPaid: order.isPaid }); } catch(e) {}
        };

        const submitGroup = async (group) => {
            if(!confirm(`確定要結單嗎？送出後管理員將收到通知。`)) return;
            try {
                await updateDoc(doc(db, "groupOrders", group.id), { status: "SUBMITTED" });
                alert("已結單送出！");
                await fetchActiveGroups();
            } catch(e) { alert("結單失敗"); }
        };

        const recallGroup = async (group) => {
            if(!confirm("確定要收回嗎？")) return;
            try {
                await updateDoc(doc(db, "groupOrders", group.id), { status: "OPEN" });
                alert("已收回，可以繼續讓同事下單");
                await fetchActiveGroups();
            } catch(e) { alert("收回失敗"); }
        };

        const openProfileModal = () => editingProfile.value = { ...user.value };
        const saveProfile = async () => {
            loading.value = true;
            try {
                const updateData = { leaderName: editingProfile.value.leaderName, phone: editingProfile.value.phone, department: editingProfile.value.department || '', address: editingProfile.value.address || '', password: editingProfile.value.password };
                await updateDoc(doc(db, "companies", user.value.docId), updateData);
                user.value = { ...user.value, ...updateData };
                editingProfile.value = null;
                alert("資料更新成功");
            } finally { loading.value = false; }
        };

        const logout = () => location.reload();
        const formatDate = (ts) => ts ? new Date(ts.seconds*1000).toLocaleDateString() : '剛剛';
        const categories = computed(() => ['全部', ...new Set(items.value.map(i => i.category || '精選'))]);
        const filteredItems = computed(() => filterCat.value === '全部' ? items.value : items.value.filter(i => (i.category||'精選') === filterCat.value));
        const totalQty = computed(() => items.value.reduce((s, i) => s + (i.qty || 0), 0));
        const totalAmount = computed(() => items.value.reduce((s, i) => s + (i.price * (i.qty || 0)), 0));

        return {
          currentView, loading, loadingDetail, submitting, inputCode, sessionInfo, buyerName, note, items, filterCat,
          loginForm, user, adminData, leaderTab, activeGroups, historyGroups, selectedGroup, selectedDetail,
          historyStart, historyEnd, editingProfile, showGroupModal, groupForm, isEditingGroup, previewImage,
          verifyCode, handleLogin, submitOrder, logout, submitGroup, recallGroup, formatDate, viewDetail, togglePaid,
          openProfileModal, saveProfile, fetchActiveGroups, fetchHistoryGroups,
          openCreateModal, openEditModal, saveGroup, copyCode,
          categories, filteredItems, totalQty, totalAmount
        };
      }
    }).mount('#app');
  </script>
</body>
</html>