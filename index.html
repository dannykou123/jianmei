<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="健美滷味團購管理系統 - 管理員後台">
  <title>健美滷味 - 管理後台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: { 50: '#FFF5F3', 100: '#FFE5DF', 200: '#FFD4CC', 300: '#FFB8A8', 400: '#FF9B82', 500: '#C84B31', 600: '#B54329', 700: '#9A3921', 800: '#7F2F1A', 900: '#642512' } }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    [v-cloak] { display: none; }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    @keyframes zoom-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    @keyframes slide-down { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fade-in 0.2s ease-out; }
    .animate-zoom-in { animation: zoom-in 0.3s ease-out; }
    .animate-slide-down { animation: slide-down 0.3s ease-out; }
    .hide-scroll::-webkit-scrollbar { display: none; }
    .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    @media print {
      .no-print { display: none !important; }
      body { background: white !important; margin: 0 !important; padding: 0 !important; }
      /* 出貨單列印 75x100mm */
      body.printing-labels .hide-for-label-print { display: none !important; }
      body.printing-labels #label-print-area { display: block !important; }
      body:not(.printing-labels) #label-print-area { display: none !important; }
      /* 備貨單列印 75x100mm */
      body.printing-stock .hide-for-stock-print { display: none !important; }
      body.printing-stock #stock-print-area { display: block !important; }
      body:not(.printing-stock) #stock-print-area { display: none !important; }
      /* 單筆出貨單列印 */
      body.printing-single-label .hide-for-label-print { display: none !important; }
      body.printing-single-label #single-label-print-area { display: block !important; }
      body:not(.printing-single-label) #single-label-print-area { display: none !important; }
      /* 單筆備料單列印 */
      body.printing-single-stock .hide-for-stock-print { display: none !important; }
      body.printing-single-stock #single-stock-print-area { display: block !important; }
      body:not(.printing-single-stock) #single-stock-print-area { display: none !important; }
      .stock-ticket {
        width: 75mm; height: 100mm;
        page-break-after: always; page-break-inside: avoid;
        padding: 3mm; box-sizing: border-box;
        font-family: Arial, sans-serif; overflow: hidden;
        display: flex; flex-direction: column;
      }
      .stock-ticket:last-child { page-break-after: auto; }
      .stock-ticket-header { border-bottom: 1.5px solid #000; padding-bottom: 1mm; margin-bottom: 1.2mm; }
      .stock-ticket-title { font-size: 15pt; font-weight: bold; }
      .stock-ticket-meta { font-size: 10pt; color: #444; margin-top: 0.3mm; }
      .stock-ticket-items { flex: 1; overflow: hidden; display: grid; grid-template-columns: 1fr 1fr; column-gap: 3mm; align-content: start; }
      .stock-ticket-row { display: flex; flex-direction: column; padding: 0.4mm 0; border-bottom: 0.5px solid #ddd; }
      .stock-ticket-name { font-size: 11pt; font-weight: bold; line-height: 1.2; white-space: normal; }
      .stock-ticket-qty { font-size: 11pt; font-weight: bold; color: #111; line-height: 1.2; }
      .stock-ticket-footer { border-top: 1px solid #000; padding-top: 1mm; margin-top: auto; font-size: 10pt; display: flex; justify-content: space-between; color: #666; }
      .label-ticket {
        width: 75mm; height: 100mm;
        page-break-after: always; page-break-inside: avoid;
        border: 1px solid #000; padding: 3mm;
        box-sizing: border-box; font-family: Arial, sans-serif;
        overflow: hidden; display: flex; flex-direction: column;
      }
      .label-ticket-cont {
        width: 75mm; height: 100mm;
        page-break-after: always; page-break-inside: avoid;
        border: 1px solid #000; padding: 3mm;
        box-sizing: border-box; font-family: Arial, sans-serif;
        overflow: hidden; display: flex; flex-direction: column;
      }
      .label-ticket-cont:last-child { page-break-after: auto; }
      .label-cont-header { padding-bottom: 1.5mm; margin-bottom: 2mm; }
      .label-page-num { font-size: 8pt; color: #aaa; text-align: right; margin-top: 1mm; }
      .label-ticket:last-child { page-break-after: auto; }
      .label-header { border-bottom: 1.5px solid #000; padding-bottom: 2mm; margin-bottom: 2mm; }
      .label-company { font-size: 14pt; font-weight: bold; line-height: 1.25; }
      .label-delivery { font-size: 10pt; color: #333; margin-top: 0.5mm; }
      .label-customer { font-size: 14pt; font-weight: bold; margin-bottom: 1mm; }
      .label-items { flex: 1; overflow: hidden; display: grid; grid-template-columns: 1fr 1fr; column-gap: 3mm; align-content: start; }
      .label-item-row { display: flex; flex-direction: column; padding: 0.8mm 0; line-height: 1.5; }
      .label-item-name { font-size: 10pt; font-weight: bold; line-height: 1.2; white-space: normal; }
      .label-item-right { font-size: 9.5pt; color: #333; line-height: 1.2; }
      .label-footer { border-top: 1.5px solid #000; padding-top: 1mm; margin-top: auto; }
      .label-total { font-size: 15pt; font-weight: bold; text-align: right; }
      .label-note { font-size: 9pt; color: #333; margin-top: 0.8mm; padding-top: 0.5mm; line-height: 1.5; }
      .label-brand { font-size: 8pt; color: #888; text-align: center; margin-top: 0.5mm; }
    }
    #label-print-area { display: none; }
    #stock-print-area { display: none; }
    #single-label-print-area { display: none; }
    #single-stock-print-area { display: none; }
  </style>
</head>
<body>
  <div id="app" v-cloak>
    
    <!-- 管理員登入頁面 -->
    <div v-if="currentView === 'login'" class="flex flex-col items-center justify-center min-h-screen bg-stone-100 px-6">
      <form @submit.prevent="handleLogin" class="bg-white p-10 rounded-[2rem] shadow-2xl w-full max-w-sm border border-white relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-500 to-brand-600"></div>
        <h2 class="text-2xl font-black mb-10 text-center text-stone-800 tracking-tight">管理後台登入</h2>
        <div class="space-y-6">
          <div class="group">
            <label class="text-[10px] font-black text-stone-400 uppercase ml-1 tracking-widest">Account ID</label>
            <input v-model="loginForm.id" type="text" autocomplete="username" placeholder="請輸入帳號" class="w-full p-4 mt-1 border-2 border-stone-100 bg-stone-50 rounded-2xl focus:border-brand-500 focus:bg-white outline-none transition font-bold text-stone-700 placeholder:font-normal">
          </div>
          <div class="group">
            <label class="text-[10px] font-black text-stone-400 uppercase ml-1 tracking-widest">Password</label>
            <input v-model="loginForm.pass" type="password" autocomplete="current-password" placeholder="請輸入密碼" class="w-full p-4 mt-1 border-2 border-stone-100 bg-stone-50 rounded-2xl focus:border-brand-500 focus:bg-white outline-none transition" required>
          </div>
          <button type="submit" :disabled="loading" class="w-full bg-stone-800 text-white py-4 rounded-2xl shadow-xl font-black hover:bg-black active:scale-[0.98] transition mt-2">
            {{ loading ? '驗證中...' : '確認登入' }}
          </button>
        </div>
      </form>
    </div>

    <!-- 管理員後台 -->
    <div v-else-if="currentView === 'admin'" class="min-h-screen bg-stone-50 pb-20 hide-for-label-print hide-for-stock-print">
      
      <!-- 導航欄 -->
      <div class="bg-white/90 backdrop-blur-md px-4 py-3 shadow-sm sticky top-0 z-50 border-b border-stone-200 no-print">
        <div class="max-w-7xl mx-auto">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
               <h1 class="font-black text-base text-stone-900 flex items-center gap-2 whitespace-nowrap">
                 <span class="w-8 h-8 bg-gradient-to-br from-brand-600 to-brand-500 text-white rounded-xl flex items-center justify-center text-base shadow-lg shadow-brand-500/30"><i class="fas fa-chart-pie"></i></span>
                 <span>管理後台</span>
               </h1>
            </div>
            
            <!-- 導航按鈕（手機與桌面共用） -->
            <div class="flex items-center gap-1">
               <button @click="adminTab='review'; fetchReviewList()" :class="['px-2.5 py-1.5 rounded-xl text-xs font-bold transition-all flex items-center gap-1 whitespace-nowrap border', adminTab=='review'?'bg-red-500 text-white border-red-500 shadow-md shadow-red-500/30':'bg-white text-stone-500 border-stone-200 hover:bg-stone-50']">
                 <i class="hidden sm:inline fas fa-clock"></i><span>待審核</span><span v-if="adminData.reviewList.length > 0" class="bg-white text-red-500 text-[10px] px-1.5 rounded-md font-black shadow-sm">{{ adminData.reviewList.length }}</span>
               </button>
               <button @click="adminTab='details'; fetchOrderDetails()" :class="['px-2.5 py-1.5 rounded-xl text-xs font-bold transition-all whitespace-nowrap border', adminTab=='details'?'bg-stone-800 text-white border-stone-800 shadow-md':'bg-white text-stone-500 border-stone-200 hover:bg-stone-50']">
                 <i class="hidden sm:inline fas fa-file-alt mr-1"></i>訂單管理
               </button>
               <div class="w-px h-5 bg-stone-300 mx-0.5"></div>
               <!-- 設定齒輪下拉選單 -->
               <div class="relative">
                 <div v-if="showSettingsMenu" class="fixed inset-0 z-40" @click="showSettingsMenu = false"></div>
                 <button @click="showSettingsMenu = !showSettingsMenu" :class="['px-2.5 py-1.5 rounded-xl text-xs font-bold transition-all border', (adminTab=='accounts'||adminTab=='items'||adminTab=='contacts') ? 'bg-stone-800 text-white border-stone-800 shadow-md' : 'bg-white text-stone-500 border-stone-200 hover:bg-stone-50']">
                   <i class="fas fa-cog"></i>
                 </button>
                 <div v-if="showSettingsMenu" class="absolute right-0 top-full mt-2 w-48 bg-white rounded-2xl shadow-xl border border-stone-100 py-2 z-50 animate-slide-down">
                   <button v-if="user && user.role === 'admin'" @click="adminTab='accounts'; fetchAdminAccounts(); showSettingsMenu=false" :class="['w-full text-left px-4 py-2.5 text-sm font-bold transition flex items-center gap-3 rounded-lg mx-0', adminTab=='accounts' ? 'bg-stone-100 text-stone-800' : 'text-stone-600 hover:bg-stone-50']">
                     <i class="fas fa-users w-4"></i>帳號管理
                   </button>
                   <button @click="adminTab='items'; fetchAdminItems(); showSettingsMenu=false" :class="['w-full text-left px-4 py-2.5 text-sm font-bold transition flex items-center gap-3', adminTab=='items' ? 'bg-stone-100 text-stone-800' : 'text-stone-600 hover:bg-stone-50']">
                     <i class="fas fa-box w-4"></i>產品管理
                   </button>
                   <button @click="adminTab='contacts'; fetchFrequentContacts(); showSettingsMenu=false" :class="['w-full text-left px-4 py-2.5 text-sm font-bold transition flex items-center gap-3', adminTab=='contacts' ? 'bg-stone-100 text-stone-800' : 'text-stone-600 hover:bg-stone-50']">
                     <i class="fas fa-address-book w-4"></i>常用聯絡人
                   </button>
                 </div>
               </div>
               <button @click="logout" class="bg-stone-100 text-stone-500 px-2.5 py-1.5 rounded-xl text-xs font-bold hover:bg-stone-200 border border-stone-200">
                 <i class="fas fa-sign-out-alt"></i>
               </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 手機版側邊選單 -->
      <transition name="mobile-menu">
        <div v-if="showAdminMenu" @click="showAdminMenu = false" class="md:hidden fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-40 no-print">
          <div @click.stop class="bg-white w-72 h-full shadow-2xl p-6 overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
              <h2 class="font-black text-xl text-stone-800">功能選單</h2>
              <button @click="showAdminMenu = false" class="w-8 h-8 bg-stone-100 rounded-lg flex items-center justify-center text-stone-600 hover:bg-stone-200">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="space-y-2">
              <button @click="adminTab='review'; fetchReviewList(); showAdminMenu=false" :class="['w-full text-left px-4 py-3 rounded-xl font-bold transition-all flex items-center gap-3', adminTab=='review'?'bg-red-500 text-white':'text-stone-600 hover:bg-stone-50']">
                <i class="fas fa-clock w-5"></i><span>待審核 <span v-if="adminData.reviewList.length>0" class="text-xs">({{adminData.reviewList.length}})</span></span>
              </button>
              <button @click="adminTab='details'; fetchOrderDetails(); showAdminMenu=false" :class="['w-full text-left px-4 py-3 rounded-xl font-bold transition-all flex items-center gap-3', adminTab=='details'?'bg-stone-800 text-white':'text-stone-600 hover:bg-stone-50']">
                <i class="fas fa-file-alt w-5"></i><span>訂單管理</span>
              </button>
              <div class="border-t border-stone-100 pt-2 mt-2">
                <p class="text-[10px] font-black text-stone-400 uppercase tracking-widest px-4 mb-2">設定</p>
                <button v-if="user && user.role === 'admin'" @click="adminTab='accounts'; fetchAdminAccounts(); showAdminMenu=false" :class="['w-full text-left px-4 py-3 rounded-xl font-bold transition-all flex items-center gap-3', adminTab=='accounts'?'bg-stone-800 text-white':'text-stone-600 hover:bg-stone-50']">
                  <i class="fas fa-users w-5"></i><span>帳號管理</span>
                </button>
                <button @click="adminTab='items'; fetchAdminItems(); showAdminMenu=false" :class="['w-full text-left px-4 py-3 rounded-xl font-bold transition-all flex items-center gap-3', adminTab=='items'?'bg-stone-800 text-white':'text-stone-600 hover:bg-stone-50']">
                  <i class="fas fa-box w-5"></i><span>產品管理</span>
                </button>
                <button @click="adminTab='contacts'; fetchFrequentContacts(); showAdminMenu=false" :class="['w-full text-left px-4 py-3 rounded-xl font-bold transition-all flex items-center gap-3', adminTab=='contacts'?'bg-stone-800 text-white':'text-stone-600 hover:bg-stone-50']">
                  <i class="fas fa-address-book w-5"></i><span>常用聯絡人</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </transition>

      <!-- 主要內容區域 -->
      <div class="max-w-7xl mx-auto p-4 md:p-6">
        
        <!-- 帳號管理 -->
        <div v-if="adminTab === 'accounts'" class="space-y-4">
          <div class="flex items-center justify-between mb-4 gap-2">
            <h2 class="text-xl font-black text-stone-800">帳號管理</h2>
            <button @click="openAddAccountModal" class="bg-brand-600 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-brand-700 transition shadow-lg flex items-center gap-1.5 whitespace-nowrap">
              <i class="fas fa-plus"></i>新增帳號
            </button>
          </div>
          
          <div v-if="loading" class="text-center py-20"><i class="fas fa-circle-notch fa-spin text-3xl text-stone-300"></i></div>
          
          <div v-else-if="adminData.accountsList.length === 0" class="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-stone-200">
            <i class="fas fa-users text-6xl mb-4 text-stone-300"></i>
            <p class="font-bold text-stone-400">目前沒有帳號資料</p>
          </div>
          
          <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div v-for="account in adminData.accountsList" :key="account.id" class="bg-white rounded-2xl p-6 shadow-sm border border-stone-100 hover:shadow-md transition">
              <div class="flex justify-between items-start mb-4">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 bg-gradient-to-br from-brand-500 to-brand-600 rounded-xl flex items-center justify-center text-white font-black text-lg">
                    {{ account.name ? account.name.charAt(0).toUpperCase() : account.accountId.charAt(0) }}
                  </div>
                  <div>
                    <h3 class="font-black text-stone-800">{{ account.name || account.accountId }}</h3>
                    <p class="text-xs text-stone-500">{{ account.accountId }}</p>
                  </div>
                </div>
                <span :class="['text-xs font-bold px-2 py-1 rounded-lg', account.role === 'admin' ? 'bg-brand-100 text-brand-700' : 'bg-stone-100 text-stone-500']">
                  {{ account.role === 'admin' ? '管理者' : '一般使用者' }}
                </span>
              </div>
              
              <div class="space-y-2 mb-4 text-sm">
                <div v-if="account.email" class="flex items-center gap-2 text-stone-600">
                  <i class="fas fa-envelope w-4"></i>
                  <span>{{ account.email }}</span>
                </div>
                <div v-if="account.phone" class="flex items-center gap-2 text-stone-600">
                  <i class="fas fa-phone w-4"></i>
                  <span>{{ account.phone }}</span>
                </div>
              </div>
              
              <div class="flex gap-2 pt-4 border-t border-stone-100">
                <button @click="editAccount(account)" class="flex-1 bg-blue-50 text-blue-600 py-2 rounded-xl font-bold hover:bg-blue-100 transition text-sm">
                  <i class="fas fa-edit mr-1"></i>編輯
                </button>
                <button @click="deleteAccount(account)" class="flex-1 bg-red-50 text-red-800 py-2 rounded-xl font-bold hover:bg-red-100 transition text-sm">
                  <i class="fas fa-trash mr-1"></i>刪除
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- 常用聯絡人管理 -->
        <div v-if="adminTab === 'contacts'" class="space-y-4">
          <div class="flex items-center justify-between mb-4 gap-2">
            <h2 class="text-xl font-black text-stone-800">常用聯絡人</h2>
            <button @click="openAddContactModal" class="bg-brand-600 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-brand-700 transition shadow-lg flex items-center gap-1.5 whitespace-nowrap">
              <i class="fas fa-plus"></i>新增
            </button>
          </div>

          <div v-if="loading" class="text-center py-20"><i class="fas fa-circle-notch fa-spin text-3xl text-stone-300"></i></div>

          <div v-else-if="frequentContacts.length === 0" class="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-stone-200">
            <i class="fas fa-address-book text-6xl mb-4 text-stone-300"></i>
            <p class="font-bold text-stone-400">尚無常用聯絡人</p>
          </div>

          <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div v-for="contact in frequentContacts" :key="contact.id" class="bg-white rounded-2xl p-6 shadow-sm border border-stone-100 hover:shadow-md transition">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 bg-gradient-to-br from-brand-500 to-brand-600 rounded-xl flex items-center justify-center text-white font-black text-lg flex-shrink-0">
                  {{ contact.companyName ? contact.companyName.charAt(0) : '?' }}
                </div>
                <div class="min-w-0">
                  <h3 class="font-black text-stone-800 truncate">{{ contact.companyName }}</h3>
                  <p class="text-xs text-stone-500">{{ contact.contactName }}</p>
                </div>
              </div>
              <div class="space-y-2 mb-4 text-sm">
                <div v-if="contact.contactPhone" class="flex items-center gap-2 text-stone-600">
                  <i class="fas fa-phone w-4 text-stone-400"></i>
                  <span>{{ contact.contactPhone }}</span>
                </div>
                <div v-if="contact.address" class="flex items-start gap-2 text-stone-600">
                  <i class="fas fa-map-marker-alt w-4 text-stone-400 mt-0.5"></i>
                  <span class="line-clamp-2">{{ contact.address }}</span>
                </div>
              </div>
              <div class="flex gap-2 pt-4 border-t border-stone-100">
                <button @click="editContact(contact)" class="flex-1 bg-blue-50 text-blue-600 py-2 rounded-xl font-bold hover:bg-blue-100 transition text-sm">
                  <i class="fas fa-edit mr-1"></i>編輯
                </button>
                <button @click="deleteContact(contact)" class="flex-1 bg-red-50 text-red-800 py-2 rounded-xl font-bold hover:bg-red-100 transition text-sm">
                  <i class="fas fa-trash mr-1"></i>刪除
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- 產品管理 -->
        <div v-if="adminTab === 'items'" class="space-y-4">
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-4">
              <h2 class="text-2xl font-black text-stone-800">產品管理</h2>
              <select v-model="itemsSort" @change="fetchAdminItems" class="w-full sm:w-auto px-4 py-2 bg-white border-2 border-stone-200 rounded-xl font-bold text-stone-700 text-sm hover:border-brand-500 transition">
                <option value="createdAt-asc">建立時間 (舊→新)</option>
                <option value="createdAt-desc">建立時間 (新→舊)</option>
                <option value="name-asc">名稱 (A→Z)</option>
                <option value="name-desc">名稱 (Z→A)</option>
                <option value="price-asc">價格 (低→高)</option>
                <option value="price-desc">價格 (高→低)</option>
              </select>
            </div>
            <button @click="openAddItemModal" class="bg-brand-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-brand-700 transition shadow-lg flex items-center justify-center gap-2">
              <i class="fas fa-plus"></i><span>新增產品</span>
            </button>
          </div>
          
          <div v-if="loading" class="text-center py-20"><i class="fas fa-circle-notch fa-spin text-3xl text-stone-300"></i></div>
          
          <div v-else-if="adminData.itemsList.length === 0" class="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-stone-200">
            <i class="fas fa-box text-6xl mb-4 text-stone-300"></i>
            <p class="font-bold text-stone-400">目前沒有產品資料</p>
          </div>
          
          <div v-else class="space-y-3">
            <div v-for="item in adminData.itemsList" :key="item.id" class="bg-white rounded-xl p-4 shadow-sm border border-stone-100 hover:shadow-md transition">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div class="flex-1 min-w-0">
                  <div class="flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-3 mb-1">
                    <h3 class="font-black text-stone-800 text-base">{{ item.name }}</h3>
                    <p class="text-lg font-black text-brand-600">NT$ {{ item.price }}</p>
                  </div>
                  <p v-if="item.description" class="text-sm text-stone-500 line-clamp-2">{{ item.description }}</p>
                </div>
                
                <div class="flex gap-2 sm:flex-shrink-0">
                  <button @click="editItem(item)" class="flex-1 sm:flex-none px-4 py-2 bg-blue-50 text-blue-600 rounded-lg font-bold hover:bg-blue-100 transition text-sm">
                    <i class="fas fa-edit mr-1"></i>編輯
                  </button>
                  <button @click="deleteItem(item)" class="flex-1 sm:flex-none px-4 py-2 bg-red-50 text-red-800 rounded-lg font-bold hover:bg-red-100 transition text-sm">
                    <i class="fas fa-trash mr-1"></i>刪除
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 待審核 -->
        <div v-if="adminTab === 'review'" class="space-y-4">
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-6">
            <h2 class="text-2xl font-black text-stone-800">待審核訂單</h2>
            <select v-model="reviewSort" class="w-full sm:w-auto px-4 py-2 bg-white border-2 border-stone-200 rounded-xl font-bold text-stone-700 text-sm hover:border-brand-500 transition">
              <option value="createdAt-desc">建立時間 (新→舊)</option>
              <option value="createdAt-asc">建立時間 (舊→新)</option>
              <option value="deliveryTime-desc">配送時間 (新→舊)</option>
              <option value="deliveryTime-asc">配送時間 (舊→新)</option>
              <option value="companyName-asc">公司名稱 (A→Z)</option>
              <option value="companyName-desc">公司名稱 (Z→A)</option>
            </select>
          </div>
          <div v-if="loading" class="text-center py-20"><i class="fas fa-circle-notch fa-spin text-3xl text-stone-300"></i></div>
          <div v-else-if="adminData.reviewList.length === 0" class="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-stone-200">
            <i class="fas fa-check-circle text-6xl mb-4 text-stone-300"></i>
            <p class="font-bold text-stone-400">目前沒有待審核的團購</p>
          </div>
          <div v-else class="space-y-4">
              <div v-for="g in sortedReviewList" :key="g.id" class="bg-white rounded-2xl p-6 shadow-sm border border-stone-100 hover:shadow-md transition">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 mb-4">
                  <div class="flex-1">
                    <h3 class="text-xl font-black text-stone-800 mb-2">{{ g.companyName }}</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-stone-600">
                      <div class="flex items-center gap-2">
                        <i class="fas fa-user w-4 text-stone-400"></i>
                        <span>聯絡人：{{ g.contactName }}</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <i class="fas fa-phone w-4 text-stone-400"></i>
                        <span>電話：{{ g.contactPhone }}</span>
                      </div>
                      <div class="flex items-start gap-2">
                        <i class="fas fa-truck w-4 text-stone-400 mt-0.5"></i>
                        <span class="break-all">配送：{{ g.deliveryTime ? new Date(g.deliveryTime.seconds * 1000).toLocaleString('zh-TW', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}) : '-' }}</span>
                      </div>
                      <div class="flex items-start gap-2">
                        <i class="fas fa-calendar-plus w-4 text-stone-400 mt-0.5"></i>
                        <span class="break-all">建立：{{ g.createdAt ? new Date(g.createdAt.seconds * 1000).toLocaleString('zh-TW', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}) : '-' }}</span>
                      </div>
                    </div>
                    <p v-if="g.address" class="text-sm text-stone-500 mt-3"><i class="fas fa-map-marker-alt mr-2"></i>{{ g.address }}</p>
                    <!-- 顯示總金額 -->
                    <div v-if="groupTotalAmountMap[g.id] > 0" class="mt-3 text-lg font-bold text-red-800">
                      <i class="fas fa-dollar-sign mr-1"></i>總金額：${{ groupTotalAmountMap[g.id].toLocaleString() }}
                    </div>
                  </div>
                  <span class="bg-amber-100 text-amber-700 px-3 py-1.5 rounded-full text-xs font-bold inline-block sm:flex-shrink-0 border border-amber-200">待審核</span>
                </div>
                <div class="flex flex-row gap-1 mt-4 pt-4 border-t border-stone-100">
                  <button @click="toggleOrders(g.id)" class="flex-1 bg-white text-stone-700 py-2.5 rounded-xl font-bold border border-stone-300 hover:bg-stone-100 transition flex flex-col sm:flex-row items-center justify-center gap-1 text-xs sm:text-base">
                    <i class="fas fa-receipt"></i>
                    <span class="hidden sm:inline">訂單明細</span>
                    <span class="sm:hidden">訂單</span>
                  </button>
                  <button @click="toggleStock(g.id)" class="flex-1 bg-white text-stone-700 py-2.5 rounded-xl font-bold border border-stone-300 hover:bg-stone-100 transition flex flex-col sm:flex-row items-center justify-center gap-1 text-xs sm:text-base">
                    <i class="fas fa-boxes"></i>
                    <span class="hidden sm:inline">備貨統計</span>
                    <span class="sm:hidden">備貨</span>
                  </button>
                  <button @click="confirmGroup(g)" class="flex-1 bg-white text-stone-700 py-2.5 rounded-xl font-bold border border-stone-300 hover:bg-stone-200 transition flex flex-col sm:flex-row items-center justify-center gap-1 text-xs sm:text-base">
                    <i class="fas fa-check"></i>
                    <span class="hidden sm:inline">確認接單</span>
                    <span class="sm:hidden">接單</span>
                  </button>
                  <button @click="rejectGroup(g)" class="flex-1 bg-white text-stone-700 py-2.5 rounded-xl font-bold border border-stone-300 hover:bg-stone-200 transition flex flex-col sm:flex-row items-center justify-center gap-1 text-xs sm:text-base">
                    <i class="fas fa-times"></i>
                    <span class="hidden sm:inline">拒絕接單</span>
                    <span class="sm:hidden">拒絕</span>
                  </button>
                </div>
                <!-- 展開備貨統計 -->
                <div v-if="expandedStockGroupId === g.id" class="mt-4 pt-4 border-t border-stone-200 bg-stone-50">
                  <div v-if="loadingGroupOrders" class="text-center py-8">
                    <i class="fas fa-circle-notch fa-spin text-2xl text-stone-300"></i>
                  </div>
                  <div v-else>
                    <!-- 備貨統計 -->
                    <div>
                      <h4 class="text-lg font-bold text-stone-800 mb-3 flex items-center gap-2">
                        <i class="fas fa-boxes text-stone-400"></i>備貨統計
                      </h4>
                      <div v-if="groupStock.length === 0" class="text-sm text-stone-400 text-center py-4 bg-stone-50 rounded-xl">
                        暫無商品數據
                      </div>
                      <div v-else class="space-y-0 divide-y divide-stone-100">
                        <div v-for="stock in groupStock" :key="stock.name" class="py-3 flex items-center justify-between">
                          <span class="text-stone-700">{{ stock.name }}</span>
                          <span class="text-stone-900 font-semibold tabular-nums">{{ stock.quantity }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- 展開訂單明細 -->
                <div v-if="expandedOrdersGroupId === g.id" class="mt-4 pt-4 border-t border-stone-200 bg-stone-50">
                  <div v-if="loadingGroupOrders" class="text-center py-8">
                    <i class="fas fa-circle-notch fa-spin text-2xl text-stone-300"></i>
                  </div>
                  <div v-else>
                    <!-- 訂單列表 -->
                    <div>
                      <h4 class="text-lg font-bold text-stone-800 flex items-center gap-2 mb-3">
                        <i class="fas fa-receipt text-stone-400"></i>訂單明細 <span class="text-sm font-normal text-stone-500">(共 {{ groupOrders.length }} 筆)</span>
                      </h4>
                      <div v-if="groupOrders.length === 0" class="text-sm text-stone-400 text-center py-4 bg-stone-50 rounded-xl">
                        暫無訂單數據
                      </div>
                      <div v-else class="space-y-2 max-h-96 overflow-y-auto">
                        <div v-for="order in groupOrders.slice().sort((a, b) => (b.createdAt && b.createdAt.seconds ? b.createdAt.seconds : 0) - (a.createdAt && a.createdAt.seconds ? a.createdAt.seconds : 0))" :key="order.id" class="bg-stone-50 rounded-lg p-4 border border-stone-200">
                          <div class="flex flex-wrap items-start justify-between gap-2 mb-2">
                            <div class="flex items-center gap-2">
                              <i class="fas fa-user-circle text-stone-400"></i>
                              <span class="font-bold text-stone-800">{{ order.customerName || '未知' }}</span>
                              <span v-if="order.customerUnit" class="text-xs text-stone-500 bg-stone-100 px-2 py-0.5 rounded">{{ order.customerUnit }}</span>
                            </div>
                            <div class="text-sm font-bold text-stone-700">${{ (order.totalAmount || 0).toLocaleString() }}</div>
                          </div>
                          <div v-if="order.items && order.items.length > 0" class="space-y-1">
                            <div v-for="(item, idx) in order.items" :key="idx" class="flex justify-between items-center text-sm py-1.5 px-2 bg-white rounded border border-stone-100">
                              <span class="text-stone-700">{{ item.itemName }}</span>
                              <span class="font-bold text-stone-800">x{{ item.qty }}</span>
                            </div>
                          </div>
                          <div v-else class="text-xs text-stone-400 italic">無商品項目</div>
                          <div v-if="order.note" class="mt-2 text-xs text-stone-500 bg-stone-50 p-2 rounded border-l-2 border-stone-200">
                            <i class="fas fa-comment-dots mr-1"></i>{{ order.note }}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
            </div>
          </div>
        </div>

        <!-- 訂單詳情 -->
        <div v-if="adminTab === 'details'" class="space-y-4">
          <div class="flex items-center justify-between mb-4 gap-2">
            <h2 class="text-xl font-black text-stone-800 whitespace-nowrap">訂單管理</h2>
            <button @click="openCreateOrderModal" class="inline-flex items-center gap-1.5 px-3 py-2 bg-stone-800 text-white rounded-xl text-sm font-bold hover:bg-black transition whitespace-nowrap flex-shrink-0">
              <i class="fas fa-plus"></i>新增訂單
            </button>
          </div>

          <div v-if="loading" class="text-center py-20"><i class="fas fa-circle-notch fa-spin text-3xl text-stone-300"></i></div>
          <div v-else-if="adminData.detailsList.length === 0" class="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-stone-200">
            <i class="fas fa-inbox text-6xl mb-4 text-stone-300"></i>
            <p class="font-bold text-stone-400">沒有符合條件的訂單</p>
          </div>
          <div v-else>
            <!-- 批次匯出按鈕 -->
            <div class="mb-3 flex flex-wrap gap-2 items-center">
              <button @click="batchExportStock" :disabled="selectedOrderIds.length === 0" class="flex-1 sm:flex-none px-4 py-2 bg-stone-800 text-white rounded-lg text-sm font-bold hover:bg-black transition disabled:opacity-40 whitespace-nowrap">
                <i class="fas fa-boxes mr-1"></i><span class="hidden sm:inline">批次匯出</span>備貨單
              </button>
              <button @click="batchExportLabels" :disabled="selectedOrderIds.length === 0" class="flex-1 sm:flex-none px-4 py-2 bg-green-700 text-white rounded-lg text-sm font-bold hover:bg-green-800 transition disabled:opacity-40 whitespace-nowrap">
                <i class="fas fa-shipping-fast mr-1"></i><span class="hidden sm:inline">批次匯出</span>出貨單 ({{ selectedOrderIds.length }})
              </button>
            </div>
            <!-- Dashboard 總金額區塊 -->
            <div class="grid grid-cols-3 gap-2 md:gap-4 mb-2">
              <div class="bg-white rounded-2xl shadow-sm border border-stone-100 p-3 md:p-5 flex flex-col items-center">
                <span class="text-[10px] md:text-xs font-bold text-stone-400 mb-1 text-center leading-tight">全部金額<span class="hidden sm:inline"> (不含已拒絕)</span></span>
                <span class="text-base md:text-2xl font-black text-red-700">${{ detailsDashboardTotal.toLocaleString() }}</span>
                <span class="text-xs md:text-base font-bold text-stone-400 mt-1 md:mt-2">{{ detailsOrderCount }}筆</span>
              </div>
              <div class="bg-white rounded-2xl shadow-sm border border-stone-100 p-3 md:p-5 flex flex-col items-center">
                <span class="text-[10px] md:text-xs font-bold text-stone-400 mb-1 text-center leading-tight">已接單金額</span>
                <span class="text-base md:text-2xl font-black text-green-700">${{ detailsApprovedTotal.toLocaleString() }}</span>
                <span class="text-xs md:text-base font-bold text-stone-400 mt-1 md:mt-2">{{ detailsApprovedCount }}筆</span>
              </div>
              <div class="bg-white rounded-2xl shadow-sm border border-stone-100 p-3 md:p-5 flex flex-col items-center">
                <span class="text-[10px] md:text-xs font-bold text-stone-400 mb-1 text-center leading-tight">待審核金額</span>
                <span class="text-base md:text-2xl font-black text-amber-700">${{ detailsPendingTotal.toLocaleString() }}</span>
                <span class="text-xs md:text-base font-bold text-stone-400 mt-1 md:mt-2">{{ detailsPendingCount }}筆</span>
              </div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-stone-100 mb-3 px-3 sm:px-4 py-3 flex flex-wrap items-center gap-2">
              <!-- 日期輸入：手機版同一列，sm+ 解構成直接子元素 -->
              <div class="flex items-center gap-2 w-full sm:w-auto sm:contents">
                <div class="flex items-center gap-1.5 flex-1 sm:flex-none">
                  <label class="text-xs font-bold text-stone-400 whitespace-nowrap">開始</label>
                  <input type="date" v-model="detailsStart" class="flex-1 sm:flex-none min-w-0 px-1.5 py-1.5 border border-stone-200 rounded-lg text-xs text-stone-700 outline-none bg-white">
                </div>
                <div class="flex items-center gap-1.5 flex-1 sm:flex-none">
                  <label class="text-xs font-bold text-stone-400 whitespace-nowrap">結束</label>
                  <input type="date" v-model="detailsEnd" class="flex-1 sm:flex-none min-w-0 px-1.5 py-1.5 border border-stone-200 rounded-lg text-xs text-stone-700 outline-none bg-white">
                </div>
              </div>
              <!-- 快速篩選按鈕：手機滿版，sm+ 自然寬度 -->
              <div class="flex items-center gap-1.5 w-full sm:w-auto">
                <button @click="setYesterdayFilter" :class="['flex-1 sm:flex-none px-2.5 py-1 rounded-lg text-xs font-bold transition whitespace-nowrap', detailsStart === getTaiwanDateStr(-1) && detailsEnd === getTaiwanDateStr(-1) ? 'bg-stone-800 text-white' : 'bg-stone-100 text-stone-800 hover:bg-stone-200']">昨日訂單</button>
                <button @click="setTodayFilter" :class="['flex-1 sm:flex-none px-2.5 py-1 rounded-lg text-xs font-bold transition whitespace-nowrap', isTodayFilter ? 'bg-stone-800 text-white' : 'bg-stone-100 text-stone-800 hover:bg-stone-200']">今日訂單</button>
                <button @click="setTomorrowFilter" :class="['flex-1 sm:flex-none px-2.5 py-1 rounded-lg text-xs font-bold transition whitespace-nowrap', isTomorrowFilter ? 'bg-stone-800 text-white' : 'bg-stone-100 text-stone-800 hover:bg-stone-200']">明日訂單</button>
              </div>
              <!-- 匯出/清除按鈕：手機滿版，sm+ 靠右（空間不足自動換行至第二列，仍靠右） -->
              <div v-if="detailsStart && detailsEnd" class="flex items-center gap-1.5 w-full sm:w-auto sm:ml-auto">
                <button @click="printAllFilteredStock" :disabled="loading" class="flex-1 sm:flex-none inline-flex items-center justify-center gap-1 px-2.5 py-1.5 bg-stone-100 text-stone-600 rounded-lg text-xs font-bold hover:bg-stone-200 transition disabled:opacity-40 whitespace-nowrap"><i class="fas fa-boxes"></i>總備貨單</button>
                <button @click="printAllFilteredLabels" :disabled="loading" class="flex-1 sm:flex-none inline-flex items-center justify-center gap-1 px-2.5 py-1.5 bg-stone-100 text-stone-600 rounded-lg text-xs font-bold hover:bg-stone-200 transition disabled:opacity-40 whitespace-nowrap"><i class="fas fa-shipping-fast"></i>總出貨單</button>
                <button @click="clearDetailsFilter" class="flex-1 sm:flex-none inline-flex items-center justify-center gap-1 px-2.5 py-1.5 bg-white border border-stone-300 text-stone-800 rounded-lg text-xs font-bold hover:bg-stone-50 transition whitespace-nowrap"><i class="fas fa-undo"></i>清除篩選</button>
              </div>
            </div>
            <!-- 篩選列 + 搜尋 -->
            <div class="bg-white rounded-2xl shadow-sm border border-stone-100 mb-3 px-4 py-3 flex flex-col gap-3">
              <!-- 狀態篩選 + 每頁筆數 -->
              <div class="flex items-center gap-2 flex-wrap">
                <div class="flex rounded-lg border border-stone-200 overflow-hidden flex-shrink-0">
                  <button @click="detailsStatus = 'all'" :class="['px-3 py-1.5 text-xs font-bold transition', detailsStatus === 'all' ? 'bg-stone-800 text-white' : 'bg-white text-stone-500 hover:bg-stone-50', 'w-auto']">全部</button>
                  <button @click="detailsStatus = 'approved'" :class="['px-3 py-1.5 text-xs font-bold border-l border-stone-200 transition', detailsStatus === 'approved' ? 'bg-stone-800 text-white' : 'bg-white text-stone-500 hover:bg-stone-50', 'w-auto']">已接單</button>
                  <button @click="detailsStatus = 'pending'" :class="['px-3 py-1.5 text-xs font-bold border-l border-stone-200 transition', detailsStatus === 'pending' ? 'bg-stone-800 text-white' : 'bg-white text-stone-500 hover:bg-stone-50', 'w-auto']">待審核</button>
                  <button @click="detailsStatus = 'rejected'" :class="['px-3 py-1.5 text-xs font-bold border-l border-stone-200 transition', detailsStatus === 'rejected' ? 'bg-stone-800 text-white' : 'bg-white text-stone-500 hover:bg-stone-50', 'w-auto']">已拒絕</button>
                  <button @click="detailsStatus = 'expired'" :class="['px-3 py-1.5 text-xs font-bold border-l border-stone-200 transition', detailsStatus === 'expired' ? 'bg-stone-800 text-white' : 'bg-white text-stone-500 hover:bg-stone-50', 'w-auto']">已過期</button>
                </div>
                <div class="flex items-center gap-2 ml-auto">
                  <div class="relative w-64">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-stone-300 text-xs"></i>
                    <input type="text" v-model="detailsKeyword" placeholder="公司名稱、聯絡人、電話..." class="w-full pl-8 pr-3 py-1.5 border border-stone-200 rounded-lg text-sm outline-none text-stone-700">
                  </div>
                  <select v-model.number="detailsPageSize" class="px-2 py-1.5 border border-stone-200 rounded-lg text-xs font-bold text-stone-700 bg-white outline-none">
                    <option :value="10">10筆</option>
                    <option :value="20">20筆</option>
                    <option :value="50">50筆</option>
                    <option :value="100">100筆</option>
                  </select>

                </div>
              <!-- 分頁控制 -->
            </div>
            <!-- 表格 -->
            <div class="bg-white rounded-2xl shadow-sm border border-stone-100 overflow-x-auto">
              <!-- 分頁控制列移到 table 最上方 -->
              <div class="flex items-center justify-between px-4 pt-4">
                <div class="flex items-center gap-3">
                  <span class="text-xs text-stone-400 font-bold">第 {{ detailsPage }} / {{ totalDetailsPages }} 頁</span>
                  <span class="text-xs font-bold text-stone-400">共 {{ sortedDetailsList.length }} 筆</span>
                </div>
                <div class="flex items-center gap-1">
                  <button @click="detailsPage = 1" :disabled="detailsPage === 1" class="w-8 h-8 rounded-lg border border-stone-200 text-stone-500 hover:bg-stone-100 disabled:opacity-30 disabled:cursor-not-allowed text-sm font-bold flex items-center justify-center">«</button>
                  <button @click="detailsPage--" :disabled="detailsPage === 1" class="w-8 h-8 rounded-lg border border-stone-200 text-stone-500 hover:bg-stone-100 disabled:opacity-30 disabled:cursor-not-allowed text-sm font-bold flex items-center justify-center">‹</button>
                  <button @click="detailsPage++" :disabled="detailsPage === totalDetailsPages" class="w-8 h-8 rounded-lg border border-stone-200 text-stone-500 hover:bg-stone-100 disabled:opacity-30 disabled:cursor-not-allowed text-sm font-bold flex items-center justify-center">›</button>
                  <button @click="detailsPage = totalDetailsPages" :disabled="detailsPage === totalDetailsPages" class="w-8 h-8 rounded-lg border border-stone-200 text-stone-500 hover:bg-stone-100 disabled:opacity-30 disabled:cursor-not-allowed text-sm font-bold flex items-center justify-center">»</button>
                </div>
              </div>
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-stone-100 text-xs font-black text-stone-400 uppercase tracking-wider">
                    <th class="px-4 py-3 text-center"><input type="checkbox" :checked="isAllOrderSelected" @change="toggleAllOrderSelection" class="w-4 h-4 accent-stone-800"></th>
                    <th class="px-4 py-3 text-left">狀態</th>
                    <th class="px-4 py-3 text-left cursor-pointer select-none hover:text-stone-600 transition" @click="sortByField('deliveryTime')">
                      配送時間
                      <i :class="['fas ml-1', detailsSort.startsWith('deliveryTime') ? (detailsSort.endsWith('asc') ? 'fa-sort-up text-stone-700' : 'fa-sort-down text-stone-700') : 'fa-sort text-stone-300']"></i>
                    </th>
                    <th class="px-4 py-3 text-left cursor-pointer select-none hover:text-stone-600 transition" @click="sortByField('companyName')">
                      公司名稱
                      <i :class="['fas ml-1', detailsSort.startsWith('companyName') ? (detailsSort.endsWith('asc') ? 'fa-sort-up text-stone-700' : 'fa-sort-down text-stone-700') : 'fa-sort text-stone-300']"></i>
                    </th>
                    <th class="hidden sm:table-cell px-4 py-3 text-left">聯絡人</th>
                    <th class="hidden sm:table-cell px-4 py-3 text-left">連絡電話</th>
                    <th class="hidden sm:table-cell px-4 py-3 text-left">來源</th>
                    <th class="hidden sm:table-cell px-4 py-3 text-right">總金額</th>
                    <th class="hidden sm:table-cell px-4 py-3 text-center">操作</th>
                  </tr>
                </thead>
                <tbody>
                  <template v-for="order in pagedDetailsList" :key="order.id">
                  <tr class="border-b sm:border-b border-stone-50 hover:bg-stone-50 transition">
                    <td class="px-4 py-3 text-center">
                      <input type="checkbox" :checked="selectedOrderIds.includes(order.id)" @change="toggleOrderSelection(order.id)" class="w-4 h-4 accent-stone-800">
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                      <button @click="statusEditOrder = order" :class="['inline-block px-2 py-1 rounded-full text-xs font-bold cursor-pointer hover:opacity-80 transition', order.status === 'approved' ? 'bg-green-100 text-green-700' : order.status === 'rejected' ? 'bg-red-100 text-red-800' : order.status === 'expired' ? 'bg-stone-200 text-stone-500' : 'bg-amber-100 text-amber-700']">
                        {{ order.status === 'approved' ? '已接單' : order.status === 'rejected' ? '已拒絕' : order.status === 'expired' ? '已過期' : '待審核' }}
                      </button>
                    </td>
                    <td class="px-4 py-3 text-stone-500 whitespace-nowrap">
                      <span class="hidden sm:inline">{{ order.deliveryTime ? new Date(order.deliveryTime.seconds * 1000).toLocaleString('zh-TW', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}) : '-' }}</span>
                      <span class="sm:hidden">{{ order.deliveryTime ? new Date(order.deliveryTime.seconds * 1000).toLocaleString('zh-TW', {month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}) : '-' }}</span>
                    </td>
                    <td class="px-4 py-3 font-bold text-stone-800 whitespace-nowrap">{{ order.companyName }}</td>
                    <td class="hidden sm:table-cell px-4 py-3 text-stone-600 whitespace-nowrap">{{ order.contactName }}</td>
                    <td class="hidden sm:table-cell px-4 py-3 text-stone-500 whitespace-nowrap">{{ order.contactPhone || '-' }}</td>
                    <td class="hidden sm:table-cell px-4 py-3 text-stone-500 whitespace-nowrap">{{ order.resource || '-' }}</td>
                    <td class="hidden sm:table-cell px-4 py-3 text-right font-bold text-red-800 whitespace-nowrap">
                      {{ groupTotalAmountMap[order.id] > 0 ? '$' + groupTotalAmountMap[order.id].toLocaleString() : '-' }}
                    </td>
                    <td class="hidden sm:table-cell px-4 py-3 text-center whitespace-nowrap">
                      <div class="flex gap-2 justify-center">
                        <button @click="printSingleStock(order)" :disabled="printingSingleId === order.id" class="px-3 py-1 bg-stone-100 text-stone-500 rounded-lg hover:bg-stone-200 transition text-xs font-bold" title="列印備料單">備貨單</button>
                        <button @click="printSingleLabel(order)" :disabled="printingSingleId === order.id" class="px-3 py-1 bg-stone-100 text-stone-500 rounded-lg hover:bg-stone-200 transition text-xs font-bold" title="列印出貨單">出貨單</button>
                        <button @click="openDetailModal(order)" class="px-3 py-1 bg-stone-800 text-white rounded-lg hover:bg-black transition text-xs font-bold">詳細</button>
                      </div>
                    </td>
                  </tr>
                  <!-- 手機版操作列：橫跨全部欄位，桌面版隱藏 -->
                  <tr class="sm:hidden border-b border-stone-100">
                    <td colspan="4" class="px-3 pb-2.5 pt-0">
                      <div class="flex gap-2">
                        <button @click="printSingleStock(order)" :disabled="printingSingleId === order.id" class="flex-1 py-1.5 bg-stone-100 text-stone-500 rounded-lg hover:bg-stone-200 transition text-xs font-bold text-center disabled:opacity-40">
                          <i class="fas fa-boxes mr-1"></i>備貨單
                        </button>
                        <button @click="printSingleLabel(order)" :disabled="printingSingleId === order.id" class="flex-1 py-1.5 bg-stone-100 text-stone-500 rounded-lg hover:bg-stone-200 transition text-xs font-bold text-center disabled:opacity-40">
                          <i class="fas fa-shipping-fast mr-1"></i>出貨單
                        </button>
                        <button @click="openDetailModal(order)" class="flex-1 py-1.5 bg-stone-800 text-white rounded-lg hover:bg-black transition text-xs font-bold text-center">
                          <i class="fas fa-search mr-1"></i>詳細
                        </button>
                      </div>
                    </td>
                  </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>

          <!-- 訂單狀態修改 Modal -->
          <div v-if="statusEditOrder" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 animate-fade-in" style="z-index:2147483646;" @click.self="statusEditOrder = null">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs p-6 animate-zoom-in" style="z-index:2147483647; position:relative;">
              <h3 class="text-base font-black mb-1">變更訂單狀態</h3>
              <p class="text-sm text-stone-500 mb-5">{{ statusEditOrder.companyName }}</p>
              <div class="flex flex-col gap-2">
                <button @click="changeOrderStatus('approved')" :class="['w-full py-2.5 rounded-xl text-sm font-bold transition', statusEditOrder.status === 'approved' ? 'bg-green-600 text-white cursor-default' : 'bg-green-50 text-green-700 hover:bg-green-100']">
                  <i class="fas fa-check-circle mr-2" style="color:#22c55e !important;"></i>已接單
                </button>
                <button @click="changeOrderStatus('pending')" :class="['w-full py-2.5 rounded-xl text-sm font-bold transition', statusEditOrder.status === 'pending' ? 'bg-amber-500 text-white cursor-default' : 'bg-amber-50 text-amber-700 hover:bg-amber-100']">
                  <i class="fas fa-clock mr-2"></i>待審核
                </button>
                <button @click="changeOrderStatus('rejected')" :class="['w-full py-2.5 rounded-xl text-sm font-bold transition', statusEditOrder.status === 'rejected' ? 'bg-red-600 text-white cursor-default' : 'bg-red-50 text-red-700 hover:bg-red-100']">
                  <i class="fas fa-times-circle mr-2"></i>已拒絕
                </button>
                <button @click="changeOrderStatus('expired')" :class="['w-full py-2.5 rounded-xl text-sm font-bold transition', statusEditOrder.status === 'expired' ? 'bg-stone-500 text-white cursor-default' : 'bg-stone-100 text-stone-500 hover:bg-stone-200']">
                  <i class="fas fa-calendar-times mr-2"></i>已過期
                </button>
              </div>
              <button @click="statusEditOrder = null" class="mt-4 w-full py-2 rounded-xl text-sm font-bold bg-stone-100 text-stone-500 hover:bg-stone-200 transition">取消</button>
            </div>
          </div>

          <!-- 詳細資訊 Modal -->
          <div v-if="detailModalOrder" class="fixed inset-0 bg-black/40 z-50 flex items-center justify-center p-4 animate-fade-in" @click.self="closeDetailModal">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl max-h-[88vh] flex flex-col animate-zoom-in">

              <!-- Modal Header -->
              <div class="flex items-start justify-between px-6 pt-5 pb-4">
                <div>
                  <h3 class="text-xl font-black text-stone-900 leading-tight">{{ detailModalOrder.companyName }}</h3>
                  <div class="mt-2 flex items-center">
                    <button @click="statusEditOrder = detailModalOrder" v-if="detailModalOrder.status === 'approved'" class="px-4 py-1 rounded-lg font-bold bg-green-100 text-green-700 text-sm focus:outline-none" style="display:inline-block;">已接單</button>
                    <button @click="statusEditOrder = detailModalOrder" v-else-if="detailModalOrder.status === 'rejected'" class="px-4 py-1 rounded-lg font-bold bg-red-100 text-red-800 text-sm focus:outline-none" style="display:inline-block;">已拒絕</button>
                    <button @click="statusEditOrder = detailModalOrder" v-else-if="detailModalOrder.status === 'expired'" class="px-4 py-1 rounded-lg font-bold bg-stone-200 text-stone-500 text-sm focus:outline-none" style="display:inline-block;">已過期</button>
                    <button @click="statusEditOrder = detailModalOrder" v-else class="px-4 py-1 rounded-lg font-bold bg-amber-100 text-amber-700 text-sm focus:outline-none" style="display:inline-block;">待審核</button>
                  </div>
                </div>
                <button @click="closeDetailModal" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-stone-100 text-stone-400 hover:text-stone-600 transition mt-0.5 flex-shrink-0"><i class="fas fa-times text-sm"></i></button>
              </div>

              <!-- Modal Tabs -->
              <div class="flex border-b border-stone-100 px-6">
                <button @click="detailModalTab = 'info'" :class="['px-4 py-2.5 text-sm font-bold border-b-2 transition -mb-px', detailModalTab === 'info' ? 'border-stone-800 text-stone-800' : 'border-transparent text-stone-400 hover:text-stone-600']">基本資訊</button>
                <button @click="detailModalTab = 'orders'" :class="['px-4 py-2.5 text-sm font-bold border-b-2 transition -mb-px', detailModalTab === 'orders' ? 'border-stone-800 text-stone-800' : 'border-transparent text-stone-400 hover:text-stone-600']">訂單明細</button>
                <button @click="detailModalTab = 'stock'" :class="['px-4 py-2.5 text-sm font-bold border-b-2 transition -mb-px', detailModalTab === 'stock' ? 'border-stone-800 text-stone-800' : 'border-transparent text-stone-400 hover:text-stone-600']">備貨統計</button>
              </div>

              <!-- Modal Body -->
              <div class="flex-1 overflow-y-auto px-6 py-5">

                <!-- 基本資訊 tab -->
                <div v-if="detailModalTab === 'info'">
                  <!-- 唯讀模式 -->
                  <template v-if="!detailInfoEditing">
                    <div class="flex justify-end mb-4">
                      <button @click="detailInfoEditing = true" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-stone-100 text-stone-600 rounded-lg text-xs font-bold hover:bg-stone-200 transition">
                        <i class="fas fa-edit"></i>編輯
                      </button>
                    </div>
                    <!-- 資訊列表 -->
                    <div class="divide-y divide-stone-100">
                      <div class="grid grid-cols-2 py-3">
                        <div>
                          <p class="text-xs text-stone-400 font-medium mb-0.5">公司名稱</p>
                          <p class="text-sm font-semibold text-stone-800">{{ detailModalOrder.companyName || '-' }}</p>
                        </div>
                        <div>
                          <p class="text-xs text-stone-400 font-medium mb-0.5">聯絡人</p>
                          <p class="text-sm font-semibold text-stone-800">{{ detailModalOrder.contactName || '-' }}</p>
                        </div>
                      </div>
                      <div class="grid grid-cols-2 py-3">
                        <div>
                          <p class="text-xs text-stone-400 font-medium mb-0.5">電話</p>
                          <p class="text-sm font-semibold text-stone-800">{{ detailModalOrder.contactPhone || '-' }}</p>
                        </div>
                        <div>
                          <p class="text-xs text-stone-400 font-medium mb-0.5">配送時間</p>
                          <p class="text-sm font-semibold text-stone-800">{{ detailModalOrder.deliveryTime ? new Date(detailModalOrder.deliveryTime.seconds * 1000).toLocaleString('zh-TW') : '-' }}</p>
                        </div>
                      </div>
                      <div v-if="detailModalOrder.address" class="py-3">
                        <p class="text-xs text-stone-400 font-medium mb-0.5">地址</p>
                        <p class="text-sm font-semibold text-stone-800">{{ detailModalOrder.address }}</p>
                      </div>
                    </div>
                    <!-- 總金額 -->
                    <div v-if="groupTotalAmountMap[detailModalOrder.id] > 0" class="mt-4 flex items-center justify-between bg-stone-50 rounded-xl px-4 py-3 border border-stone-100">
                      <span class="text-sm text-stone-500 font-medium">總金額</span>
                      <span class="text-2xl font-black text-stone-900">${{ groupTotalAmountMap[detailModalOrder.id].toLocaleString() }}</span>
                    </div>
                  </template>
                  <!-- 編輯模式 -->
                  <template v-else>
                    <div class="space-y-3">
                      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                          <label class="text-xs font-bold text-stone-400 mb-1 block">公司名稱</label>
                          <input v-model="editFormData.companyName" type="text" class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-stone-50 focus:bg-white transition">
                        </div>
                        <div>
                          <label class="text-xs font-bold text-stone-400 mb-1 block">聯絡人</label>
                          <input v-model="editFormData.contactName" type="text" class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-stone-50 focus:bg-white transition">
                        </div>
                        <div>
                          <label class="text-xs font-bold text-stone-400 mb-1 block">聯絡電話</label>
                          <input v-model="editFormData.contactPhone" type="text" class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-stone-50 focus:bg-white transition">
                        </div>
                        <div>
                          <label class="text-xs font-bold text-stone-400 mb-1 block">配送時間</label>
                          <input v-model="editFormData.deliveryTime" type="datetime-local" class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-stone-50 focus:bg-white transition">
                        </div>
                      </div>
                      <div>
                        <label class="text-xs font-bold text-stone-400 mb-1 block">配送地址</label>
                        <input v-model="editFormData.address" type="text" class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-stone-50 focus:bg-white transition">
                      </div>
                      <div>
                        <label class="text-xs font-bold text-stone-400 mb-1 block">狀態</label>
                        <select v-model="editFormData.status" class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-stone-50">
                          <option value="pending">待審核</option>
                          <option value="approved">已接單</option>
                          <option value="rejected">已拒絕</option>
                        </select>
                      </div>
                      <div class="flex gap-2 pt-1">
                        <button @click="saveBasicInfo" class="px-4 py-2 bg-stone-800 text-white rounded-lg text-sm font-bold hover:bg-stone-900 transition"><i class="fas fa-save mr-1.5"></i>保存</button>
                        <button @click="detailInfoEditing = false" class="px-4 py-2 bg-stone-100 text-stone-600 rounded-lg text-sm font-bold hover:bg-stone-200 transition">取消</button>
                      </div>
                    </div>
                  </template>
                </div>

                <!-- 訂單明細 tab -->
                <div v-if="detailModalTab === 'orders'">
                  <div v-if="loadingGroupOrders" class="text-center py-10"><i class="fas fa-circle-notch fa-spin text-2xl text-stone-300"></i></div>
                  <div v-else>
                    <!-- 操作列 -->
                    <div class="flex items-center justify-between mb-4">
                      <button @click="printSingleLabel(detailModalOrder)" :disabled="printingSingleId === detailModalOrder.id" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-stone-100 text-stone-600 rounded-lg text-xs font-bold hover:bg-stone-200 transition disabled:opacity-40"><i class="fas fa-print"></i>列印全部出貨單</button>
                      <button @click="addNewCustomerOrderInline" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-stone-800 text-white rounded-lg text-xs font-bold hover:bg-stone-900 transition"><i class="fas fa-plus"></i>新增訂購人</button>
                    </div>
                    <div v-if="groupOrders.length === 0 && !editingNewCustomerOrder" class="text-center py-10 text-stone-400 text-sm">暫無訂單數據</div>
                    <div class="space-y-2">
                      <div v-for="(customerOrder, idx) in groupOrders.slice().sort((a, b) => (b.createdAt && b.createdAt.seconds ? b.createdAt.seconds : 0) - (a.createdAt && a.createdAt.seconds ? a.createdAt.seconds : 0))" :key="customerOrder.id" class="rounded-xl border border-stone-100 overflow-hidden">
                        <!-- 唯讀 -->
                        <template v-if="editingCustomerOrderId !== customerOrder.id">
                          <!-- 訂購人標題列 -->
                          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between px-4 py-3 bg-stone-50 border-b border-stone-100 gap-2">
                            <div class="flex items-center justify-between sm:justify-start gap-2 min-w-0">
                              <div class="flex items-center gap-2 min-w-0">
                                <span class="font-bold text-stone-800 text-sm">{{ customerOrder.customerName }}</span>
                                <span v-if="customerOrder.customerUnit" class="text-xs text-stone-400 bg-stone-200 px-2 py-0.5 rounded-md flex-shrink-0">{{ customerOrder.customerUnit }}</span>
                              </div>
                              <span class="text-sm font-bold text-stone-700 flex-shrink-0 sm:hidden">${{ (customerOrder.totalAmount || 0).toLocaleString() }}</span>
                            </div>
                            <div class="flex items-center gap-1.5">
                              <span class="hidden sm:inline text-sm font-bold text-stone-700 mr-1">${{ (customerOrder.totalAmount || 0).toLocaleString() }}</span>
                              <button @click="printSingleCustomerLabel(customerOrder)" class="flex-1 sm:flex-none px-3 py-1 bg-stone-100 text-stone-700 rounded-lg border border-stone-200 text-xs font-bold hover:bg-stone-200 transition text-center" title="列印出貨單">印出貨單</button>
                              <button @click="startInlineEditCustomerOrder(customerOrder)" class="flex-1 sm:flex-none px-3 py-1 bg-stone-100 text-stone-700 rounded-lg border border-stone-200 text-xs font-bold hover:bg-stone-200 transition text-center" title="編輯">編輯</button>
                              <button @click="deleteCustomerOrder(customerOrder.id, idx)" class="flex-1 sm:flex-none px-3 py-1 bg-stone-100 text-stone-700 rounded-lg border border-stone-200 text-xs font-bold hover:bg-stone-200 transition text-center" title="刪除">刪除</button>
                            </div>
                          </div>
                          <!-- 品項列表 -->
                          <div class="px-4 py-2">
                            <div v-for="(item, iidx) in customerOrder.items" :key="iidx" class="flex justify-between items-center py-1.5 border-b border-stone-50 last:border-b-0 hover:bg-stone-50 transition">
                              <span class="text-sm text-stone-600">{{ item.itemName }}</span>
                              <span class="text-sm font-semibold text-stone-700 tabular-nums">× {{ item.qty }}</span>
                            </div>
                            <div v-if="customerOrder.note" class="mt-2 mb-1 text-xs text-stone-400 flex items-start gap-1.5"><i class="fas fa-comment-dots mt-0.5"></i>{{ customerOrder.note }}</div>
                          </div>
                        </template>
                        <!-- 編輯中 -->
                        <template v-else>
                          <div class="p-4 space-y-3 bg-stone-50">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                              <div>
                                <label class="text-xs font-bold text-stone-400 mb-1 block">訂購人</label>
                                <input v-model="editingCustomerOrderData.customerName" type="text" class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-white">
                              </div>
                              <div>
                                <label class="text-xs font-bold text-stone-400 mb-1 block">單位</label>
                                <input v-model="editingCustomerOrderData.customerUnit" type="text" placeholder="部門、公司..." class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-white">
                              </div>
                            </div>
                            <div>
                              <label class="text-xs font-bold text-stone-400 mb-2 block">訂購項目</label>
                              <div class="grid grid-cols-2 gap-x-3 gap-y-1.5">
                                <div v-for="(item, iidx) in editingCustomerOrderData.items" :key="iidx" class="flex items-center gap-1.5">
                                  <span class="flex-1 text-sm text-stone-700 truncate">{{ item.itemName }}</span>
                                  <div class="flex items-center border border-stone-200 rounded-lg overflow-hidden bg-white">
                                    <button type="button" @click="item.qty = Math.max(0, (item.qty || 0) - 1)" class="w-7 h-7 flex items-center justify-center text-stone-500 hover:bg-stone-100 active:bg-stone-200 transition text-base leading-none">−</button>
                                    <span class="w-7 text-center text-sm font-medium text-stone-800 select-none">{{ item.qty || 0 }}</span>
                                    <button type="button" @click="item.qty = (item.qty || 0) + 1" class="w-7 h-7 flex items-center justify-center text-stone-500 hover:bg-stone-100 active:bg-stone-200 transition text-base leading-none">+</button>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div>
                              <label class="text-xs font-bold text-stone-400 mb-1 block">備註</label>
                              <input v-model="editingCustomerOrderData.note" type="text" placeholder="不要辣、備品..." class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-white">
                            </div>
                            <div class="flex items-center gap-2 pt-1">
                              <button @click="saveInlineEditCustomerOrder(customerOrder.id, idx)" class="px-3 py-1.5 bg-stone-800 text-white rounded-lg text-xs font-bold hover:bg-stone-900 transition"><i class="fas fa-save mr-1"></i>保存</button>
                              <button @click="editingCustomerOrderId = null" class="px-3 py-1.5 bg-white border border-stone-200 text-stone-600 rounded-lg text-xs font-bold hover:bg-stone-100 transition">取消</button>
                              <button @click="deleteCustomerOrder(customerOrder.id, idx)" class="ml-auto px-3 py-1.5 bg-white border border-stone-200 text-stone-500 rounded-lg text-xs font-bold hover:bg-stone-100 transition"><i class="fas fa-trash-alt mr-1"></i>刪除</button>
                            </div>
                          </div>
                        </template>
                      </div>
                      <!-- 新增訂購人表單 -->
                      <div v-if="editingNewCustomerOrder" class="fixed inset-0 bg-black/30 z-50 flex items-center justify-center p-4 animate-fade-in" @click.self="editingNewCustomerOrder = false">
                        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 animate-zoom-in">
                          <h3 class="text-lg font-black text-stone-800 mb-4">新增訂單</h3>
                          <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                              <label class="text-xs font-bold text-stone-400 mb-1 block">訂購人</label>
                              <input v-model="newCustomerOrderData.customerName" type="text" class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-white">
                            </div>
                            <div>
                              <label class="text-xs font-bold text-stone-400 mb-1 block">單位</label>
                              <input v-model="newCustomerOrderData.customerUnit" type="text" placeholder="部門、公司..." class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-white">
                            </div>
                          </div>
                          <div class="mb-4">
                            <label class="text-xs font-bold text-stone-400 mb-2 block">訂購項目</label>
                            <div class="grid grid-cols-2 gap-x-6 gap-y-2">
                              <div v-for="(item, iidx) in newCustomerOrderData.items" :key="iidx" class="flex items-center justify-between gap-2">
                                <span class="flex-1 text-sm text-stone-700">{{ item.itemName }}</span>
                                <div class="flex items-center gap-1">
                                  <button type="button" @click="item.qty = Math.max(0, (item.qty || 0) - 1)" class="w-8 h-8 flex items-center justify-center text-stone-500 bg-stone-100 rounded font-bold text-lg hover:bg-stone-200">-</button>
                                  <span class="w-8 text-center text-sm font-medium text-stone-800 select-none">{{ item.qty || 0 }}</span>
                                  <button type="button" @click="item.qty = (item.qty || 0) + 1" class="w-8 h-8 flex items-center justify-center text-stone-500 bg-stone-100 rounded font-bold text-lg hover:bg-stone-200">+</button>
                                </div>
                              </div>
                            </div>
                          </div>
                          <div class="mb-4">
                            <label class="text-xs font-bold text-stone-400 mb-1 block">備註</label>
                            <input v-model="newCustomerOrderData.note" type="text" placeholder="不要辣、備品..." class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-white">
                          </div>
                          <div class="flex gap-2 justify-end mt-6">
                            <button @click="saveNewCustomerOrder" class="px-5 py-2 bg-stone-800 text-white rounded-lg text-sm font-bold hover:bg-black transition flex items-center gap-2"><i class="fas fa-check"></i>確定</button>
                            <button @click="editingNewCustomerOrder = false" class="px-5 py-2 bg-stone-100 text-stone-800 rounded-lg text-sm font-bold hover:bg-stone-200 transition flex items-center gap-2">取消</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 備貨統計 tab -->
                <div v-if="detailModalTab === 'stock'">
                  <div v-if="loadingGroupOrders" class="text-center py-10"><i class="fas fa-circle-notch fa-spin text-2xl text-stone-300"></i></div>
                  <div v-else-if="groupStock.length === 0" class="text-center py-10 text-stone-400 text-sm">暫無商品數據</div>
                  <div v-else>
                    <div class="flex justify-end mb-4">
                      <button @click="printSingleStock(detailModalOrder)" :disabled="printingSingleId === detailModalOrder.id" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-stone-100 text-stone-600 rounded-lg text-xs font-bold hover:bg-stone-200 transition disabled:opacity-40"><i class="fas fa-print"></i>列印備貨統計</button>
                    </div>
                    <div class="rounded-xl border border-stone-100 overflow-hidden">
                      <div v-for="stock in groupStock" :key="stock.name" class="flex items-center justify-between px-4 py-3 border-b border-stone-50 last:border-b-0 hover:bg-stone-50 transition">
                        <span class="text-sm text-stone-700">{{ stock.name }}</span>
                        <span class="text-sm font-bold text-stone-900 tabular-nums">{{ stock.quantity }}</span>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <!-- 新增訂單 Modal -->
          <div v-if="showCreateOrderModal" class="fixed inset-0 bg-black/40 z-50 flex items-center justify-center p-4 animate-fade-in" @click.self="showCreateOrderModal = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl max-h-[90vh] flex flex-col animate-zoom-in">
              <!-- Header -->
              <div class="flex items-center justify-between px-6 pt-5 pb-4">
                <h3 class="text-xl font-black text-stone-900">新增訂單</h3>
                <button @click="showCreateOrderModal = false" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-stone-100 text-stone-400 hover:text-stone-600 transition"><i class="fas fa-times text-sm"></i></button>
              </div>
              <!-- Tabs -->
              <div class="flex border-b border-stone-100 px-6">
                <button @click="createOrderTab = 'info'" :class="['px-4 py-2.5 text-sm font-bold border-b-2 transition -mb-px', createOrderTab === 'info' ? 'border-stone-800 text-stone-800' : 'border-transparent text-stone-400 hover:text-stone-600']">基本資訊</button>
                <button @click="createOrderTab = 'orders'" :class="['px-4 py-2.5 text-sm font-bold border-b-2 transition -mb-px', createOrderTab === 'orders' ? 'border-stone-800 text-stone-800' : 'border-transparent text-stone-400 hover:text-stone-600']">
                  訂購明細<span v-if="createOrderCustomers.length > 0" class="ml-1 bg-stone-800 text-white text-[10px] px-1.5 rounded-full">{{ createOrderCustomers.length }}</span>
                </button>
              </div>
              <!-- Body -->
              <div class="flex-1 overflow-y-auto px-6 py-5">
                <!-- 基本資訊 -->
                  <div v-if="createOrderTab === 'info'" class="space-y-3">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                      <div class="sm:col-span-2">
                        <label class="text-xs font-bold text-stone-400 mb-1 block">常用聯絡人</label>
                        <button type="button" @click="showContactPicker = true" class="w-full px-3 py-2 border border-stone-200 rounded-lg text-sm bg-stone-50 hover:bg-stone-100 transition text-left flex items-center justify-between gap-2">
                          <span :class="selectedContactId ? 'text-stone-800 font-bold' : 'text-stone-400'">
                            {{ selectedContactId ? (frequentContacts.find(c => c.id === selectedContactId) ? frequentContacts.find(c => c.id === selectedContactId).companyName + ' / ' + frequentContacts.find(c => c.id === selectedContactId).contactName : '請選擇') : '點擊選擇常用聯絡人...' }}
                          </span>
                          <i class="fas fa-address-book text-stone-400 flex-shrink-0"></i>
                        </button>
                      </div>
                      <div>
                        <label class="text-xs font-bold text-stone-400 mb-1 block">公司名稱 *</label>
                        <input v-model="createOrderForm.companyName" type="text" class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-stone-50 focus:bg-white transition">
                      </div>
                      <div>
                        <label class="text-xs font-bold text-stone-400 mb-1 block">聯絡人 *</label>
                        <input v-model="createOrderForm.contactName" type="text" class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-stone-50 focus:bg-white transition">
                      </div>
                      <div>
                        <label class="text-xs font-bold text-stone-400 mb-1 block">聯絡電話</label>
                        <input v-model="createOrderForm.contactPhone" type="text" class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-stone-50 focus:bg-white transition">
                      </div>
                      <div>
                        <label class="text-xs font-bold text-stone-400 mb-1 block">配送時間</label>
                        <input v-model="createOrderForm.deliveryTime" type="datetime-local" class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-stone-50 focus:bg-white transition">
                      </div>
                       <div>
                         <label class="text-xs font-bold text-stone-400 mb-1 block">來源</label>
                         <div class="flex gap-4 py-2">
                           <label class="inline-flex items-center gap-2">
                             <input type="radio" v-model="createOrderForm.resource" value="Line" class="accent-brand-600">
                             <span>Line</span>
                           </label>
                           <label class="inline-flex items-center gap-2">
                             <input type="radio" v-model="createOrderForm.resource" value="電話" class="accent-brand-600">
                             <span>電話</span>
                           </label>
                           <label class="inline-flex items-center gap-2">
                             <input type="radio" v-model="createOrderForm.resource" value="傳真" class="accent-brand-600">
                             <span>傳真</span>
                           </label>
                         </div>
                       </div>
                    </div>
                    <div>
                      <label class="text-xs font-bold text-stone-400 mb-1 block">配送地址</label>
                      <input v-model="createOrderForm.address" type="text" class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-stone-50 focus:bg-white transition">
                    </div>
                  </div>
                <!-- 訂購明細 -->
                <div v-if="createOrderTab === 'orders'">
                  <div class="flex items-center justify-between mb-4">
                    <span class="text-sm font-bold text-stone-500">共 {{ createOrderCustomers.length }} 位訂購人</span>
                    <button v-if="!addingCreateCustomer" @click="addingCreateCustomer = true" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-stone-800 text-white rounded-lg text-xs font-bold hover:bg-stone-900 transition"><i class="fas fa-plus"></i>新增訂購人</button>
                  </div>
                  <!-- 新增訂購人表單 -->
                  <div v-if="addingCreateCustomer" class="mb-4 p-4 bg-stone-50 rounded-xl border border-stone-200 space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                      <div>
                        <label class="text-xs font-bold text-stone-400 mb-1 block">訂購人 *</label>
                        <input v-model="newCreateCustomerData.customerName" type="text" class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-white">
                      </div>
                      <div>
                        <label class="text-xs font-bold text-stone-400 mb-1 block">單位</label>
                        <input v-model="newCreateCustomerData.customerUnit" type="text" placeholder="部門、公司..." class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-white">
                      </div>
                    </div>
                    <div>
                      <label class="text-xs font-bold text-stone-400 mb-2 block">訂購項目</label>
                      <div class="grid grid-cols-2 gap-x-3 gap-y-1.5">
                        <div v-for="(item, iidx) in newCreateCustomerData.items" :key="iidx" class="flex items-center gap-1.5">
                          <span class="flex-1 text-sm text-stone-700 truncate">{{ item.itemName }}</span>
                          <div class="flex items-center border border-stone-200 rounded-lg overflow-hidden bg-white">
                            <button type="button" @click="item.qty = Math.max(0, (item.qty || 0) - 1)" class="w-7 h-7 flex items-center justify-center text-stone-500 hover:bg-stone-100 text-base leading-none">−</button>
                            <span class="w-7 text-center text-sm font-medium text-stone-800 select-none">{{ item.qty || 0 }}</span>
                            <button type="button" @click="item.qty = (item.qty || 0) + 1" class="w-7 h-7 flex items-center justify-center text-stone-500 hover:bg-stone-100 text-base leading-none">+</button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div>
                      <label class="text-xs font-bold text-stone-400 mb-1 block">備註</label>
                      <input v-model="newCreateCustomerData.note" type="text" placeholder="不要辣、備品..." class="w-full px-3 py-2 border border-stone-200 rounded-lg focus:border-stone-400 outline-none text-sm bg-white">
                    </div>
                    <div class="flex gap-2">
                      <button @click="confirmAddCreateCustomer" class="px-3 py-1.5 bg-stone-800 text-white rounded-lg text-xs font-bold hover:bg-stone-900 transition">新增</button>
                      <button @click="addingCreateCustomer = false" class="px-3 py-1.5 bg-white border border-stone-200 text-stone-600 rounded-lg text-xs font-bold hover:bg-stone-100 transition">取消</button>
                    </div>
                  </div>
                  <!-- 訂購人清單 -->
                  <div v-if="createOrderCustomers.length === 0 && !addingCreateCustomer" class="text-center py-10 text-stone-400 text-sm">尚未新增訂購人</div>
                  <div class="space-y-2">
                    <div v-for="(customer, cidx) in createOrderCustomers" :key="cidx" class="rounded-xl border border-stone-100 overflow-hidden">
                      <div class="flex items-center justify-between px-4 py-3 bg-stone-50 border-b border-stone-100">
                        <div class="flex items-center gap-2">
                          <span class="font-bold text-stone-800 text-sm">{{ customer.customerName }}</span>
                          <span v-if="customer.customerUnit" class="text-xs text-stone-400 bg-stone-200 px-2 py-0.5 rounded-md">{{ customer.customerUnit }}</span>
                        </div>
                        <button @click="createOrderCustomers.splice(cidx, 1)" class="px-3 py-1 bg-stone-100 text-stone-700 rounded-lg border border-stone-200 text-xs font-bold hover:bg-stone-200 transition">刪除</button>
                      </div>
                      <div class="px-4 py-2">
                        <div v-for="(item, iidx) in customer.items.filter(i => i.qty > 0)" :key="iidx" class="flex justify-between items-center py-1.5 border-b border-stone-50 last:border-b-0">
                          <span class="text-sm text-stone-600">{{ item.itemName }}</span>
                          <span class="text-sm font-semibold text-stone-700">× {{ item.qty }}</span>
                        </div>
                        <div v-if="customer.note" class="mt-2 mb-1 text-xs text-stone-400"><i class="fas fa-comment-dots mr-1"></i>{{ customer.note }}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Footer -->
              <div class="flex gap-2 px-6 py-4 border-t border-stone-100">
                <button @click="saveCreateGroupOrder" :disabled="loading" class="flex-1 py-2.5 bg-stone-800 text-white rounded-xl text-sm font-bold hover:bg-black transition disabled:opacity-50"><i class="fas fa-save mr-1.5"></i>建立訂單</button>
                <button @click="showCreateOrderModal = false" class="px-5 py-2.5 bg-stone-100 text-stone-600 rounded-xl text-sm font-bold hover:bg-stone-200 transition">取消</button>
              </div>
            </div>
          </div>

        </div>

        <!-- 備貨統計 -->
        <div v-if="adminTab === 'stock'" class="space-y-4">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-black text-stone-800">備貨統計</h2>
            <button v-if="adminData.stockList.length > 0" @click="printStockLabels" class="no-print bg-stone-600 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-stone-700 transition shadow-lg flex items-center gap-2 whitespace-nowrap">
              <i class="fas fa-print"></i>列印備貨單
            </button>
          </div>
          <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-100 mb-6">
            <div class="flex flex-col gap-4">
              <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-1">
                  <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">起始日期</label>
                  <input type="date" v-model="stockStart" class="w-full px-4 py-2 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none">
                </div>
                <div class="flex-1">
                  <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">結束日期</label>
                  <input type="date" v-model="stockEnd" class="w-full px-4 py-2 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none">
                </div>
                <div class="flex-1">
                  <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">訂單狀態</label>
                  <select v-model="stockStatus" class="w-full px-4 py-2 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none bg-white">
                    <option value="all">全部</option>
                    <option value="pending">待審核</option>
                    <option value="approved">已接單</option>
                    <option value="rejected">已拒絕</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div v-if="loading" class="text-center py-20"><i class="fas fa-circle-notch fa-spin text-3xl text-stone-300"></i></div>
          <div v-else-if="adminData.stockList.length === 0" class="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-stone-200">
            <i class="fas fa-box-open text-6xl mb-4 text-stone-300"></i>
            <p class="font-bold text-stone-400">此日期範圍內沒有備貨資料</p>
          </div>
          <div v-else class="space-y-3">
            <div class="flex justify-between items-center px-2">
              <h3 class="font-bold text-stone-500 text-sm">備貨清單</h3>
              <span class="text-sm text-stone-400">共 {{ adminData.stockList.length }} 項產品</span>
            </div>

            <div v-for="item in adminData.stockList" :key="item.name" class="bg-white rounded-xl px-5 py-4 shadow-sm border border-stone-100 hover:shadow-md transition flex justify-between items-center">
              <span class="font-black text-stone-800">{{ item.name }}</span>
              <span class="text-lg font-black text-brand-600 tabular-nums">× {{ item.qty }}</span>
            </div>
          </div>
        </div>

        <div v-if="adminTab === 'labels'" class="space-y-4">
          <div class="mb-4">
            <h2 class="text-xl font-black text-stone-800 mb-3">出貨單</h2>
            <div class="flex flex-wrap items-center gap-2">
              <div class="flex items-center gap-1.5 flex-1 min-w-0">
                <label class="text-xs font-bold text-stone-400 whitespace-nowrap">起始</label>
                <input type="date" v-model="labelStart" class="flex-1 min-w-0 px-2 py-2 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none font-bold text-stone-700 text-sm">
              </div>
              <div class="flex items-center gap-1.5 flex-1 min-w-0">
                <label class="text-xs font-bold text-stone-400 whitespace-nowrap">結束</label>
                <input type="date" v-model="labelEnd" class="flex-1 min-w-0 px-2 py-2 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none font-bold text-stone-700 text-sm">
              </div>
              <button v-if="labelSelectedIds.length > 0" @click="printLabels" class="bg-green-600 text-white px-4 py-2 rounded-xl font-bold hover:bg-green-700 transition flex items-center gap-2 whitespace-nowrap shadow-lg text-sm">
                <i class="fas fa-print"></i>列印 ({{ labelSelectedIds.length }})
              </button>
            </div>
          </div>

          <div v-if="loading" class="text-center py-20"><i class="fas fa-circle-notch fa-spin text-3xl text-stone-300"></i></div>
          <div v-else-if="labelGroupsWithOrders.length === 0" class="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-stone-200">
            <i class="fas fa-file-invoice text-6xl mb-4 text-stone-300"></i>
            <p class="font-bold text-stone-400">該日期沒有已接單的訂單</p>
          </div>
          <div v-else class="space-y-3">
            <!-- 全選 bar -->
            <div class="bg-white rounded-2xl px-5 py-3 shadow-sm border border-stone-100 flex items-center justify-between">
              <label class="flex items-center gap-3 cursor-pointer select-none">
                <input type="checkbox" :checked="isAllLabelSelected" @change="toggleAllLabels" class="w-5 h-5 rounded accent-stone-800 cursor-pointer">
                <span class="font-bold text-stone-700">全選 / 全取消</span>
              </label>
              <span class="text-sm text-stone-500">{{ labelSelectedIds.length }} / {{ labelTotalOrderCount }} 張已勾選</span>
            </div>

            <!-- 每個 GroupOrder -->
            <div v-for="(group, gIdx) in labelGroupsWithOrders" :key="group.id"
              class="bg-white rounded-2xl shadow-sm border border-stone-200 overflow-hidden">
              <!-- Group 標題列 -->
              <div class="flex items-center gap-3 px-5 py-4 border-b border-stone-200 bg-stone-100">
                <input type="checkbox" :checked="isGroupAllSelected(group)" @change="toggleGroupLabels(group)" class="w-5 h-5 rounded accent-stone-800 cursor-pointer flex-shrink-0">
                <div class="flex-1 min-w-0">
                  <p class="font-black text-stone-800 truncate">{{ group.companyName }}</p>
                  <div class="flex flex-wrap gap-x-2 gap-y-0.5 mt-0.5">
                    <span class="text-xs text-stone-500"><i class="fas fa-truck mr-1"></i>{{ group.deliveryTime ? new Date(group.deliveryTime.seconds * 1000).toLocaleString('zh-TW', {month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}) : '-' }}</span>
                    <span class="text-xs text-stone-500"><i class="fas fa-user mr-1"></i>{{ group.contactName }}<span v-if="group.contactPhone"> {{ group.contactPhone }}</span></span>
                  </div>
                </div>
                <span class="text-xs font-bold text-stone-500 flex-shrink-0 bg-stone-200 px-2 py-1 rounded-lg">{{ group.orders.length }} 人</span>
              </div>

              <!-- 個人訂單 -->
              <div v-for="order in group.orders.slice().sort((a, b) => (b.createdAt && b.createdAt.seconds ? b.createdAt.seconds : 0) - (a.createdAt && a.createdAt.seconds ? a.createdAt.seconds : 0))" :key="order.id" class="flex items-start gap-3 px-5 py-3 border-b border-stone-50 last:border-b-0 hover:bg-stone-50/50 transition">
                <input type="checkbox" :checked="labelSelectedIds.includes(order.id)" @change="toggleLabel(order.id)" class="w-5 h-5 rounded accent-stone-800 cursor-pointer flex-shrink-0 mt-0.5">
                <div class="flex-1 min-w-0">
                  <p class="font-bold text-stone-800">
                    {{ order.customerName }}
                    <span v-if="order.customerUnit" class="text-xs font-normal text-stone-500 ml-1">({{ order.customerUnit }})</span>
                  </p>
                  <p class="text-xs text-stone-500 mt-0.5">
                    <span v-for="(item, i) in order.items" :key="i">
                      {{ item.itemName }} ×{{ item.qty }}<span v-if="i < order.items.length - 1">、</span>
                    </span>
                  </p>
                </div>
                <span class="text-sm font-black text-brand-600 flex-shrink-0">${{ order.totalAmount.toLocaleString() }}</span>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- 出貨單列印區 (平時隱藏，列印時顯示) -->
    <div id="label-print-area">
      <template v-for="orderId in labelSelectedIds" :key="orderId">
        <div v-for="info in getLabelInfo(orderId)" :key="info.orderId" :class="info.isFirstPage ? 'label-ticket' : 'label-ticket-cont'">
          <!-- 第1頁：完整標題；後續頁：精簡標題 -->
          <div v-if="info.isFirstPage" class="label-header">
            <div class="label-company">{{ info.companyName }}</div>
            <div class="label-delivery">配送：{{ info.deliveryTimeStr }}</div>
          </div>
          <div v-else class="label-cont-header">
            <div style="font-size:11pt;font-weight:bold;">{{ info.companyName }}</div>
            <div style="font-size:9pt;color:#555;">配送：{{ info.deliveryTimeStr }}</div>
          </div>
          <div style="margin-bottom:2mm; display:flex; justify-content:space-between; align-items:baseline;">
            <div class="label-customer">
              {{ info.customerName }}<span v-if="info.customerUnit" style="font-size:11pt;font-weight:normal">　{{ info.customerUnit }}</span>
            </div>
            <div v-if="info.totalPages > 1" class="label-page-num">{{ info.pageNum }}/{{ info.totalPages }}</div>
          </div>
          <div class="label-items">
            <div v-for="(item, i) in info.items" :key="i" class="label-item-row">
              <div class="label-item-name">{{ item.itemName }}</div>
              <div class="label-item-right">×{{ item.qty }}　${{ item.subtotal }}</div>
            </div>
          </div>
          <div v-if="info.isLastPage">
            <div v-if="info.note" class="label-note" style="color:#333; font-size:9pt; margin-top:0.3mm; padding-top:0.2mm; line-height:1.3;">備註：{{ info.note }}</div>
            <div class="label-total" style="font-size:15pt; font-weight:bold; text-align:right; margin-top:0.3mm;">合計 ${{ info.totalAmount }}</div>
          </div>
          <div style="border-top:2px solid #000; margin-top:1.2mm; margin-bottom:0.3mm;"></div>
          <div class="label-footer" style="display:flex; justify-content:space-between; align-items:center; font-size:8pt; color:#888; margin-top:0; border:none;">
            <div class="label-brand" style="margin:0; text-align:left;">健美滷味</div>
            <div class="label-page-num" style="margin:0; text-align:right;">{{ info.pageNum }}/{{ info.totalPages }}</div>
          </div>
        </div>
      </template>
    </div>

    <!-- 備貨單列印區 (75x100mm, 平時隱藏) -->
    <div id="stock-print-area">
      <div v-for="(chunk, ci) in stockPrintChunks" :key="ci" class="stock-ticket">
        <div class="stock-ticket-header">
          <div class="stock-ticket-title">健美滷味 備貨清單</div>
          <div class="stock-ticket-meta">{{ stockStart }}{{ stockStart !== stockEnd ? ' ~ ' + stockEnd : '' }}</div>
        </div>
        <div class="stock-ticket-items">
          <div v-for="item in chunk" :key="item.name" class="stock-ticket-row">
            <div class="stock-ticket-name">{{ item.name }}</div>
            <div class="stock-ticket-qty">× {{ item.qty }}</div>
          </div>
        </div>
        <div class="stock-ticket-footer">
          <span>健美滷味</span>
          <span>{{ ci + 1 }} / {{ stockPrintChunks.length }}</span>
        </div>
      </div>
    </div>

    <!-- 單筆出貨單列印區 -->
    <div id="single-label-print-area">
      <template v-if="singlePrintGroupData">
        <template v-for="order in singlePrintGroupData.orders" :key="order.id">
          <div v-for="info in getSingleLabelInfo(order)" :key="info.key" :class="info.isFirstPage ? 'label-ticket' : 'label-ticket-cont'">
            <div v-if="info.isFirstPage" class="label-header">
              <div class="label-company">{{ info.companyName }}</div>
              <div class="label-delivery">配送：{{ info.deliveryTimeStr }}</div>
            </div>
            <div v-else class="label-cont-header">
              <div style="font-size:11pt;font-weight:bold;">{{ info.companyName }}</div>
              <div style="font-size:9pt;color:#555;">配送：{{ info.deliveryTimeStr }}</div>
            </div>
            <div style="margin-bottom:2mm; display:flex; justify-content:space-between; align-items:baseline;">
              <div class="label-customer">{{ info.customerName }}<span v-if="info.customerUnit" style="font-size:11pt;font-weight:normal">　{{ info.customerUnit }}</span></div>
              <div v-if="info.totalPages > 1" class="label-page-num">{{ info.pageNum }}/{{ info.totalPages }}</div>
            </div>
            <div class="label-items">
              <div v-for="(item, i) in info.items" :key="i" class="label-item-row">
                <div class="label-item-name">{{ item.itemName }}</div>
                <div class="label-item-right">×{{ item.qty }}　${{ item.subtotal }}</div>
              </div>
            </div>
            <div v-if="info.isLastPage">
              <div v-if="info.note" class="label-note" style="color:#333; font-size:9pt; margin-top:0.3mm; padding-top:0.2mm; line-height:1.3;">備註：{{ info.note }}</div>
              <div class="label-total" style="font-size:15pt; font-weight:bold; text-align:right; margin-top:0.3mm;">合計 ${{ info.totalAmount }}</div>
            </div>
            <div style="border-top:2px solid #000; margin-top:1.2mm; margin-bottom:0.3mm;"></div>
            <div class="label-footer" style="display:flex; justify-content:space-between; align-items:center; font-size:8pt; color:#888; margin-top:0; border:none;">
              <div class="label-brand" style="margin:0; text-align:left;">健美滷味</div>
              <div class="label-page-num" style="margin:0; text-align:right;">{{ info.pageNum }}/{{ info.totalPages }}</div>
            </div>
          </div>
        </template>
      </template>
    </div>

    <!-- 單筆備料單列印區 -->
    <div id="single-stock-print-area">
      <div v-for="(chunk, ci) in singleStockChunks" :key="ci" class="stock-ticket">
        <div class="stock-ticket-header">
          <div class="stock-ticket-title">健美滷味 備料清單</div>
          <div class="stock-ticket-meta" v-if="singlePrintGroupData">{{ singlePrintGroupData.companyName }}　{{ singlePrintGroupData.deliveryTime ? new Date(singlePrintGroupData.deliveryTime.seconds * 1000).toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit'}) : '' }}</div>
        </div>
        <div class="stock-ticket-items">
          <div v-for="item in chunk" :key="item.name" class="stock-ticket-row">
            <div class="stock-ticket-name">{{ item.name }}</div>
            <div class="stock-ticket-qty">× {{ item.qty }}</div>
          </div>
        </div>
        <div class="stock-ticket-footer">
          <span>健美滷味</span>
          <span>{{ ci + 1 }} / {{ singleStockChunks.length }}</span>
        </div>
      </div>
    </div>

    <!-- 產品編輯對話框 -->
    <div v-if="showItemModal" class="fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-[60] flex items-center justify-center p-6">
      <div class="bg-white w-full max-w-lg rounded-[2rem] p-8 shadow-2xl max-h-[90vh] overflow-y-auto border border-white/20">
        <h3 class="text-xl font-black mb-6 text-stone-800">{{ editingItem.id ? '編輯產品' : '新增產品' }}</h3>
        
        <div class="space-y-4">
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">產品名稱 <span class="text-red-500">*</span></label>
            <input v-model="itemForm.name" type="text" placeholder="例如：蘋果、香蕉" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
          </div>
          
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">價格 <span class="text-red-500">*</span></label>
            <input v-model.number="itemForm.price" type="number" placeholder="0" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
          </div>
          
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">產品描述</label>
            <textarea v-model="itemForm.description" rows="3" placeholder="產品詳細說明..." class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700 resize-none"></textarea>
          </div>
        </div>
        
        <div class="flex gap-3 mt-8">
          <button @click="closeItemModal" class="flex-1 py-3 bg-stone-100 text-stone-500 rounded-xl font-bold hover:bg-stone-200 transition">
            取消
          </button>
          <button @click="saveItem" class="flex-1 py-3 bg-brand-600 text-white rounded-xl font-bold hover:bg-brand-700 shadow-lg shadow-brand-500/30 transition">
            {{ editingItem.id ? '更新資料' : '確認新增' }}
          </button>
        </div>
      </div>
    </div>

    <!-- 帳號編輯對話框 -->
    <div v-if="showAccountModal" class="fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-[60] flex items-center justify-center p-6">
      <div class="bg-white w-full max-w-lg rounded-[2rem] p-8 shadow-2xl max-h-[90vh] overflow-y-auto border border-white/20">
        <h3 class="text-xl font-black mb-6 text-stone-800">{{ editingAccount.id ? '編輯帳號' : '新增帳號' }}</h3>
        
        <div class="space-y-4">
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">帳號 <span class="text-red-500">*</span></label>
            <input v-model="accountForm.accountId" :disabled="!!editingAccount.id" type="text" placeholder="例如：admin、User001" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700 disabled:bg-stone-100 disabled:cursor-not-allowed">
          </div>
          
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">密碼 <span class="text-red-500">*</span></label>
            <input v-model="accountForm.password" type="text" placeholder="請輸入密碼" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
            <p class="text-xs text-stone-400 mt-1 ml-1">{{ editingAccount.id ? '留空表示不修改密碼' : '必填欄位' }}</p>
          </div>
          
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">姓名</label>
            <input v-model="accountForm.name" type="text" placeholder="真實姓名" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
          </div>
          
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">電話</label>
            <input v-model="accountForm.phone" type="tel" placeholder="0912-345-678" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
          </div>
          
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">Email</label>
            <input v-model="accountForm.email" type="email" placeholder="example@email.com" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
          </div>
          
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">權限身份 <span class="text-red-500">*</span></label>
            <select v-model="accountForm.role" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
              <option value="user">一般使用者</option>
              <option value="admin">管理者</option>
            </select>
          </div>
        </div>
        
        <div class="flex gap-3 mt-8">
          <button @click="closeAccountModal" class="flex-1 py-3 bg-stone-100 text-stone-500 rounded-xl font-bold hover:bg-stone-200 transition">
            取消
          </button>
          <button @click="saveAccount" class="flex-1 py-3 bg-brand-600 text-white rounded-xl font-bold hover:bg-brand-700 shadow-lg shadow-brand-500/30 transition">
            {{ editingAccount.id ? '更新資料' : '確認新增' }}
          </button>
        </div>
      </div>
    </div>

    <!-- 常用聯絡人選擇 Picker -->
    <div v-if="showContactPicker" class="fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-[70] flex items-center justify-center p-4 animate-fade-in" @click.self="showContactPicker = false">
      <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl flex flex-col max-h-[80vh] animate-zoom-in">
        <div class="flex items-center justify-between px-6 pt-5 pb-3 border-b border-stone-100">
          <h3 class="text-lg font-black text-stone-900">選擇常用聯絡人</h3>
          <button @click="showContactPicker = false" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-stone-100 text-stone-400 hover:text-stone-600 transition"><i class="fas fa-times text-sm"></i></button>
        </div>
        <div class="px-4 py-3 border-b border-stone-100">
          <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-stone-300 text-sm"></i>
            <input v-model="contactPickerKeyword" type="text" placeholder="搜尋公司名稱、聯絡人..." class="w-full pl-9 pr-3 py-2 border border-stone-200 rounded-lg text-sm outline-none text-stone-700">
          </div>
        </div>
        <div class="flex-1 overflow-y-auto px-3 py-2">
          <div v-if="frequentContacts.length === 0" class="text-center py-10 text-stone-400 text-sm">尚無常用聯絡人</div>
          <div v-else-if="filteredContactPicker.length === 0" class="text-center py-10 text-stone-400 text-sm">找不到符合的聯絡人</div>
          <button v-for="contact in filteredContactPicker" :key="contact.id"
            @click="pickContact(contact)"
            :class="['w-full text-left px-4 py-3 rounded-xl transition mb-1 flex items-center gap-3', selectedContactId === contact.id ? 'bg-stone-800 text-white' : 'hover:bg-stone-50 text-stone-700']">
            <div :class="['w-10 h-10 rounded-lg flex items-center justify-center font-black text-base flex-shrink-0', selectedContactId === contact.id ? 'bg-white/20 text-white' : 'bg-brand-100 text-brand-700']">
              {{ contact.companyName ? contact.companyName.charAt(0) : '?' }}
            </div>
            <div class="min-w-0">
              <p class="font-bold text-sm truncate">{{ contact.companyName }}</p>
              <p :class="['text-xs truncate', selectedContactId === contact.id ? 'text-stone-300' : 'text-stone-400']">{{ contact.contactName }}<span v-if="contact.contactPhone"> · {{ contact.contactPhone }}</span></p>
            </div>
            <i v-if="selectedContactId === contact.id" class="fas fa-check ml-auto flex-shrink-0"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- 常用聯絡人 Modal -->
    <div v-if="showContactModal" class="fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-[60] flex items-center justify-center p-6">
      <div class="bg-white w-full max-w-lg rounded-[2rem] p-8 shadow-2xl max-h-[90vh] overflow-y-auto border border-white/20 animate-zoom-in">
        <h3 class="text-xl font-black mb-6 text-stone-800">{{ editingContact.id ? '編輯聯絡人' : '新增聯絡人' }}</h3>
        <div class="space-y-4">
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">公司名稱 <span class="text-red-500">*</span></label>
            <input v-model="contactForm.companyName" type="text" placeholder="例如：健美科技有限公司" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
          </div>
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">聯絡人 <span class="text-red-500">*</span></label>
            <input v-model="contactForm.contactName" type="text" placeholder="例如：王小明" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
          </div>
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">連絡電話</label>
            <input v-model="contactForm.contactPhone" type="tel" placeholder="0912-345-678" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
          </div>
          <div>
            <label class="text-xs font-bold text-stone-400 ml-1 mb-2 block">配送地址</label>
            <input v-model="contactForm.address" type="text" placeholder="台北市中正區XX路XX號" class="w-full p-3 bg-stone-50 border-2 border-stone-200 rounded-xl focus:border-brand-500 outline-none transition font-bold text-stone-700">
          </div>
        </div>
        <div class="flex gap-3 mt-8">
          <button @click="closeContactModal" class="flex-1 py-3 bg-stone-100 text-stone-500 rounded-xl font-bold hover:bg-stone-200 transition">取消</button>
          <button @click="saveContact" :disabled="loading" class="flex-1 py-3 bg-brand-600 text-white rounded-xl font-bold hover:bg-brand-700 shadow-lg shadow-brand-500/30 transition disabled:opacity-50">
            {{ editingContact.id ? '更新資料' : '確認新增' }}
          </button>
        </div>
      </div>
    </div>

    <!-- 自訂提示對話框 -->
    <div v-if="customAlert.show" class="fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-[100] flex items-center justify-center p-6 animate-fade-in">
      <div class="bg-white rounded-[2rem] p-8 max-w-sm w-full shadow-2xl relative border border-white overflow-hidden animate-zoom-in">
        <div :class="['absolute top-0 left-0 w-full h-2', customAlert.type === 'success' ? 'bg-green-500' : customAlert.type === 'error' ? 'bg-red-500' : 'bg-brand-500']"></div>
        <div class="flex flex-col items-center text-center">
          <div :class="['w-16 h-16 rounded-full flex items-center justify-center mb-4', customAlert.type === 'success' ? 'bg-green-100 text-red-800' : customAlert.type === 'error' ? 'bg-red-100 text-red-800' : 'bg-brand-100 text-brand-600']">
            <i :class="['text-2xl', customAlert.type === 'success' ? 'fas fa-check' : customAlert.type === 'error' ? 'fas fa-times' : 'fas fa-info']" :style="customAlert.type === 'success' ? 'color:#22c55e' : ''"></i>
          </div>
          <p class="font-bold text-lg text-stone-800 mb-6">{{ customAlert.message }}</p>
          <button @click="customAlert.show = false" class="w-full bg-stone-800 text-white py-3 rounded-xl font-bold hover:bg-black transition">
            確定
          </button>
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    import { createApp, ref, computed, watch, onMounted, onUnmounted, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, getDoc, doc, updateDoc, deleteDoc, query, where, setDoc, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDb3xTmnkscf9tC5znTBzkCfSzD0zLJTYk",
      authDomain: "jianmei-food-54760.firebaseapp.com",
      projectId: "jianmei-food-54760",
      storageBucket: "jianmei-food-54760.firebasestorage.app",
      messagingSenderId: "367136535654",
      appId: "1:367136535654:web:119d8cb066dfb378e1a9a7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    createApp({
      setup() {
                                // ...existing code...
                                // 定期自動查詢待審核訂單，並通知有新訂單
                                const lastReviewCount = ref(0);
                                let reviewInterval = null;
                                function showReviewNotification(newCount) {
                                  // 使用自訂美化彈窗
                                  customAlert.value = { show: true, message: `有 ${newCount} 筆新的待審核訂單！`, type: 'info' };
                                }
                                async function pollReviewList() {
                                  // 只在管理員介面才輪詢
                                  if (currentView.value !== 'admin') return;
                                  const prevCount = lastReviewCount.value;
                                  await fetchReviewList(true); // silent=true，不觸發 loading，避免閃爍
                                  const nowCount = adminData.value.reviewList.length;
                                  if (nowCount > prevCount && prevCount !== 0) {
                                    showReviewNotification(nowCount - prevCount);
                                  }
                                  lastReviewCount.value = nowCount;
                                }
                                onMounted(() => {
                                  // ...existing code...
                                  // 啟動定時查詢
                                  reviewInterval = setInterval(pollReviewList, 30000); // 每 30 秒查詢一次
                                });
                                // 離開時清除定時器
                                onUnmounted(() => {
                                  if (reviewInterval) clearInterval(reviewInterval);
                                });
                        // 批次匯出備貨單
                        const batchExportStock = async () => {
                          if (!selectedOrderIds.value.length) return;
                          // 取得所有選取訂單的 groupOrderId
                          const selectedOrders = adminData.value.detailsList.filter(o => selectedOrderIds.value.includes(o.id));
                          // 取得所有商品項目
                          const itemTotals = {};
                          for (const order of selectedOrders) {
                            const q = query(collection(db, 'Orders'), where('groupOrderId', '==', order.id));
                            const snap = await getDocs(q);
                            snap.docs.forEach(d => {
                              (d.data().items || []).forEach(item => {
                                if (item.itemName && parseInt(item.qty) > 0)
                                  itemTotals[item.itemName] = (itemTotals[item.itemName] || 0) + (parseInt(item.qty) || 0);
                              });
                            });
                          }
                          const items = Object.entries(itemTotals).map(([name, qty]) => ({ name, qty }));
                          if (!items.length) { showAlert('沒有備貨項目', 'error'); return; }
                          const size = 12;
                          stockPrintChunks.value = [];
                          for (let i = 0; i < items.length; i += size) stockPrintChunks.value.push(items.slice(i, i + size));
                          await nextTick();
                          const style = document.createElement('style');
                          style.id = 'stock-page-size';
                          style.textContent = '@page { size: 75mm 100mm; margin: 0; }';
                          document.head.appendChild(style);
                          document.body.classList.add('printing-stock');
                          setTimeout(() => {
                            window.print();
                            setTimeout(() => {
                              const s = document.getElementById('stock-page-size');
                              if (s) document.head.removeChild(s);
                              document.body.classList.remove('printing-stock');
                            }, 500);
                          }, 50);
                        };
                        // 批次匯出出貨單
                        const batchExportLabels = async () => {
                          if (!selectedOrderIds.value.length) return;
                          // 取得所有選取訂單的 groupOrderId
                          const selectedOrders = adminData.value.detailsList.filter(o => selectedOrderIds.value.includes(o.id));
                          const groups = [];
                          for (const order of selectedOrders) {
                            const q = query(collection(db, 'Orders'), where('groupOrderId', '==', order.id));
                            const snap = await getDocs(q);
                            const orders = snap.docs.map(d => {
                              const data = d.data(); let totalAmount = 0;
                              const items = (data.items || []).map(item => {
                                const price = labelPriceMap.value[item.itemName] || 0;
                                const qty = parseInt(item.qty) || 0;
                                totalAmount += price * qty; return item;
                              });
                              return { id: d.id, ...data, items, totalAmount };
                            }).sort((a, b) => (a.customerName || '').localeCompare(b.customerName || '', 'zh-TW'));
                            if (orders.length) groups.push({ ...order, orders });
                          }
                          if (!groups.length) { showAlert('沒有訂單資料', 'error'); return; }
                          labelGroupsWithOrders.value = groups;
                          labelSelectedIds.value = groups.flatMap(g => g.orders.map(o => o.id));
                          await nextTick();
                          const style = document.createElement('style');
                          style.id = 'label-page-size';
                          style.textContent = '@page { size: 75mm 100mm; margin: 0; }';
                          document.head.appendChild(style);
                          document.body.classList.add('printing-labels');
                          window.print();
                          setTimeout(() => {
                            const s = document.getElementById('label-page-size');
                            if (s) document.head.removeChild(s);
                            document.body.classList.remove('printing-labels');
                          }, 500);
                        };
                // 批次選取訂單
                const selectedOrderIds = ref([]);
                const isAllOrderSelected = computed(() => pagedDetailsList.value.length > 0 && selectedOrderIds.value.length === pagedDetailsList.value.length);
                const toggleOrderSelection = (orderId) => {
                  const idx = selectedOrderIds.value.indexOf(orderId);
                  if (idx === -1) selectedOrderIds.value.push(orderId);
                  else selectedOrderIds.value.splice(idx, 1);
                };
                const toggleAllOrderSelection = () => {
                  if (isAllOrderSelected.value) selectedOrderIds.value = [];
                  else selectedOrderIds.value = pagedDetailsList.value.map(o => o.id);
                };
        // 狀態管理
        const currentView = ref('login');
        const loading = ref(false);
        const showAdminMenu = ref(false);
        const adminTab = ref('accounts');
        const customAlert = ref({ show: false, message: '', type: 'info' });
        
        // 用戶資料
        const user = ref(null);
        const loginForm = ref({ id: '', pass: '' });
        
        // Admin 資料
        const adminData = ref({
          accountsList: [],
          itemsList: [],
          reviewList: [],
          detailsList: [],
          stockList: [],
          labelList: []
        });
        
        // 團購訂單展開狀態
        const expandedOrdersGroupId = ref(null);
        const expandedStockGroupId = ref(null);
        const groupOrders = ref([]);
        const groupStock = ref([]);
        const groupTotalAmount = ref(0);
        const loadingGroupOrders = ref(false);
        const groupTotalAmountMap = ref({}); // 儲存每個訂單的總金額
        
        // 訂單編輯狀態
        const editingOrderId = ref(null);
        const editFormData = ref({});
        const editOrdersList = ref([]);
        const showEditModal = ref(false);

        // 詳細資訊 Modal
        const detailModalOrder = ref(null);
        const detailModalTab = ref('info');
        const detailInfoEditing = ref(false);
        const editingCustomerOrderId = ref(null);
        const editingCustomerOrderData = ref({ customerName: '', customerUnit: '', note: '', items: [] });
        const editingNewCustomerOrder = ref(false);
        const newCustomerOrderData = ref({ customerName: '', customerUnit: '', note: '', items: [{ itemName: '', qty: null }] });

        // 新增訂單 Modal
        const showCreateOrderModal = ref(false);
        const createOrderTab = ref('info');
        const createOrderForm = ref({ companyName: '', contactName: '', contactPhone: '', address: '', deliveryTime: '' });
        const createOrderCustomers = ref([]);
        const addingCreateCustomer = ref(false);
        const newCreateCustomerData = ref({ customerName: '', customerUnit: '', note: '', items: [] });

        const openCreateOrderModal = async () => {
          if (adminData.value.itemsList.length === 0) await fetchAdminItems();
          if (frequentContacts.value.length === 0) await fetchFrequentContacts();
          createOrderForm.value = { companyName: '', contactName: '', contactPhone: '', address: '', deliveryTime: '', status: 'pending' };
          createOrderCustomers.value = [];
          addingCreateCustomer.value = false;
          createOrderTab.value = 'info';
          selectedContactId.value = '';
          newCreateCustomerData.value = { customerName: '', customerUnit: '', note: '', items: adminData.value.itemsList.map(i => ({ itemName: i.name, qty: 0 })) };
          showCreateOrderModal.value = true;
        };

        const confirmAddCreateCustomer = () => {
          const data = newCreateCustomerData.value;
          const validItems = data.items.filter(i => i.qty > 0);
          if (!data.customerName) { showAlert('請填寫訂購人', 'error'); return; }
          createOrderCustomers.value.push({
            customerName: data.customerName,
            customerUnit: data.customerUnit || '',
            note: data.note || '',
            items: validItems
          });
          newCreateCustomerData.value = { customerName: '', customerUnit: '', note: '', items: adminData.value.itemsList.map(i => ({ itemName: i.name, qty: 0 })) };
          addingCreateCustomer.value = false;
        };

        const saveCreateGroupOrder = async () => {
          const f = createOrderForm.value;
          if (!f.companyName || !f.contactName) { showAlert('請填寫公司名稱和聯絡人', 'error'); return; }
          loading.value = true;
          try {
            const groupData = {
              companyName: f.companyName,
              contactName: f.contactName,
              contactPhone: f.contactPhone || '',
              address: f.address || '',
              status: 'approved',
              createdAt: new Date(),
              updatedAt: new Date().toISOString(),
              updatedBy: user.value.id,
              approvedAt: new Date().toISOString(),
              approvedBy: user.value.id
            };
            if (f.deliveryTime) groupData.deliveryTime = new Date(f.deliveryTime);
            const groupRef = await addDoc(collection(db, 'GroupOrders'), groupData);
            for (const customer of createOrderCustomers.value) {
              await addDoc(collection(db, 'Orders'), {
                groupOrderId: groupRef.id,
                customerName: customer.customerName,
                customerUnit: customer.customerUnit || '',
                note: customer.note || '',
                items: customer.items,
                createdAt: new Date()
              });
            }
            showAlert('訂單建立成功', 'success');
            showCreateOrderModal.value = false;
            await fetchOrderDetails();
          } catch (e) {
            showAlert('建立失敗：' + e.message, 'error');
          } finally { loading.value = false; }
        };

        const openDetailModal = async (order, tab = 'info') => {
          detailModalOrder.value = order;
          detailModalTab.value = tab;
          detailInfoEditing.value = false;
          editingCustomerOrderId.value = null;
          editingNewCustomerOrder.value = false;
          editingOrderId.value = order.id;
          editFormData.value = {
            companyName: order.companyName || '',
            contactName: order.contactName || '',
            contactPhone: order.contactPhone || '',
            address: order.address || '',
            status: order.status || 'pending',
            deliveryTime: order.deliveryTime ? new Date(order.deliveryTime.seconds * 1000).toISOString().slice(0, 16) : ''
          };
          if (adminData.value.itemsList.length === 0) await fetchAdminItems();
          await fetchGroupOrders(order.id);
        };
        const closeDetailModal = () => {
          detailModalOrder.value = null;
          detailInfoEditing.value = false;
          editingCustomerOrderId.value = null;
          editingNewCustomerOrder.value = false;
          groupOrders.value = [];
          groupStock.value = [];
        };
        const saveAndCloseEdit = async () => {
          await saveEditOrder();
          showEditModal.value = false;
        };

        // 儲存基本資訊
        const saveBasicInfo = async () => {
          if (!editFormData.value.companyName || !editFormData.value.contactName) {
            showAlert('請填寫公司名稱和聯絡人', 'error');
            return;
          }
          loading.value = true;
          try {
            const groupDocRef = doc(db, 'GroupOrders', editingOrderId.value);
            const updateData = {
              companyName: editFormData.value.companyName,
              contactName: editFormData.value.contactName,
              contactPhone: editFormData.value.contactPhone,
              address: editFormData.value.address,
              status: editFormData.value.status,
              updatedAt: new Date().toISOString(),
              updatedBy: user.value.id
            };
            if (editFormData.value.deliveryTime) updateData.deliveryTime = new Date(editFormData.value.deliveryTime);
            if (editFormData.value.status === 'approved') { updateData.approvedAt = new Date().toISOString(); updateData.approvedBy = user.value.id; }
            else if (editFormData.value.status === 'rejected') { updateData.rejectedAt = new Date().toISOString(); updateData.rejectedBy = user.value.id; }
            await updateDoc(groupDocRef, updateData);
            // 更新 detailModalOrder 居所值
            detailModalOrder.value = {
              ...detailModalOrder.value,
              companyName: editFormData.value.companyName,
              contactName: editFormData.value.contactName,
              contactPhone: editFormData.value.contactPhone,
              address: editFormData.value.address,
              status: editFormData.value.status,
              deliveryTime: editFormData.value.deliveryTime ? { seconds: Math.floor(new Date(editFormData.value.deliveryTime).getTime() / 1000) } : detailModalOrder.value.deliveryTime
            };
            detailInfoEditing.value = false;
            showAlert('儲存成功', 'success');
            fetchOrderDetails();
          } catch (e) {
            showAlert('儲存失敗：' + e.message, 'error');
          } finally { loading.value = false; }
        };

        // inline 編輯協訂單
        const startInlineEditCustomerOrder = (customerOrder) => {
          editingCustomerOrderId.value = customerOrder.id;
          const existingQtyMap = {};
          (customerOrder.items || []).forEach(i => { existingQtyMap[i.itemName] = i.qty; });
          editingCustomerOrderData.value = {
            customerName: customerOrder.customerName || '',
            customerUnit: customerOrder.customerUnit || '',
            note: customerOrder.note || '',
            items: adminData.value.itemsList.map(p => ({ itemName: p.name, qty: existingQtyMap[p.name] || null }))
          };
        };

        const saveInlineEditCustomerOrder = async (orderId, idx) => {
          const data = editingCustomerOrderData.value;
          const validItems = data.items.filter(i => i.itemName && i.qty > 0);
          if (!data.customerName) { showAlert('請填寫訂購人', 'error'); return; }
          loading.value = true;
          try {
            await updateDoc(doc(db, 'Orders', orderId), {
              customerName: data.customerName,
              customerUnit: data.customerUnit || '',
              note: data.note || '',
              items: validItems,
              updatedAt: new Date().toISOString()
            });
            // 重新計算金額
            const priceMap = {};
            adminData.value.itemsList.forEach(item => { priceMap[item.name] = item.price || 0; });
            const newTotal = validItems.reduce((s, i) => s + (priceMap[i.itemName] || 0) * (parseInt(i.qty) || 0), 0);
            groupOrders.value[idx] = { ...groupOrders.value[idx], customerName: data.customerName, customerUnit: data.customerUnit, note: data.note, items: validItems, totalAmount: newTotal };
            editingCustomerOrderId.value = null;
            showAlert('已更新', 'success');
            // 重新計算總金額
            const total = groupOrders.value.reduce((s, o) => s + (o.totalAmount || 0), 0);
            groupTotalAmountMap.value = { ...groupTotalAmountMap.value, [detailModalOrder.value.id]: total };
          } catch (e) { showAlert('儲存失敗：' + e.message, 'error'); }
          finally { loading.value = false; }
        };

        const deleteCustomerOrder = async (orderId, idx) => {
          if (!confirm('確定要刪除此訂單嗎？')) return;
          loading.value = true;
          try {
            await deleteDoc(doc(db, 'Orders', orderId));
            groupOrders.value.splice(idx, 1);
            const total = groupOrders.value.reduce((s, o) => s + (o.totalAmount || 0), 0);
            groupTotalAmountMap.value = { ...groupTotalAmountMap.value, [detailModalOrder.value.id]: total };
            editingCustomerOrderId.value = null;
            showAlert('已刪除', 'success');
          } catch (e) { showAlert('刪除失敗：' + e.message, 'error'); }
          finally { loading.value = false; }
        };

        const addNewCustomerOrderInline = () => {
          newCustomerOrderData.value = {
            customerName: '',
            customerUnit: '',
            note: '',
            items: adminData.value.itemsList.map(p => ({ itemName: p.name, qty: null }))
          };
          editingNewCustomerOrder.value = true;
        };

        const saveNewCustomerOrder = async () => {
          const data = newCustomerOrderData.value;
          const validItems = data.items.filter(i => i.itemName && i.qty > 0);
          if (!data.customerName) { showAlert('請填寫訂購人', 'error'); return; }
          if (!validItems.length) { showAlert('請至少新增一個有效品項', 'error'); return; }
          loading.value = true;
          try {
            const priceMap = {};
            adminData.value.itemsList.forEach(item => { priceMap[item.name] = item.price || 0; });
            const newTotal = validItems.reduce((s, i) => s + (priceMap[i.itemName] || 0) * (parseInt(i.qty) || 0), 0);
            const newDocRef = await addDoc(collection(db, 'Orders'), {
              groupOrderId: detailModalOrder.value.id,
              customerName: data.customerName,
              customerUnit: data.customerUnit || '',
              note: data.note || '',
              items: validItems,
              createdAt: new Date()
            });
            groupOrders.value.push({ id: newDocRef.id, customerName: data.customerName, customerUnit: data.customerUnit, note: data.note, items: validItems, totalAmount: newTotal });
            const total = groupOrders.value.reduce((s, o) => s + (o.totalAmount || 0), 0);
            groupTotalAmountMap.value = { ...groupTotalAmountMap.value, [detailModalOrder.value.id]: total };
            editingNewCustomerOrder.value = false;
            showAlert('已新增', 'success');
          } catch (e) { showAlert('新增失敗：' + e.message, 'error'); }
          finally { loading.value = false; }
        };
        
        // 帳號管理
        const showAccountModal = ref(false);
        const showSettingsMenu = ref(false);

        // 常用聯絡人
        const frequentContacts = ref([]);
        const showContactModal = ref(false);
        const editingContact = ref({});
        const contactForm = ref({ companyName: '', contactName: '', contactPhone: '', address: '' });
        const selectedContactId = ref('');
        const showContactPicker = ref(false);
        const contactPickerKeyword = ref('');
        const editingAccount = ref({});
        const accountForm = ref({
          accountId: '',
          password: '',
          name: '',
          phone: '',
          email: '',
          role: 'user'
        });
        
        // 產品管理
        const showItemModal = ref(false);
        const editingItem = ref({});
        const itemForm = ref({
          name: '',
          price: 0,
          description: ''
        });
        const itemsSort = ref('createdAt-asc'); // 預設排序：建立時間從舊到新
        
        // 查詢及篩選
        const detailsStatus = ref('all');
        const detailsSort = ref('deliveryTime-desc');
        const detailsKeyword = ref('');
        const detailsPage = ref(1);
        const detailsPageSize = ref(parseInt(localStorage.getItem('detailsPageSize') || '10'));
        const detailsStart = ref('');
        const detailsEnd = ref('');
        const statusEditOrder = ref(null);
        const reviewSort = ref('createdAt-desc'); // 待審核排序
        const stockStart = ref('');
        const stockEnd = ref('');
        const stockStatus = ref('approved'); // 備貨統計狀態篩選
        const labelStart = ref('');
        const labelEnd = ref('');
        // 出貨單相關
        const labelGroupsWithOrders = ref([]); // [{id, companyName, deliveryTime, ..., orders:[{id, customerName, customerUnit, items, note, totalAmount}]}]
        const labelSelectedIds = ref([]); // 已勾選的個人訂單 ID
        const labelPriceMap = ref({});
        const stockPrintChunks = ref([]);

        // computed: 出貨單總筆數
        const labelTotalOrderCount = computed(() =>
          labelGroupsWithOrders.value.reduce((sum, g) => sum + g.orders.length, 0)
        );

        // computed: 是否全選
        const isAllLabelSelected = computed(() =>
          labelTotalOrderCount.value > 0 && labelSelectedIds.value.length === labelTotalOrderCount.value
        );

        // 取得指定 orderId 的列印資料
        const LABEL_ITEMS_PER_PAGE = 10; // 每頁最多顯示品項數（2欄×5列）
        const getLabelInfo = (orderId) => {
          for (const group of labelGroupsWithOrders.value) {
            const order = group.orders.find(o => o.id === orderId);
            if (order) {
              const allItems = order.items.map(item => ({
                itemName: item.itemName,
                qty: item.qty,
                subtotal: ((labelPriceMap.value[item.itemName] || 0) * (parseInt(item.qty) || 0)).toLocaleString()
              }));
              const pages = [];
              for (let i = 0; i < allItems.length; i += LABEL_ITEMS_PER_PAGE) {
                pages.push(allItems.slice(i, i + LABEL_ITEMS_PER_PAGE));
              }
              if (pages.length === 0) pages.push([]);
              const totalPages = pages.length;
              const deliveryTimeStr = group.deliveryTime
                ? new Date(group.deliveryTime.seconds * 1000).toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
                : '-';
              return pages.map((chunk, idx) => ({
                orderId: order.id + '_p' + idx,
                pageNum: idx + 1,
                totalPages,
                isFirstPage: idx === 0,
                isLastPage: idx === totalPages - 1,
                companyName: group.companyName,
                deliveryTimeStr,
                customerName: order.customerName,
                customerUnit: order.customerUnit || '',
                items: chunk,
                totalAmount: order.totalAmount.toLocaleString(),
                note: order.note || ''
              }));
            }
          }
          return [];
        };

        // 切換單張勾選
        const toggleLabel = (orderId) => {
          const idx = labelSelectedIds.value.indexOf(orderId);
          if (idx === -1) labelSelectedIds.value.push(orderId);
          else labelSelectedIds.value.splice(idx, 1);
        };

        // 判斷該 group 是否全選
        const isGroupAllSelected = (group) =>
          group.orders.length > 0 && group.orders.every(o => labelSelectedIds.value.includes(o.id));

        // 切換整個 group 的勾選狀態
        const toggleGroupLabels = (group) => {
          if (isGroupAllSelected(group)) {
            group.orders.forEach(o => {
              const idx = labelSelectedIds.value.indexOf(o.id);
              if (idx !== -1) labelSelectedIds.value.splice(idx, 1);
            });
          } else {
            group.orders.forEach(o => {
              if (!labelSelectedIds.value.includes(o.id)) labelSelectedIds.value.push(o.id);
            });
          }
        };

        // 全選 / 全取消
        const toggleAllLabels = () => {
          if (isAllLabelSelected.value) {
            labelSelectedIds.value = [];
          } else {
            const allIds = labelGroupsWithOrders.value.flatMap(g => g.orders.map(o => o.id));
            labelSelectedIds.value = allIds;
          }
        };

        // 列印選中的出貨單
        const printStockLabels = () => {
          const items = adminData.value.stockList;
          if (!items.length) return;
          const size = 12;
          stockPrintChunks.value = [];
          for (let i = 0; i < items.length; i += size) {
            stockPrintChunks.value.push(items.slice(i, i + size));
          }
          const style = document.createElement('style');
          style.id = 'stock-page-size';
          style.textContent = '@page { size: 75mm 100mm; margin: 0; }';
          document.head.appendChild(style);
          document.body.classList.add('printing-stock');
          setTimeout(() => {
            window.print();
            setTimeout(() => {
              const s = document.getElementById('stock-page-size');
              if (s) document.head.removeChild(s);
              document.body.classList.remove('printing-stock');
            }, 500);
          }, 50);
        };

        const printLabels = () => {
          // 動態加入 75x100mm 的列印樣式
          const style = document.createElement('style');
          style.id = 'label-page-size';
          style.textContent = '@page { size: 75mm 100mm; margin: 0; }';
          document.head.appendChild(style);
          document.body.classList.add('printing-labels');
          window.print();
          setTimeout(() => {
            const s = document.getElementById('label-page-size');
            if (s) document.head.removeChild(s);
            document.body.classList.remove('printing-labels');
          }, 500);
        };

        // 顯示提示訊息
        const showAlert = (message, type = 'info') => {
          customAlert.value = { show: true, message, type };
        };

        // 排序待審核列表
        const sortedReviewList = computed(() => {
          const list = [...adminData.value.reviewList];
          const [field, order] = reviewSort.value.split('-');
          
          return list.sort((a, b) => {
            let valA, valB;
            
            if (field === 'createdAt' || field === 'deliveryTime') {
              valA = a[field]?.seconds || 0;
              valB = b[field]?.seconds || 0;
            } else if (field === 'companyName') {
              valA = (a.companyName || '').toLowerCase();
              valB = (b.companyName || '').toLowerCase();
            }
            
            if (order === 'asc') {
              return valA > valB ? 1 : valA < valB ? -1 : 0;
            } else {
              return valA < valB ? 1 : valA > valB ? -1 : 0;
            }
          });
        });

        // 排序訂單列表
        const sortedDetailsList = computed(() => {
          const kw = detailsKeyword.value.trim().toLowerCase();
          let list = [...adminData.value.detailsList];
          // 關鍵字篩選
          if (kw) {
            list = list.filter(o =>
              (o.companyName || '').toLowerCase().includes(kw) ||
              (o.contactName || '').toLowerCase().includes(kw) ||
              (o.contactPhone || '').includes(kw) ||
              (o.address || '').toLowerCase().includes(kw)
            );
          }
          // 狀態篩選
          if (detailsStatus.value !== 'all') {
            list = list.filter(o => o.status === detailsStatus.value);
          }
          // 日期範圍篩選（依配送時間）
          if (detailsStart.value && detailsEnd.value) {
            const startMs = new Date(detailsStart.value + 'T00:00:00').getTime();
            const endMs   = new Date(detailsEnd.value   + 'T23:59:59').getTime();
            list = list.filter(o => {
              const t = o.deliveryTime?.seconds ? o.deliveryTime.seconds * 1000 : null;
              return t !== null && t >= startMs && t <= endMs;
            });
          }
          // 全部模式下排除已拒絕與已過期，需要時可切換篩選
          if (detailsStatus.value === 'all') {
            list = list.filter(o => o.status !== 'rejected' && o.status !== 'expired');
          }
          const [field, order] = detailsSort.value.split('-');
          return list.sort((a, b) => {
            let valA, valB;
            if (field === 'createdAt' || field === 'deliveryTime') {
              valA = a[field]?.seconds || 0;
              valB = b[field]?.seconds || 0;
            } else if (field === 'companyName') {
              valA = (a.companyName || '').toLowerCase();
              valB = (b.companyName || '').toLowerCase();
            }
            if (order === 'asc') return valA > valB ? 1 : valA < valB ? -1 : 0;
            else return valA < valB ? 1 : valA > valB ? -1 : 0;
          });
        });

        // Dashboard 金額計算
        const detailsApprovedTotal = computed(() =>
          sortedDetailsList.value.filter(o => o.status === 'approved')
            .reduce((sum, o) => sum + (groupTotalAmountMap.value[o.id] || 0), 0)
        );
        const detailsPendingTotal = computed(() =>
          sortedDetailsList.value.filter(o => o.status === 'pending')
            .reduce((sum, o) => sum + (groupTotalAmountMap.value[o.id] || 0), 0)
        );
        const detailsDashboardTotal = computed(() =>
          sortedDetailsList.value.filter(o => o.status !== 'rejected')
            .reduce((sum, o) => sum + (groupTotalAmountMap.value[o.id] || 0), 0)
        );
        // 訂單數統計
        const detailsOrderCount = computed(() =>
           sortedDetailsList.value.filter(o => o.status !== 'rejected').length
        );
        const detailsApprovedCount = computed(() =>
           sortedDetailsList.value.filter(o => o.status === 'approved').length
        );
        const detailsPendingCount = computed(() =>
           sortedDetailsList.value.filter(o => o.status === 'pending').length
        );

        // 分頁後的訂單列表
        const totalDetailsPages = computed(() => Math.max(1, Math.ceil(sortedDetailsList.value.length / detailsPageSize.value)));
        const pagedDetailsList = computed(() => {
          const start = (detailsPage.value - 1) * detailsPageSize.value;
          return sortedDetailsList.value.slice(start, start + detailsPageSize.value);
        });
        // 篩選/排序改變時重置頁碼
        watch([detailsSort, detailsStatus, detailsKeyword, detailsStart, detailsEnd], () => { detailsPage.value = 1; });

        const getTaiwanDateStr = (offsetDays = 0) => {
          const tzDate = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));
          if (offsetDays) tzDate.setDate(tzDate.getDate() + offsetDays);
          return tzDate.toISOString().slice(0, 10);
        };

        const isTodayFilter = computed(() => {
          const d = getTaiwanDateStr(0);
          return detailsStart.value === d && detailsEnd.value === d;
        });
        const isTomorrowFilter = computed(() => {
          const d = getTaiwanDateStr(1);
          return detailsStart.value === d && detailsEnd.value === d;
        });
        const setTodayFilter = () => {
          const d = getTaiwanDateStr(0);
          detailsStart.value = d;
          detailsEnd.value = d;
        };
        const setTomorrowFilter = () => {
          const d = getTaiwanDateStr(1);
          detailsStart.value = d;
          detailsEnd.value = d;
        };
        const setYesterdayFilter = () => {
          const d = getTaiwanDateStr(-1);
          detailsStart.value = d;
          detailsEnd.value = d;
        };
        const clearDetailsFilter = () => {
          detailsStart.value = '';
          detailsEnd.value = '';
          detailsKeyword.value = '';
          detailsStatus.value = 'all';
        };

        const filteredContactPicker = computed(() => {
          const kw = contactPickerKeyword.value.trim().toLowerCase();
          if (!kw) return frequentContacts.value;
          return frequentContacts.value.filter(c =>
            (c.companyName || '').toLowerCase().includes(kw) ||
            (c.contactName || '').toLowerCase().includes(kw) ||
            (c.contactPhone || '').toLowerCase().includes(kw)
          );
        });

        // 常用聯絡人 CRUD
        const fetchFrequentContacts = async () => {
          try {
            const snapshot = await getDocs(query(collection(db, 'FrequentContacts'), orderBy('companyName', 'asc')));
            frequentContacts.value = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
          } catch (e) {
            try {
              const snapshot2 = await getDocs(collection(db, 'FrequentContacts'));
              frequentContacts.value = snapshot2.docs.map(d => ({ id: d.id, ...d.data() }));
            } catch (e2) { console.error('獲取常用聯絡人錯誤:', e2); }
          }
        };
        const openAddContactModal = () => {
          editingContact.value = {};
          contactForm.value = { companyName: '', contactName: '', contactPhone: '', address: '' };
          showContactModal.value = true;
        };
        const editContact = (contact) => {
          editingContact.value = { ...contact };
          contactForm.value = { companyName: contact.companyName || '', contactName: contact.contactName || '', contactPhone: contact.contactPhone || '', address: contact.address || '' };
          showContactModal.value = true;
        };
        const closeContactModal = () => {
          showContactModal.value = false;
          editingContact.value = {};
          contactForm.value = { companyName: '', contactName: '', contactPhone: '', address: '' };
        };
        const saveContact = async () => {
          if (!contactForm.value.companyName || !contactForm.value.contactName) { showAlert('請填寫公司名稱和聯絡人', 'error'); return; }
          loading.value = true;
          try {
            const data = { companyName: contactForm.value.companyName, contactName: contactForm.value.contactName, contactPhone: contactForm.value.contactPhone || '', address: contactForm.value.address || '', updatedAt: new Date().toISOString() };
            if (editingContact.value.id) {
              await updateDoc(doc(db, 'FrequentContacts', editingContact.value.id), data);
              showAlert('聯絡人已更新', 'success');
            } else {
              data.createdAt = new Date().toISOString();
              await addDoc(collection(db, 'FrequentContacts'), data);
              showAlert('聯絡人已新增', 'success');
            }
            closeContactModal();
            await fetchFrequentContacts();
          } catch (e) { showAlert('儲存失敗：' + e.message, 'error'); }
          finally { loading.value = false; }
        };
        const deleteContact = async (contact) => {
          if (!confirm(`確定要刪除「${contact.companyName}」嗎？`)) return;
          loading.value = true;
          try {
            await deleteDoc(doc(db, 'FrequentContacts', contact.id));
            showAlert('已刪除', 'success');
            await fetchFrequentContacts();
          } catch (e) { showAlert('刪除失敗：' + e.message, 'error'); }
          finally { loading.value = false; }
        };
        const fillContactInfo = () => {
          const found = frequentContacts.value.find(c => c.id === selectedContactId.value);
          if (found) {
            createOrderForm.value.companyName = found.companyName;
            createOrderForm.value.contactName = found.contactName;
            createOrderForm.value.contactPhone = found.contactPhone || '';
            createOrderForm.value.address = found.address || '';
          }
        };
        const pickContact = (contact) => {
          selectedContactId.value = contact.id;
          createOrderForm.value.companyName = contact.companyName;
          createOrderForm.value.contactName = contact.contactName;
          createOrderForm.value.contactPhone = contact.contactPhone || '';
          createOrderForm.value.address = contact.address || '';
          showContactPicker.value = false;
          contactPickerKeyword.value = '';
        };

        // 獲取帳號列表
        const fetchAdminAccounts = async () => {
          loading.value = true;
          try {
            const q = query(collection(db, "Accounts"));
            const querySnapshot = await getDocs(q);
            adminData.value.accountsList = querySnapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
          } catch (error) {
            console.error('獲取帳號列表錯誤:', error);
            showAlert('獲取失敗', 'error');
          } finally {
            loading.value = false;
          }
        };
        
        // 打開新增帳號對話框
        const openAddAccountModal = () => {
          editingAccount.value = {};
          accountForm.value = {
            accountId: '',
            password: '',
            name: '',
            phone: '',
            email: '',
            role: 'user'
          };
          showAccountModal.value = true;
        };
        
        // 編輯帳號
        const editAccount = (account) => {
          editingAccount.value = { ...account };
          accountForm.value = {
            accountId: account.accountId || '',
            password: '',
            name: account.name || '',
            phone: account.phone || '',
            email: account.email || '',
            role: account.role || 'user'
          };
          showAccountModal.value = true;
        };
        
        // 關閉帳號對話框
        const closeAccountModal = () => {
          showAccountModal.value = false;
          editingAccount.value = {};
          accountForm.value = {
            accountId: '',
            password: '',
            name: '',
            phone: '',
            email: '',
            role: 'user'
          };
        };
        
        // 儲存帳號
        const saveAccount = async () => {
          if (!accountForm.value.accountId) {
            showAlert('請輸入帳號', 'error');
            return;
          }
          
          if (!editingAccount.value.id && !accountForm.value.password) {
            showAlert('請輸入密碼', 'error');
            return;
          }
          
          loading.value = true;
          try {
            const accountData = {
              accountId: accountForm.value.accountId,
              name: accountForm.value.name,
              phone: accountForm.value.phone,
              email: accountForm.value.email,
              role: accountForm.value.role || 'user',
              updatedAt: new Date().toISOString()
            };
            
            // 如果有輸入密碼，則更新密碼
            if (accountForm.value.password) {
              accountData.password = accountForm.value.password;
            }
            
            if (editingAccount.value.id) {
              // 更新現有帳號
              const docRef = doc(db, "Accounts", editingAccount.value.id);
              await updateDoc(docRef, accountData);
              showAlert('帳號更新成功！', 'success');
            } else {
              // 新增帳號 - 使用自動生成的文檔 ID
              accountData.createdAt = new Date().toISOString();
              await addDoc(collection(db, "Accounts"), accountData);
              showAlert('帳號新增成功！', 'success');
            }
            
            closeAccountModal();
            fetchAdminAccounts();
          } catch (error) {
            console.error('儲存帳號錯誤:', error);
            showAlert('儲存失敗：' + error.message, 'error');
          } finally {
            loading.value = false;
          }
        };
        
        // 刪除帳號
        const deleteAccount = async (account) => {
          if (account.accountId === 'ADMIN') {
            showAlert('無法刪除管理員帳號', 'error');
            return;
          }
          
          if (!confirm(`確定要刪除帳號「${account.name || account.accountId}」嗎？此操作無法復原。`)) {
            return;
          }
          
          loading.value = true;
          try {
            const docRef = doc(db, "Accounts", account.id);
            await deleteDoc(docRef);
            showAlert('帳號已刪除', 'success');
            fetchAdminAccounts();
          } catch (error) {
            console.error('刪除帳號錯誤:', error);
            showAlert('刪除失敗：' + error.message, 'error');
          } finally {
            loading.value = false;
          }
        };

        // 登入處理
        const handleLogin = async () => {
          if (!loginForm.value.id || !loginForm.value.pass) {
            showAlert('請輸入帳號和密碼', 'error');
            return;
          }
          
          loading.value = true;
          try {
            // 檢查是否為 ADMIN
            if (loginForm.value.id.toUpperCase() === 'ADMIN') {
              // 先檢查硬編碼的管理員密碼（備用方案）
              if (loginForm.value.pass === '8888') {
                user.value = { id: 'ADMIN', name: '系統管理員', role: 'admin' };
                currentView.value = 'admin';
                sessionStorage.setItem('user', JSON.stringify(user.value));
                sessionStorage.setItem('currentView', 'admin');
                showAlert('登入成功！', 'success');
                await fetchAdminAccounts();
                await fetchReviewList();
                adminTab.value = adminData.value.reviewList.length > 0 ? 'review' : 'details';
                sessionStorage.setItem('adminTab', adminTab.value);
              } else {
                // 如果不是硬編碼密碼，再查詢 Firebase
                try {
                  const docRef = doc(db, 'users', 'ADMIN');
                  const docSnap = await getDoc(docRef);
                  
                  if (docSnap.exists()) {
                    const userData = docSnap.data();
                    if (userData.password === loginForm.value.pass) {
                      user.value = { id: 'ADMIN', role: 'admin', ...userData };
                      currentView.value = 'admin';
                      sessionStorage.setItem('user', JSON.stringify(user.value));
                      sessionStorage.setItem('currentView', 'admin');
                      showAlert('登入成功！', 'success');
                      await fetchAdminAccounts();
                      await fetchReviewList();
                      adminTab.value = adminData.value.reviewList.length > 0 ? 'review' : 'details';
                      sessionStorage.setItem('adminTab', adminTab.value);
                    } else {
                      showAlert('密碼錯誤', 'error');
                    }
                  } else {
                    showAlert('密碼錯誤', 'error');
                  }
                } catch (fbError) {
                  console.error('Firebase查詢錯誤:', fbError);
                  showAlert('密碼錯誤', 'error');
                }
              }
            } else {
              // 查詢 Accounts collection
              const q = query(collection(db, 'Accounts'), where('accountId', '==', loginForm.value.id));
              const snap = await getDocs(q);
              if (snap.empty) {
                showAlert('帳號或密碼錯誤', 'error');
              } else {
                const accData = snap.docs[0].data();
                if (accData.password === loginForm.value.pass) {
                  user.value = { id: accData.accountId, name: accData.name || accData.accountId, role: accData.role || 'user', ...accData };
                  currentView.value = 'admin';
                  sessionStorage.setItem('user', JSON.stringify(user.value));
                  sessionStorage.setItem('currentView', 'admin');
                  showAlert('登入成功！', 'success');
                  if (user.value.role === 'admin') {
                    await fetchAdminAccounts();
                    await fetchReviewList();
                    if (adminData.value.reviewList.length > 0) {
                      adminTab.value = 'review';
                    } else {
                      adminTab.value = 'details';
                    }
                    sessionStorage.setItem('adminTab', adminTab.value);
                  } else {
                    adminTab.value = 'details';
                    sessionStorage.setItem('adminTab', adminTab.value);
                    fetchOrderDetails();
                  }
                } else {
                  showAlert('帳號或密碼錯誤', 'error');
                }
              }
            }
          } catch (error) {
            console.error('登入錯誤:', error);
            showAlert('登入失敗：' + error.message, 'error');
          } finally {
            loading.value = false;
          }
        };

        // 登出
        const logout = () => {
          user.value = null;
          currentView.value = 'login';
          sessionStorage.clear();
          loginForm.value = { id: '', pass: '' };
          showAlert('已登出', 'info');
        };

        // 獲取產品列表
        const fetchAdminItems = async () => {
          loading.value = true;
          try {
            // 解析排序設定
            const [field, direction] = itemsSort.value.split('-');
            const q = query(
              collection(db, "Items"),
              orderBy(field, direction)
            );
            const querySnapshot = await getDocs(q);
            adminData.value.itemsList = querySnapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
          } catch (error) {
            console.error('獲取產品列表錯誤:', error);
            showAlert('獲取失敗', 'error');
          } finally {
            loading.value = false;
          }
        };
        
        // 打開新增產品對話框
        const openAddItemModal = () => {
          editingItem.value = {};
          itemForm.value = {
            name: '',
            price: 0,
            description: ''
          };
          showItemModal.value = true;
        };
        
        // 編輯產品
        const editItem = (item) => {
          editingItem.value = { ...item };
          itemForm.value = {
            name: item.name || '',
            price: item.price || 0,
            description: item.description || ''
          };
          showItemModal.value = true;
        };
        
        // 關閉產品對話框
        const closeItemModal = () => {
          showItemModal.value = false;
          editingItem.value = {};
          itemForm.value = {
            name: '',
            price: 0,
            description: ''
          };
        };
        
        // 儲存產品
        const saveItem = async () => {
          if (!itemForm.value.name) {
            showAlert('請輸入產品名稱', 'error');
            return;
          }
          
          if (!itemForm.value.price || itemForm.value.price <= 0) {
            showAlert('請輸入有效價格', 'error');
            return;
          }
          
          loading.value = true;
          try {
            const itemData = {
              name: itemForm.value.name,
              price: itemForm.value.price,
              description: itemForm.value.description,
              updatedAt: new Date().toISOString()
            };
            
            if (editingItem.value.id) {
              // 更新現有產品
              const docRef = doc(db, "Items", editingItem.value.id);
              await updateDoc(docRef, itemData);
              showAlert('產品更新成功！', 'success');
            } else {
              // 新增產品
              itemData.createdAt = new Date().toISOString();
              await addDoc(collection(db, "Items"), itemData);
              showAlert('產品新增成功！', 'success');
            }
            
            closeItemModal();
            fetchAdminItems();
          } catch (error) {
            console.error('儲存產品錯誤:', error);
            showAlert('儲存失敗：' + error.message, 'error');
          } finally {
            loading.value = false;
          }
        };
        
        // 刪除產品
        const deleteItem = async (item) => {
          if (!confirm(`確定要刪除產品「${item.name}」嗎？此操作無法復原。`)) {
            return;
          }
          
          loading.value = true;
          try {
            const docRef = doc(db, "Items", item.id);
            await deleteDoc(docRef);
            showAlert('產品已刪除', 'success');
            fetchAdminItems();
          } catch (error) {
            console.error('刪除產品錯誤:', error);
            showAlert('刪除失敗：' + error.message, 'error');
          } finally {
            loading.value = false;
          }
        };

        // 獲取待審核列表
        const fetchReviewList = async (silent = false) => {
          if (!silent) loading.value = true;
          try {
            const q = query(
              collection(db, "GroupOrders"),
              where("status", "==", "pending"),
              orderBy("createdAt", "desc")
            );
            const querySnapshot = await getDocs(q);
            const now = Date.now();
            // 檢查並自動將已超過配送時間的待審核單子標記為已過期
            const expirePromises = [];
            const newList = [];
            querySnapshot.docs.forEach(d => {
              const data = d.data();
              const deliveryMs = data.deliveryTime?.seconds ? data.deliveryTime.seconds * 1000 : null;
              if (deliveryMs && deliveryMs < now) {
                // 配送時間已過，自動設為 expired
                expirePromises.push(updateDoc(doc(db, "GroupOrders", d.id), {
                  status: "expired",
                  expiredAt: new Date().toISOString()
                }));
              } else {
                newList.push({ id: d.id, ...data });
              }
            });
            if (expirePromises.length > 0) {
              await Promise.all(expirePromises);
              if (!silent) showAlert(`已將 ${expirePromises.length} 筆逾期訂單自動標記為已過期`, 'info');
            }
            // 只在資料有變動時才更新 reviewList，避免 UI 閃爍
            const oldIds = adminData.value.reviewList.map(o => o.id).join(',');
            const newIds = newList.map(o => o.id).join(',');
            if (oldIds !== newIds) {
              adminData.value.reviewList = newList;
              // 計算每個訂單的總金額
              for (const order of adminData.value.reviewList) {
                await calculateOrderTotal(order.id);
              }
            }
          } catch (error) {
            console.error('獲取待審核列表錯誤:', error);
            if (!silent) showAlert('獲取失敗', 'error');
          } finally {
            if (!silent) loading.value = false;
          }
        };

        // 確認團購
        const confirmGroup = async (group) => {
          if (!confirm(`確定要確認「${group.companyName}」嗎？`)) return;
          
          loading.value = true;
          try {
            const docRef = doc(db, "GroupOrders", group.id);
            await updateDoc(docRef, {
              status: "approved",
              approvedAt: new Date().toISOString(),
              approvedBy: user.value.id
            });
            showAlert('已確認團購', 'success');
            fetchReviewList();
          } catch (error) {
            console.error('確認團購錯誤:', error);
            showAlert('確認失敗', 'error');
          } finally {
            loading.value = false;
          }
        };

        // 駁回團購
        const rejectGroup = async (group) => {
          if (!confirm(`確定要拒絕「${group.companyName}」的接單嗎？`)) return;
          
          loading.value = true;
          try {
            const docRef = doc(db, "GroupOrders", group.id);
            await updateDoc(docRef, {
              status: "rejected",
              rejectedAt: new Date().toISOString(),
              rejectedBy: user.value.id
            });
            showAlert('已拒絕接單', 'success');
            fetchReviewList();
          } catch (error) {
            console.error('駁回團購錯誤:', error);
            showAlert('駁回失敗', 'error');
          } finally {
            loading.value = false;
          }
        };

        // 切換訂單明細
        const toggleOrders = async (groupId) => {
          if (expandedOrdersGroupId.value === groupId) {
            expandedOrdersGroupId.value = null;
            groupOrders.value = [];
          } else {
            expandedOrdersGroupId.value = groupId;
            expandedStockGroupId.value = null; // 關閉備貨統計
            await fetchGroupOrders(groupId);
          }
        };

        // 切換備貨統計
        const toggleStock = async (groupId) => {
          if (expandedStockGroupId.value === groupId) {
            expandedStockGroupId.value = null;
            groupStock.value = [];
          } else {
            expandedStockGroupId.value = groupId;
            expandedOrdersGroupId.value = null; // 關閉訂單明細
            await fetchGroupOrders(groupId);
          }
        };

        // 獲取團購訂單
        const fetchGroupOrders = async (groupId) => {
          loadingGroupOrders.value = true;
          try {
            // 確保產品列表已載入
            if (adminData.value.itemsList.length === 0) {
              await fetchAdminItems();
            }
            
            // 建立價格映射表
            const priceMap = {};
            adminData.value.itemsList.forEach(item => {
              priceMap[item.name] = item.price || 0;
            });
            
            const q = query(
              collection(db, "Orders"),
              where("groupOrderId", "==", groupId)
            );
            const querySnapshot = await getDocs(q);
            const orders = querySnapshot.docs.map(doc => {
              const orderData = doc.data();
              let orderTotal = 0;
              
              // 計算每個訂單的金額
              if (orderData.items && Array.isArray(orderData.items)) {
                orderData.items.forEach(item => {
                  const price = priceMap[item.itemName] || 0;
                  const qty = parseInt(item.qty) || 0;
                  orderTotal += price * qty;
                });
              }
              
              return {
                          // ...existing code...
                          lastReviewCount,
                id: doc.id,
                ...orderData,
                totalAmount: orderTotal
              };
            });
            
            groupOrders.value = orders;
            
            // 計算總金額
            groupTotalAmount.value = orders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
            
            // 儲存當前訂單的總金額
            groupTotalAmountMap.value = { ...groupTotalAmountMap.value, [groupId]: groupTotalAmount.value };
            
            // 計算備貨統計
            const stockMap = {};
            orders.forEach(order => {
              if (order.items && Array.isArray(order.items)) {
                order.items.forEach(item => {
                  const key = item.itemName;
                  if (!stockMap[key]) {
                    stockMap[key] = {
                      name: item.itemName,
                      quantity: 0
                    };
                  }
                  stockMap[key].quantity += parseInt(item.qty) || 0;
                });
              }
            });
            groupStock.value = Object.values(stockMap);
          } catch (error) {
            console.error('獲取訂單錯誤:', error);
            showAlert('獲取訂單失敗', 'error');
          } finally {
            loadingGroupOrders.value = false;
          }
        };

        // 計算單個訂單的總金額
        const calculateOrderTotal = async (groupId) => {
          try {
            // 確保產品列表已載入
            if (adminData.value.itemsList.length === 0) {
              await fetchAdminItems();
            }
            
            // 建立價格映射表
            const priceMap = {};
            adminData.value.itemsList.forEach(item => {
              priceMap[item.name] = item.price || 0;
            });
            
            const q = query(
              collection(db, "Orders"),
              where("groupOrderId", "==", groupId)
            );
            const querySnapshot = await getDocs(q);
            
            let totalAmount = 0;
            querySnapshot.docs.forEach(doc => {
              const orderData = doc.data();
              if (orderData.items && Array.isArray(orderData.items)) {
                orderData.items.forEach(item => {
                  const price = priceMap[item.itemName] || 0;
                  const qty = parseInt(item.qty) || 0;
                  totalAmount += price * qty;
                });
              }
            });
            
            // 儲存總金額
            groupTotalAmountMap.value = { ...groupTotalAmountMap.value, [groupId]: totalAmount };
          } catch (error) {
            console.error('計算訂單總金額錯誤:', error);
          }
        };

        // 更新訂單狀態
        const updateOrderStatus = async (order, newStatus) => {
          if (order.status === newStatus) return;
          loading.value = true;
          try {
            const docRef = doc(db, "GroupOrders", order.id);
            const updateData = {
              status: newStatus,
              updatedAt: new Date().toISOString(),
              updatedBy: user.value.id
            };
            
            // 根據新狀態添加對應的時間戳記
            if (newStatus === 'approved') {
              updateData.approvedAt = new Date().toISOString();
              updateData.approvedBy = user.value.id;
            } else if (newStatus === 'rejected') {
              updateData.rejectedAt = new Date().toISOString();
              updateData.rejectedBy = user.value.id;
            } else if (newStatus === 'expired') {
              updateData.expiredAt = new Date().toISOString();
            }
            
            await updateDoc(docRef, updateData);
            showAlert('狀態已更新', 'success');
            fetchOrderDetails();
          } catch (error) {
            console.error('更新訂單狀態錯誤:', error);
            showAlert('更新失敗', 'error');
            fetchOrderDetails();
          } finally {
            loading.value = false;
          }
        };
        
        // 開始編輯訂單
        const startEditOrder = async (order) => {
          editingOrderId.value = order.id;
          
          // 複製基本資料
          editFormData.value = {
            companyName: order.companyName || '',
            contactName: order.contactName || '',
            contactPhone: order.contactPhone || '',
            address: order.address || '',
            status: order.status || 'pending',
            deliveryTime: order.deliveryTime ? new Date(order.deliveryTime.seconds * 1000).toISOString().slice(0, 16) : ''
          };
          
          // 確保產品列表已載入
          if (adminData.value.itemsList.length === 0) {
            await fetchAdminItems();
          }
          
          // 載入訂單明細
          loadingGroupOrders.value = true;
          try {
            const q = query(
              collection(db, "Orders"),
              where("groupOrderId", "==", order.id)
            );
            const querySnapshot = await getDocs(q);
            editOrdersList.value = querySnapshot.docs.map(doc => ({
              id: doc.id,
              customerName: doc.data().customerName || '',
              customerUnit: doc.data().customerUnit || '',
              note: doc.data().note || '',
              items: doc.data().items || []
            }));
          } catch (error) {
            console.error('載入訂單明細錯誤:', error);
            showAlert('載入訂單明細失敗', 'error');
            editOrdersList.value = [];
          } finally {
            loadingGroupOrders.value = false;
          }
        };
        
        // 取消編輯
        const cancelEditOrder = () => {
          if (confirm('確定要取消編輯嗎？未保存的更改將會遺失。')) {
            editingOrderId.value = null;
            editFormData.value = {};
            editOrdersList.value = [];
          }
        };
        
        // 保存編輯
        const saveEditOrder = async () => {
          if (!editFormData.value.companyName || !editFormData.value.contactName) {
            showAlert('請填寫公司名稱和聯絡人', 'error');
            return;
          }
          
          if (!confirm('確定要保存所有更改嗎？')) return;
          
          loading.value = true;
          try {
            // 更新 GroupOrder
            const groupDocRef = doc(db, "GroupOrders", editingOrderId.value);
            const groupUpdateData = {
              companyName: editFormData.value.companyName,
              contactName: editFormData.value.contactName,
              contactPhone: editFormData.value.contactPhone,
              address: editFormData.value.address,
              status: editFormData.value.status,
              updatedAt: new Date().toISOString(),
              updatedBy: user.value.id
            };
            
            // 處理配送時間
            if (editFormData.value.deliveryTime) {
              groupUpdateData.deliveryTime = new Date(editFormData.value.deliveryTime);
            }
            
            // 根據狀態添加時間戳
            if (editFormData.value.status === 'approved') {
              groupUpdateData.approvedAt = new Date().toISOString();
              groupUpdateData.approvedBy = user.value.id;
            } else if (editFormData.value.status === 'rejected') {
              groupUpdateData.rejectedAt = new Date().toISOString();
              groupUpdateData.rejectedBy = user.value.id;
            }
            
            await updateDoc(groupDocRef, groupUpdateData);
            
            // 更新所有訂單
            for (const orderItem of editOrdersList.value) {
              // 過濾掉空的項目（沒有選擇品項或沒填數量）
              const validItems = orderItem.items.filter(item => 
                item.itemName && item.itemName.trim() !== '' && item.qty && item.qty > 0
              );
              
              // 如果沒有有效項目，跳過此訂單（如果是新訂單）或刪除（如果是現有訂單）
              if (validItems.length === 0) {
                if (orderItem.id) {
                  // 刪除現有訂單
                  await deleteDoc(doc(db, "Orders", orderItem.id));
                }
                continue;
              }
              
              if (orderItem.id) {
                // 更新現有訂單
                const orderDocRef = doc(db, "Orders", orderItem.id);
                await updateDoc(orderDocRef, {
                  customerName: orderItem.customerName,
                  customerUnit: orderItem.customerUnit || '',
                  note: orderItem.note || '',
                  items: validItems,
                  updatedAt: new Date().toISOString()
                });
              } else {
                // 新增訂單（只有有訂購人且有有效項目才新增）
                if (orderItem.customerName && orderItem.customerName.trim() !== '') {
                  await addDoc(collection(db, "Orders"), {
                    groupOrderId: editingOrderId.value,
                    customerName: orderItem.customerName,
                    customerUnit: orderItem.customerUnit || '',
                    note: orderItem.note || '',
                    items: validItems,
                    createdAt: new Date()
                  });
                }
              }
            }
            
            showAlert('保存成功', 'success');
            editingOrderId.value = null;
            editFormData.value = {};
            editOrdersList.value = [];
            fetchOrderDetails();
          } catch (error) {
            console.error('保存訂單錯誤:', error);
            showAlert('保存失敗：' + error.message, 'error');
          } finally {
            loading.value = false;
          }
        };
        
        // 新增訂單
        const addNewOrder = () => {
          editOrdersList.value.push({
            id: null,
            customerName: '',
            customerUnit: '',
            note: '',
            items: [{ itemName: '', qty: null }]
          });
        };
        
        // 移除訂單
        const removeOrder = async (idx) => {
          const orderItem = editOrdersList.value[idx];
          if (orderItem.id) {
            if (!confirm('確定要刪除此訂單嗎？此操作無法復原。')) return;
            try {
              await deleteDoc(doc(db, "Orders", orderItem.id));
              showAlert('訂單已刪除', 'success');
            } catch (error) {
              console.error('刪除訂單錯誤:', error);
              showAlert('刪除失敗', 'error');
              return;
            }
          }
          editOrdersList.value.splice(idx, 1);
        };
        
        // 新增訂單項目
        const addOrderItem = (orderIdx) => {
          editOrdersList.value[orderIdx].items.push({ 
            itemName: '', 
            qty: null 
          });
        };
        
        // 檢查品項是否已被選擇（用於禁用選項）
        const isItemSelected = (orderIdx, currentItemIdx, itemName) => {
          const currentItems = editOrdersList.value[orderIdx].items;
          return currentItems.some((item, idx) => idx !== currentItemIdx && item.itemName === itemName);
        };
        
        // 移除訂單項目
        const removeOrderItem = (orderIdx, itemIdx) => {
          editOrdersList.value[orderIdx].items.splice(itemIdx, 1);
        };

        // 獲取訂單詳情
        const fetchOrderDetails = async () => {
          loading.value = true;
          detailsPage.value = 1;
          try {
            let q;
            q = query(collection(db, "GroupOrders"), orderBy("deliveryTime", "desc"));
            
            const querySnapshot = await getDocs(q);
            adminData.value.detailsList = querySnapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            })).sort((a, b) => {
              // 先按 deliveryTime 降序，再按 createdAt 降序
              const deliveryDiff = (b.deliveryTime?.seconds || 0) - (a.deliveryTime?.seconds || 0);
              if (deliveryDiff !== 0) return deliveryDiff;
              return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
            });
            
            // 自动计算每个订单的总金额
            for (const order of adminData.value.detailsList) {
              await calculateOrderTotal(order.id);
            }
          } catch (error) {
            console.error('獲取訂單詳情錯誤:', error);
            showAlert('獲取失敗', 'error');
          } finally {
            loading.value = false;
          }
        };

        // 獲取備貨統計
        const fetchStockList = async () => {
          if (!stockStart.value || !stockEnd.value) {
            return; // 靜默返回，不顯示錯誤
          }
          
          loading.value = true;
          try {
            // 確保產品列表已載入
            if (adminData.value.itemsList.length === 0) {
              await fetchAdminItems();
            }
            
            // 將日期轉換為 Firestore Timestamp
            const startDate = new Date(stockStart.value);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(stockEnd.value);
            endDate.setHours(23, 59, 59, 999);
            
            const startTimestamp = Timestamp.fromDate(startDate);
            const endTimestamp = Timestamp.fromDate(endDate);
            
            // 查詢 GroupOrders
            let q;
            if (stockStatus.value === 'all') {
              q = query(
                collection(db, "GroupOrders"),
                where("deliveryTime", ">=", startTimestamp),
                where("deliveryTime", "<=", endTimestamp)
              );
            } else {
              q = query(
                collection(db, "GroupOrders"),
                where("deliveryTime", ">=", startTimestamp),
                where("deliveryTime", "<=", endTimestamp),
                where("status", "==", stockStatus.value)
              );
            }
            
            const groupOrdersSnapshot = await getDocs(q);
            const groupOrderIds = groupOrdersSnapshot.docs.map(doc => doc.id);
            
            if (groupOrderIds.length === 0) {
              adminData.value.stockList = [];
              return;
            }
            
            // 查詢所有相關的訂單（分批查詢，因為 Firestore in 查詢最多 10 個）
            const stockMap = {};
            
            // 分批處理，每次最多 10 個 ID
            for (let i = 0; i < groupOrderIds.length; i += 10) {
              const batchIds = groupOrderIds.slice(i, i + 10);
              const ordersQuery = query(
                collection(db, "Orders"),
                where("groupOrderId", "in", batchIds)
              );
              const ordersSnapshot = await getDocs(ordersQuery);
              
              ordersSnapshot.docs.forEach(doc => {
                const orderData = doc.data();
                if (orderData.items && Array.isArray(orderData.items)) {
                  orderData.items.forEach(item => {
                    const itemName = item.itemName;
                    const qty = parseInt(item.qty) || 0;
                    if (itemName) {
                      stockMap[itemName] = (stockMap[itemName] || 0) + qty;
                    }
                  });
                }
              });
            }
            
            // 轉換為陣列並排序
            adminData.value.stockList = Object.keys(stockMap)
              .map(name => ({
                name,
                qty: stockMap[name]
              }))
              .sort((a, b) => b.qty - a.qty); // 按數量降序排序
              
          } catch (error) {
            console.error('獲取備貨統計錯誤:', error);
            showAlert('獲取失敗：' + error.message, 'error');
            adminData.value.stockList = [];
          } finally {
            loading.value = false;
          }
        };

        // 獲取出貨單列表
        const fetchLabelOrders = async () => {
          if (!labelStart.value || !labelEnd.value) return;
          loading.value = true;
          labelGroupsWithOrders.value = [];
          labelSelectedIds.value = [];
          try {
            if (adminData.value.itemsList.length === 0) await fetchAdminItems();
            adminData.value.itemsList.forEach(item => { labelPriceMap.value[item.name] = item.price || 0; });
            const startDate = new Date(labelStart.value); startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(labelEnd.value); endDate.setHours(23, 59, 59, 999);
            const q = query(
              collection(db, "GroupOrders"),
              where("deliveryTime", ">=", Timestamp.fromDate(startDate)),
              where("deliveryTime", "<=", Timestamp.fromDate(endDate)),
              where("status", "==", "approved")
            );
            const groupSnap = await getDocs(q);
            const groups = groupSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            if (groups.length === 0) { labelGroupsWithOrders.value = []; return; }
            const result = [];
            for (let i = 0; i < groups.length; i += 10) {
              const batchIds = groups.slice(i, i + 10).map(g => g.id);
              const ordersQ = query(collection(db, "Orders"), where("groupOrderId", "in", batchIds));
              const ordersSnap = await getDocs(ordersQ);
              for (const gid of batchIds) {
                const group = groups.find(g => g.id === gid);
                const orders = ordersSnap.docs
                  .filter(d => d.data().groupOrderId === gid)
                  .map(d => {
                    const data = d.data(); let totalAmount = 0;
                    const items = (data.items || []).map(item => {
                      const price = labelPriceMap.value[item.itemName] || 0;
                      const qty = parseInt(item.qty) || 0;
                      totalAmount += price * qty; return item;
                    });
                    return { id: d.id, ...data, items, totalAmount };
                  })
                  .sort((a, b) => (a.customerName || '').localeCompare(b.customerName || '', 'zh-TW'));
                if (orders.length > 0) result.push({ ...group, orders });
              }
            }
            result.sort((a, b) => (a.deliveryTime?.seconds || 0) - (b.deliveryTime?.seconds || 0));
            labelGroupsWithOrders.value = result;
            labelSelectedIds.value = result.flatMap(g => g.orders.map(o => o.id));
          } catch (error) {
            console.error('獲取出貨單錯誤:', error);
            showAlert('獲取失敗：' + error.message, 'error');
          } finally { loading.value = false; }
        };

        // 監聽 adminTab 切換
        watch(adminTab, (newTab) => {
          // 保存當前標籤狀態
          sessionStorage.setItem('adminTab', newTab);
          
          if (newTab === 'accounts') {
            fetchAdminAccounts();
          } else if (newTab === 'items') {
            fetchAdminItems();
          } else if (newTab === 'review') {
            fetchReviewList();
          } else if (newTab === 'stock') {
            fetchStockList();
          } else if (newTab === 'labels') {
            fetchLabelOrders();
          }
        });

        // 監聽訂單篩選條件變化（detailsPageSize 不重置頁碼以避免迴圈）
        watch(detailsPageSize, (val) => {
          localStorage.setItem('detailsPageSize', val);
        });

        const sortByField = (field) => {
          if (detailsSort.value === field + '-desc') {
            detailsSort.value = field + '-asc';
          } else {
            detailsSort.value = field + '-desc';
          }
        };

        // ── 單筆列印 ──
        const singlePrintGroupData = ref(null);
        const singleStockChunks = ref([]);
        const printingSingleId = ref(null);
        const SINGLE_LABEL_PER_PAGE = 10;

        const getSingleLabelInfo = (order) => {
          if (!singlePrintGroupData.value) return [];
          const group = singlePrintGroupData.value;
          const allItems = order.items.map(item => ({
            itemName: item.itemName,
            qty: item.qty,
            subtotal: ((labelPriceMap.value[item.itemName] || 0) * (parseInt(item.qty) || 0)).toLocaleString()
          }));
          const pages = [];
          for (let i = 0; i < allItems.length; i += SINGLE_LABEL_PER_PAGE) pages.push(allItems.slice(i, i + SINGLE_LABEL_PER_PAGE));
          if (pages.length === 0) pages.push([]);
          const totalPages = pages.length;
          const deliveryTimeStr = group.deliveryTime
            ? new Date(group.deliveryTime.seconds * 1000).toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
            : '-';
          return pages.map((chunk, idx) => ({
            key: order.id + '_p' + idx, pageNum: idx + 1, totalPages,
            isFirstPage: idx === 0, isLastPage: idx === totalPages - 1,
            companyName: group.companyName, deliveryTimeStr,
            customerName: order.customerName, customerUnit: order.customerUnit || '',
            items: chunk, totalAmount: order.totalAmount.toLocaleString(), note: order.note || ''
          }));
        };

        const _fetchSubOrders = async (groupOrder) => {
          if (adminData.value.itemsList.length === 0) await fetchAdminItems();
          adminData.value.itemsList.forEach(item => { labelPriceMap.value[item.name] = item.price || 0; });
          const q = query(collection(db, 'Orders'), where('groupOrderId', '==', groupOrder.id));
          const snap = await getDocs(q);
          return snap.docs.map(doc => {
            const data = doc.data(); let totalAmount = 0;
            const items = (data.items || []).map(item => {
              const price = labelPriceMap.value[item.itemName] || 0;
              const qty = parseInt(item.qty) || 0;
              totalAmount += price * qty; return item;
            });
            return { id: doc.id, ...data, items, totalAmount };
          }).sort((a, b) => (a.customerName || '').localeCompare(b.customerName || '', 'zh-TW'));
        };

        const printSingleLabel = async (groupOrder) => {
          printingSingleId.value = groupOrder.id;
          try {
            const orders = await _fetchSubOrders(groupOrder);
            singlePrintGroupData.value = { ...groupOrder, orders };
            await nextTick();
            const style = document.createElement('style');
            style.id = 'single-label-page-size';
            style.textContent = '@page { size: 75mm 100mm; margin: 0; }';
            document.head.appendChild(style);
            document.body.classList.add('printing-single-label');
            window.print();
            setTimeout(() => {
              const s = document.getElementById('single-label-page-size');
              if (s) document.head.removeChild(s);
              document.body.classList.remove('printing-single-label');
            }, 500);
          } finally { printingSingleId.value = null; }
        };

        const printSingleCustomerLabel = async (customerOrder) => {
          if (adminData.value.itemsList.length === 0) await fetchAdminItems();
          adminData.value.itemsList.forEach(item => { labelPriceMap.value[item.name] = item.price || 0; });
          let totalAmount = 0;
          const items = (customerOrder.items || []).map(item => {
            const price = labelPriceMap.value[item.itemName] || 0;
            const qty = parseInt(item.qty) || 0;
            totalAmount += price * qty;
            return item;
          });
          const order = { ...customerOrder, items, totalAmount };
          singlePrintGroupData.value = { ...detailModalOrder.value, orders: [order] };
          await nextTick();
          const existing = document.getElementById('single-label-page-size');
          if (!existing) {
            const style = document.createElement('style');
            style.id = 'single-label-page-size';
            style.textContent = '@page { size: 75mm 100mm; margin: 0; }';
            document.head.appendChild(style);
          }
          document.body.classList.add('printing-single-label');
          window.print();
          setTimeout(() => {
            const s = document.getElementById('single-label-page-size');
            if (s) document.head.removeChild(s);
            document.body.classList.remove('printing-single-label');
          }, 500);
        };

        const printSingleStock = async (groupOrder) => {
          printingSingleId.value = groupOrder.id;
          try {
            const orders = await _fetchSubOrders(groupOrder);
            const stockMap = {};
            orders.forEach(order => {
              (order.items || []).forEach(item => {
                const qty = parseInt(item.qty) || 0;
                if (qty > 0) stockMap[item.itemName] = (stockMap[item.itemName] || 0) + qty;
              });
            });
            const items = Object.entries(stockMap).map(([name, qty]) => ({ name, qty }));
            singlePrintGroupData.value = { ...groupOrder, orders: [] };
            singleStockChunks.value = [];
            for (let i = 0; i < items.length; i += 12) singleStockChunks.value.push(items.slice(i, i + 12));
            await nextTick();
            const style = document.createElement('style');
            style.id = 'single-stock-page-size';
            style.textContent = '@page { size: 75mm 100mm; margin: 0; }';
            document.head.appendChild(style);
            document.body.classList.add('printing-single-stock');
            setTimeout(() => {
              window.print();
              setTimeout(() => {
                const s = document.getElementById('single-stock-page-size');
                if (s) document.head.removeChild(s);
                document.body.classList.remove('printing-single-stock');
              }, 500);
            }, 50);
          } finally { printingSingleId.value = null; }
        };
        
        // 批次列印（依當前篩選條件）
        const printAllFilteredLabels = async () => {
          if (!sortedDetailsList.value.length) { showAlert('沒有符合條件的訂單', 'error'); return; }
          loading.value = true;
          try {
            if (adminData.value.itemsList.length === 0) await fetchAdminItems();
            adminData.value.itemsList.forEach(item => { labelPriceMap.value[item.name] = item.price || 0; });
            const groups = [];
            for (const groupOrder of sortedDetailsList.value) {
              const q = query(collection(db, 'Orders'), where('groupOrderId', '==', groupOrder.id));
              const snap = await getDocs(q);
              const orders = snap.docs.map(d => {
                const data = d.data(); let totalAmount = 0;
                const items = (data.items || []).map(item => {
                  const price = labelPriceMap.value[item.itemName] || 0;
                  const qty = parseInt(item.qty) || 0;
                  totalAmount += price * qty; return item;
                });
                return { id: d.id, ...data, items, totalAmount };
              }).sort((a, b) => (a.customerName || '').localeCompare(b.customerName || '', 'zh-TW'));
              if (orders.length) groups.push({ ...groupOrder, orders });
            }
            if (!groups.length) { showAlert('沒有訂單資料', 'error'); return; }
            labelGroupsWithOrders.value = groups;
            labelSelectedIds.value = groups.flatMap(g => g.orders.map(o => o.id));
            await nextTick();
            const style = document.createElement('style');
            style.id = 'label-page-size';
            style.textContent = '@page { size: 75mm 100mm; margin: 0; }';
            document.head.appendChild(style);
            document.body.classList.add('printing-labels');
            window.print();
            setTimeout(() => {
              const s = document.getElementById('label-page-size');
              if (s) document.head.removeChild(s);
              document.body.classList.remove('printing-labels');
            }, 500);
          } finally { loading.value = false; }
        };

        const printAllFilteredStock = async () => {
          if (!sortedDetailsList.value.length) { showAlert('沒有符合條件的訂單', 'error'); return; }
          loading.value = true;
          try {
            if (adminData.value.itemsList.length === 0) await fetchAdminItems();
            adminData.value.itemsList.forEach(item => { labelPriceMap.value[item.name] = item.price || 0; });
            const itemTotals = {};
            for (const groupOrder of sortedDetailsList.value) {
              const q = query(collection(db, 'Orders'), where('groupOrderId', '==', groupOrder.id));
              const snap = await getDocs(q);
              snap.docs.forEach(d => {
                (d.data().items || []).forEach(item => {
                  if (item.itemName && parseInt(item.qty) > 0)
                    itemTotals[item.itemName] = (itemTotals[item.itemName] || 0) + (parseInt(item.qty) || 0);
                });
              });
            }
            const items = Object.entries(itemTotals).map(([name, qty]) => ({ name, qty }));
            if (!items.length) { showAlert('沒有備貨項目', 'error'); return; }
            const size = 12;
            stockPrintChunks.value = [];
            for (let i = 0; i < items.length; i += size) stockPrintChunks.value.push(items.slice(i, i + size));
            await nextTick();
            const style = document.createElement('style');
            style.id = 'stock-page-size';
            style.textContent = '@page { size: 75mm 100mm; margin: 0; }';
            document.head.appendChild(style);
            document.body.classList.add('printing-stock');
            setTimeout(() => {
              window.print();
              setTimeout(() => {
                const s = document.getElementById('stock-page-size');
                if (s) document.head.removeChild(s);
                document.body.classList.remove('printing-stock');
              }, 500);
            }, 50);
          } finally { loading.value = false; }
        };

        const changeOrderStatus = async (newStatus) => {
          if (!statusEditOrder.value) return;
          await updateOrderStatus(statusEditOrder.value, newStatus);
          // Refresh detailModalOrder if modal is open and matches the edited order
          if (detailModalOrder.value && detailModalOrder.value.id === statusEditOrder.value.id) {
            const docRef = doc(db, "GroupOrders", statusEditOrder.value.id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
              detailModalOrder.value = { id: docSnap.id, ...docSnap.data() };
              await nextTick();
            }
          }
          statusEditOrder.value = null;
        };

        // 監聽備貨統計條件變化
        watch([stockStart, stockEnd, stockStatus], () => {
          if (stockStart.value && stockEnd.value && adminTab.value === 'stock') {
            fetchStockList();
          }
        });

        // 監聽出貨單日期變化
        watch([labelStart, labelEnd], () => {
          if (labelStart.value && labelEnd.value && adminTab.value === 'labels') {
            fetchLabelOrders();
          }
        });

        // 初始化
        onMounted(() => {
          const savedUser = sessionStorage.getItem('user');
          const savedView = sessionStorage.getItem('currentView');
          const savedTab = sessionStorage.getItem('adminTab');
          
          // 設定預設日期為明天
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          const dateStr = tomorrow.toISOString().split('T')[0];
          stockStart.value = dateStr;
          stockEnd.value = dateStr;
          labelStart.value = dateStr;
          labelEnd.value = dateStr;
          // 訂單管理預設：今天 ~ 明天
          const today = new Date();
          detailsStart.value = today.toISOString().split('T')[0];
          detailsEnd.value = dateStr;
          
          if (savedUser && savedView) {
            user.value = JSON.parse(savedUser);
            currentView.value = savedView;
            
            if (currentView.value === 'admin') {
              // 恢復上次的標籤頁
              if (savedTab) {
                adminTab.value = savedTab;
              }
              // 非管理者不可進入帳號管理
              if (adminTab.value === 'accounts' && user.value?.role !== 'admin') {
                adminTab.value = 'details';
              }
              // 總是先抓待審核數量，確保 badge 正確
              fetchReviewList();
              // 根據當前分頁載入對應資料
              if (adminTab.value === 'accounts') {
                fetchAdminAccounts();
              } else if (adminTab.value === 'items') {
                fetchAdminItems();
              } else if (adminTab.value === 'review') {
                //fetchReviewList(); // 已提前抓
              } else if (adminTab.value === 'details') {
                fetchOrderDetails(); // 自動查詢當天的 approved 訂單
              } else if (adminTab.value === 'stock') {
                fetchStockList();
              } else if (adminTab.value === 'labels') {
                fetchLabelOrders();
              }
            }
          }
        });

        return {
          currentView,
          loading,
          showAdminMenu,
          adminTab,
          user,
          loginForm,
          adminData,
          detailsStatus,
          detailsSort,
          detailsKeyword,
          detailsStart,
          detailsEnd,
          statusEditOrder,
          changeOrderStatus,
          printAllFilteredLabels,
          printAllFilteredStock,
          sortByField,
          isTodayFilter,
          isTomorrowFilter,
          setTodayFilter,
          setTomorrowFilter,
          clearDetailsFilter,
          reviewSort,
          stockStart,
          stockEnd,
          stockStatus,
          labelStart,
          labelEnd,
          customAlert,
          showAccountModal,
          showSettingsMenu,
          editingAccount,
          accountForm,
          frequentContacts,
          showContactModal,
          editingContact,
          contactForm,
          selectedContactId,
          showContactPicker,
          contactPickerKeyword,
          filteredContactPicker,
          fetchFrequentContacts,
          openAddContactModal,
          editContact,
          closeContactModal,
          saveContact,
          deleteContact,
          fillContactInfo,
          pickContact,
          showItemModal,
          editingItem,
          itemForm,
          itemsSort,
          sortedReviewList,
          sortedDetailsList,
          pagedDetailsList,
          totalDetailsPages,
          detailsPage,
          detailsPageSize,
          expandedOrdersGroupId,
          expandedStockGroupId,
          groupOrders,
          groupStock,
          groupTotalAmount,
          loadingGroupOrders,
          groupTotalAmountMap,
          editingOrderId,
          editFormData,
          editOrdersList,
          showEditModal,
          detailModalOrder,
          detailModalTab,
          detailInfoEditing,
          editingCustomerOrderId,
          editingCustomerOrderData,
          editingNewCustomerOrder,
          newCustomerOrderData,
          openDetailModal,
          closeDetailModal,
          saveAndCloseEdit,
          saveBasicInfo,
          startInlineEditCustomerOrder,
          saveInlineEditCustomerOrder,
          deleteCustomerOrder,
          printSingleCustomerLabel,
          addNewCustomerOrderInline,
          saveNewCustomerOrder,
          showCreateOrderModal,
          createOrderTab,
          createOrderForm,
          createOrderCustomers,
          addingCreateCustomer,
          newCreateCustomerData,
          openCreateOrderModal,
          confirmAddCreateCustomer,
          saveCreateGroupOrder,
          showAlert,
          handleLogin,
          logout,
          fetchAdminAccounts,
          openAddAccountModal,
          editAccount,
          closeAccountModal,
          saveAccount,
          deleteAccount,
          fetchAdminItems,
          openAddItemModal,
          editItem,
          closeItemModal,
          saveItem,
          deleteItem,
          fetchReviewList,
          confirmGroup,
          rejectGroup,
          toggleOrders,
          toggleStock,
          fetchGroupOrders,
          calculateOrderTotal,
          updateOrderStatus,
          startEditOrder,
          cancelEditOrder,
          saveEditOrder,
          addNewOrder,
          removeOrder,
          addOrderItem,
          removeOrderItem,
          isItemSelected,
          fetchOrderDetails,
          fetchStockList,
          labelGroupsWithOrders,
          labelSelectedIds,
          labelTotalOrderCount,
          isAllLabelSelected,
          getLabelInfo,
          toggleLabel,
          isGroupAllSelected,
          toggleGroupLabels,
          toggleAllLabels,
          stockPrintChunks,
          printStockLabels,
          printLabels,
          fetchLabelOrders,
          singlePrintGroupData,
          singleStockChunks,
          printingSingleId,
          getSingleLabelInfo,
          printSingleLabel,
          printSingleStock,
          detailsApprovedTotal,
          detailsPendingTotal,
          detailsDashboardTotal,
          detailsOrderCount,
          detailsApprovedCount,
          detailsPendingCount,
          getTaiwanDateStr,
          setYesterdayFilter,
          selectedOrderIds,
          isAllOrderSelected,
          toggleOrderSelection,
          toggleAllOrderSelection,
          batchExportStock,
          batchExportLabels,
          window
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
