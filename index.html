<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å¥ç¾æ»·å‘³ - å®˜æ–¹è¨‚è³¼ç³»çµ±</title>
  
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['"Noto Sans TC"', 'sans-serif'],
          },
          colors: {
            brand: {
              50: '#fff7ed',
              100: '#ffedd5',
              500: '#f97316',
              600: '#ea580c',
              700: '#c2410c',
              dark: '#431407'
            }
          },
          boxShadow: {
            'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.05)',
          },
          animation: {
            'slide-down': 'slideDown 0.3s ease-out',
          },
          keyframes: {
            slideDown: {
              '0%': { opacity: '0', transform: 'translateY(-10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            }
          }
        }
      }
    }
  </script>

  <style>
    [v-cloak] { display: none !important; }
    body { background-color: #fafaf9; color: #44403c; -webkit-tap-highlight-color: transparent; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    
    @media print {
      .no-print { display: none !important; }
      @page { size: 62mm auto; margin: 0; }
      body { background: white; margin: 0; padding: 0; width: 62mm; font-size: 12pt; }
      .print-area { display: block !important; width: 100%; padding: 0; }
      .label-card { width: 100% !important; border: 2px solid #000 !important; page-break-inside: avoid; margin-bottom: 3mm; padding: 2mm !important; background: white; color: black; }
      .text-stone-400, .text-brand-600, .text-stone-500 { color: black !important; }
    }
  </style>
</head>
<body class="min-h-screen font-sans antialiased selection:bg-brand-100 selection:text-brand-700">

  <div id="app" v-cloak>
    
    <div v-if="previewImage" class="fixed inset-0 z-[100] bg-stone-900/90 backdrop-blur-sm flex items-center justify-center p-4 cursor-zoom-out transition-opacity" @click="previewImage = null">
      <img :src="previewImage" class="max-w-full max-h-[90vh] rounded-xl shadow-2xl border-4 border-white/10">
    </div>

    <div v-if="currentView === 'home'" class="flex flex-col items-center justify-center min-h-screen px-6 bg-stone-50 no-print relative overflow-hidden">
      <div class="absolute top-[-10%] right-[-10%] w-64 h-64 bg-brand-100 rounded-full blur-3xl opacity-50 pointer-events-none"></div>
      <div class="absolute bottom-[-10%] left-[-10%] w-80 h-80 bg-stone-200 rounded-full blur-3xl opacity-50 pointer-events-none"></div>

      <div class="relative bg-white/80 backdrop-blur-xl p-10 rounded-[2.5rem] shadow-soft w-full max-w-sm text-center border border-white/50">
        <div class="mb-8 inline-flex items-center justify-center w-20 h-20 rounded-full bg-brand-50 text-brand-600 text-3xl shadow-inner">
          <i class="fas fa-utensils"></i>
        </div>
        <h1 class="text-4xl font-black text-stone-800 mb-3 tracking-tight">å¥ç¾æ»·å‘³</h1>
        <p class="text-stone-500 text-base mb-10 font-medium tracking-wide leading-relaxed">è¼¸å…¥åœ˜è³¼åºè™Ÿ<br>é–‹å•Ÿç¾å‘³æ—…ç¨‹</p>
        
        <div class="space-y-6">
          <div class="relative group">
             <input v-model="inputCode" type="text" placeholder="ä¾‹å¦‚ï¼šBUI6OH" class="w-full text-center text-3xl font-bold tracking-[0.2em] py-5 border-2 border-stone-100 rounded-2xl focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 focus:outline-none uppercase transition-all placeholder:text-stone-200 text-stone-800 bg-white shadow-sm group-hover:border-stone-200">
          </div>
          
          <button @click="verifyCode" :disabled="!inputCode || loading" class="w-full bg-gradient-to-r from-brand-600 to-brand-500 text-white text-lg font-bold py-5 rounded-2xl shadow-lg hover:shadow-xl hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50 disabled:shadow-none disabled:cursor-not-allowed disabled:transform-none">
            <span v-if="loading"><i class="fas fa-circle-notch fa-spin mr-2"></i>é©—è­‰ä¸­...</span>
            <span v-else>é–‹å§‹é»é¤ <i class="fas fa-arrow-right ml-1"></i></span>
          </button>
        </div>
        
        <div class="mt-12 pt-8 border-t border-stone-100/50">
          <button @click="currentView = 'login'" class="text-xs text-stone-400 hover:text-brand-600 font-bold transition-colors flex items-center justify-center mx-auto gap-2 py-2 px-4 rounded-full hover:bg-stone-50">
            <i class="fas fa-lock"></i>ç®¡ç†å“¡ / åœ˜ä¸»ç™»å…¥
          </button>
        </div>
      </div>
    </div>

    <div v-else-if="currentView === 'order'" class="max-w-lg mx-auto bg-stone-50 min-h-screen pb-48 relative no-print shadow-2xl shadow-stone-200/50">
      <div class="bg-white/90 backdrop-blur-md px-6 py-4 sticky top-0 z-30 shadow-sm border-b border-stone-100 transition-all">
        <div class="flex justify-between items-start">
          <div class="flex-1 min-w-0 pr-4">
            <h2 class="font-black text-2xl text-stone-800 mb-1 truncate">{{ sessionInfo.companyName }}</h2>
            <div class="flex flex-wrap items-center gap-2">
              <span class="bg-brand-50 text-brand-700 text-[10px] font-bold px-2 py-0.5 rounded-md tracking-wide ring-1 ring-brand-100">åœ˜è³¼é€²è¡Œä¸­</span>
              <span class="text-xs font-mono text-stone-400">#{{ sessionInfo.code }}</span>
            </div>
            <div v-if="sessionInfo.leaderName || sessionInfo.phone" class="mt-2 text-xs text-stone-500 font-medium flex items-center gap-2">
               <span v-if="sessionInfo.leaderName" class="flex items-center"><i class="fas fa-user-circle mr-1 opacity-70"></i>{{ sessionInfo.leaderName }}</span>
               <span v-if="sessionInfo.phone" class="flex items-center"><i class="fas fa-phone mr-1 opacity-70"></i>{{ sessionInfo.phone }}</span>
            </div>
          </div>
          <button @click="currentView='home'" class="w-10 h-10 flex flex-shrink-0 items-center justify-center bg-stone-100 rounded-full text-stone-400 hover:bg-stone-200 hover:text-stone-600 transition active:scale-90">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="px-5 pt-6">
        <div class="mb-8">
          <label class="block text-xs font-bold text-stone-400 uppercase mb-2 ml-1 tracking-wider">æ‚¨çš„å§“å</label>
          <input v-model="buyerName" class="w-full p-4 text-lg font-bold text-stone-700 border-none bg-white rounded-2xl shadow-sm ring-1 ring-stone-100 focus:ring-2 focus:ring-brand-500 outline-none transition placeholder:text-stone-300 placeholder:font-normal" placeholder="è«‹è¼¸å…¥å§“åä»¥åˆ©å°å¸³">
        </div>
        
        <div class="flex overflow-x-auto space-x-3 pb-4 mb-2 hide-scroll sticky top-[95px] z-20 bg-stone-50/95 backdrop-blur-sm py-2 -mx-5 px-5">
          <button v-for="cat in categories" @click="filterCat = cat" 
            :class="['px-5 py-2.5 rounded-full text-sm whitespace-nowrap font-bold transition-all transform active:scale-95 border', 
            filterCat === cat ? 'bg-brand-600 text-white border-brand-600 shadow-md shadow-brand-500/30' : 'bg-white text-stone-500 border-stone-100 shadow-sm']">
            {{ cat }}
          </button>
        </div>

        <div v-if="items.length === 0" class="text-center py-20 text-stone-300 italic flex flex-col items-center">
            <i class="fas fa-cloud-download-alt text-4xl mb-2 opacity-50"></i>
            <span>è¼‰å…¥èœå–®ä¸­...</span>
        </div>

        <div class="space-y-4">
          <div v-for="item in filteredItems" :key="item.docId" class="group bg-white p-4 rounded-2xl shadow-sm border border-stone-100 flex gap-4 items-center transition hover:shadow-md">
            <div v-if="item.image" class="w-24 h-24 flex-shrink-0 bg-stone-100 rounded-xl overflow-hidden cursor-zoom-in relative" @click.stop="previewImage = item.image">
              <img :src="item.image" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
            </div>
            <div v-else class="w-24 h-24 flex-shrink-0 bg-stone-50 rounded-xl flex items-center justify-center text-stone-200 border border-stone-100">
               <i class="fas fa-utensils text-2xl opacity-30"></i>
            </div>

            <div class="flex-1 min-w-0 flex flex-col justify-between h-24 py-1">
              <div>
                <div class="font-bold text-stone-800 text-lg leading-tight mb-1 line-clamp-1">{{ item.name }}</div>
              </div>
              <div class="flex justify-between items-end">
                <div class="text-brand-600 font-black text-xl tracking-tight">$ {{ item.price }}</div>
                <div class="flex items-center bg-stone-50 rounded-xl p-1 border border-stone-100 shadow-inner">
                  <button @click="item.qty = Math.max(0, (item.qty||0)-1)" 
                    class="w-8 h-8 flex items-center justify-center bg-white rounded-lg text-stone-400 shadow-sm active:scale-90 transition hover:text-brand-600 disabled:opacity-30 disabled:cursor-not-allowed"
                    :disabled="!item.qty">
                    <i class="fas fa-minus text-[10px]"></i>
                  </button>
                  <span class="w-8 text-center font-bold text-lg text-stone-700 tabular-nums">{{ item.qty || 0 }}</span>
                  <button @click="item.qty = (item.qty||0)+1" class="w-8 h-8 flex items-center justify-center bg-brand-500 rounded-lg text-white shadow-md shadow-brand-500/20 active:scale-90 transition hover:bg-brand-600">
                    <i class="fas fa-plus text-[10px]"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-10 mb-8">
           <label class="block text-xs font-bold text-stone-400 uppercase mb-2 ml-1 tracking-wider">å‚™è¨»éœ€æ±‚</label>
           <div class="relative">
             <i class="fas fa-pen absolute left-4 top-4 text-stone-300"></i>
             <input v-model="note" class="w-full pl-10 pr-4 py-4 text-sm font-medium bg-white rounded-2xl border-none shadow-sm ring-1 ring-stone-100 focus:ring-2 focus:ring-brand-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šè¦å¤§è¾£ã€ä¸åˆ‡ã€åˆ†è£...">
           </div>
        </div>
      </div>

      <div v-if="totalAmount > 0" class="fixed bottom-6 left-4 right-4 max-w-[480px] mx-auto z-40">
        <div class="bg-stone-900/90 backdrop-blur-lg text-white p-4 pl-6 rounded-[2rem] shadow-2xl shadow-stone-900/30 flex items-center justify-between border border-white/10">
          <div class="flex flex-col">
            <span class="text-stone-400 text-[10px] font-bold uppercase tracking-widest mb-0.5">Total</span>
            <div class="flex items-baseline gap-2">
              <span class="text-3xl font-black text-white tracking-tight">${{ totalAmount }}</span>
              <span class="text-sm text-stone-400 font-medium">/ {{ totalQty }} é …</span>
            </div>
          </div>
          <button @click="submitOrder" :disabled="submitting || !buyerName" class="bg-brand-500 text-white px-8 py-3.5 rounded-2xl font-bold text-lg shadow-lg hover:bg-brand-400 active:scale-95 transition disabled:bg-stone-700 disabled:text-stone-500 disabled:shadow-none disabled:cursor-not-allowed">
            {{ submitting ? 'è™•ç†ä¸­' : 'é€å‡ºè¨‚å–®' }}
          </button>
        </div>
      </div>
    </div>

    <div v-else-if="currentView === 'login'" class="flex flex-col items-center justify-center min-h-screen bg-stone-100 px-6 no-print">
      <form @submit.prevent="handleLogin" class="bg-white p-10 rounded-[2rem] shadow-2xl w-full max-w-sm border border-white relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-500 to-brand-600"></div>
        <h2 class="text-2xl font-black mb-10 text-center text-stone-800 tracking-tight">å¾Œå°ç®¡ç†ç™»å…¥</h2>
        <div class="space-y-6">
          <div class="group">
            <label class="text-[10px] font-black text-stone-400 uppercase ml-1 tracking-widest group-focus-within:text-brand-600 transition-colors">Account ID</label>
            <input v-model="loginForm.id" type="text" autocomplete="username" placeholder="ä¾‹å¦‚: ADMIN" class="w-full p-4 mt-1 border-2 border-stone-100 bg-stone-50 rounded-2xl uppercase focus:border-brand-500 focus:bg-white outline-none transition font-bold text-stone-700 placeholder:font-normal placeholder:normal-case">
          </div>
          <div class="group">
            <label class="text-[10px] font-black text-stone-400 uppercase ml-1 tracking-widest group-focus-within:text-brand-600 transition-colors">Password</label>
            <input v-model="loginForm.pass" type="password" autocomplete="current-password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full p-4 mt-1 border-2 border-stone-100 bg-stone-50 rounded-2xl focus:border-brand-500 focus:bg-white outline-none transition" required>
          </div>
          <button type="submit" :disabled="loading" class="w-full bg-stone-800 text-white py-4 rounded-2xl shadow-xl font-black hover:bg-black active:scale-[0.98] transition mt-2">
            {{ loading ? 'é©—è­‰ä¸­...' : 'ç¢ºèªç™»å…¥' }}
          </button>
          <button type="button" @click="currentView='home'" class="w-full text-center text-stone-400 text-xs mt-6 hover:text-stone-600 transition font-bold">è¿”å›é¦–é </button>
        </div>
      </form>
    </div>

    <div v-else-if="currentView === 'leader'" class="min-h-screen bg-stone-50 pb-20 no-print">
      <div class="bg-white px-6 py-6 shadow-sm sticky top-0 z-30 border-b border-stone-100">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
          <div>
            <h2 class="text-xl font-black text-stone-800">{{ user.companyName }}</h2>
            <p class="text-xs text-stone-400 font-medium mt-0.5">å°ˆå±¬ç®¡ç†å¾Œå°</p>
          </div>
          <button @click="logout" class="bg-stone-100 text-stone-500 px-4 py-2 rounded-xl text-xs font-bold hover:bg-stone-200 transition">ç™»å‡º</button>
        </div>
      </div>

      <div class="max-w-4xl mx-auto p-6">
        <div class="bg-gradient-to-br from-brand-600 to-brand-500 text-white p-8 rounded-[2rem] shadow-xl shadow-brand-500/20 mb-10 flex flex-col sm:flex-row justify-between items-center gap-6 relative overflow-hidden">
          <div class="absolute right-0 top-0 w-40 h-40 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none"></div>
          <div class="text-center sm:text-left relative z-10">
            <h3 class="text-2xl font-black mb-2">ç™¼èµ·åˆèŒ¶åœ˜è³¼ï¼Ÿ</h3>
            <p class="text-brand-100 text-sm font-medium opacity-90">ç”¢ç”Ÿæ–°çš„åºè™Ÿï¼Œè®“åŒäº‹å€‘é–‹å§‹é»é¤å§ï¼</p>
          </div>
          <button @click="createGroup" :disabled="loading" class="relative z-10 bg-white text-brand-600 px-8 py-4 rounded-2xl font-black shadow-lg hover:bg-brand-50 active:scale-95 transition whitespace-nowrap">
            <i class="fas fa-plus mr-2"></i>å»ºç«‹æ–°åœ˜
          </button>
        </div>

        <h3 class="font-bold text-stone-400 mb-4 ml-2 uppercase tracking-widest text-xs">æ­·å²ç´€éŒ„</h3>
        
        <div v-if="leaderGroups.length === 0" class="text-center py-16 bg-white rounded-[2rem] border-2 border-dashed border-stone-200">
            <div class="text-stone-300 text-4xl mb-3"><i class="fas fa-clipboard-list"></i></div>
            <p class="text-stone-400 font-bold">ç›®å‰æ²’æœ‰åœ˜è³¼ç´€éŒ„</p>
        </div>
        
        <div class="space-y-6">
          <div v-for="g in leaderGroups" :key="g.id" class="bg-white rounded-[1.5rem] p-6 shadow-sm border border-stone-100 hover:shadow-md transition-all">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
              <div>
                <div class="flex items-center gap-3 mb-1">
                   <span class="text-xs font-bold text-stone-400 bg-stone-100 px-2 py-1 rounded-lg">{{ formatDate(g.createdAt) }}</span>
                   <span v-if="g.status === 'OPEN'" class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded-lg font-bold border border-green-200"><span class="w-1.5 h-1.5 bg-green-500 rounded-full inline-block mr-1"></span>é€²è¡Œä¸­</span>
                   <span v-else-if="g.status === 'SUBMITTED'" class="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-1 rounded-lg font-bold border border-yellow-200"><span class="w-1.5 h-1.5 bg-yellow-500 rounded-full inline-block mr-1 animate-pulse"></span>å·²é€å‡º</span>
                   <span v-else-if="g.status === 'CONFIRMED'" class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded-lg font-bold border border-blue-100"><i class="fas fa-check-circle mr-1"></i>å·²ç¢ºèª</span>
                </div>
                <div class="font-black text-4xl text-brand-600 tracking-tighter select-all">{{ g.code }}</div>
              </div>
              <div class="flex gap-2 w-full sm:w-auto">
                 <button @click="viewDetail(g)" class="flex-1 sm:flex-none bg-stone-50 text-stone-600 px-5 py-3 rounded-xl font-bold border border-stone-200 hover:bg-stone-100 transition text-sm">{{ selectedGroup && selectedGroup.id === g.id ? 'æ”¶åˆ' : 'æ˜ç´°' }}</button>
                <button v-if="g.status === 'OPEN'" @click="submitGroup(g)" class="flex-1 sm:flex-none bg-red-50 text-red-500 px-5 py-3 rounded-xl font-bold border border-red-100 hover:bg-red-100 transition text-sm">çµå–®é€å‡º</button>
                <button v-if="g.status === 'SUBMITTED'" @click="recallGroup(g)" class="flex-1 sm:flex-none bg-yellow-50 text-yellow-600 px-5 py-3 rounded-xl font-bold border border-yellow-100 hover:bg-yellow-100 transition text-sm"><i class="fas fa-undo mr-1"></i>æ”¶å›</button>
              </div>
            </div>

            <div v-if="selectedGroup && selectedGroup.id === g.id" class="mt-6 pt-6 border-t border-dashed border-stone-200 animate-slide-down">
              <div v-if="loadingDetail" class="text-center py-8 text-stone-300"><i class="fas fa-spinner fa-spin text-2xl"></i></div>
              <div v-else>
                <div class="flex justify-between items-center mb-4 bg-stone-50 p-4 rounded-xl border border-stone-100">
                  <span class="font-bold text-stone-600 text-sm">è¨‚å–®åˆ—è¡¨ ({{ selectedDetail.list.length }})</span>
                  <span class="text-xl font-black text-brand-600">ç¸½è¨ˆ: ${{ selectedDetail.totalAmount }}</span>
                </div>
                <div class="overflow-x-auto rounded-lg border border-stone-100">
                  <table class="w-full text-left text-sm whitespace-nowrap">
                    <thead class="text-stone-400 text-[10px] uppercase tracking-wider bg-stone-50 border-b border-stone-100">
                      <tr><th class="py-3 pl-4">å§“å</th><th class="py-3">å…§å®¹</th><th class="py-3 text-right">é‡‘é¡</th><th class="py-3 pr-4 text-center">å·²ä»˜</th></tr>
                    </thead>
                    <tbody class="divide-y divide-stone-50 bg-white">
                      <tr v-for="order in selectedDetail.list" :key="order.id" class="group hover:bg-stone-50 transition-colors">
                        <td class="py-4 pl-4 font-bold text-stone-700">{{ order.buyerName }}</td>
                        <td class="py-4 text-xs text-stone-500 leading-relaxed max-w-[200px] whitespace-normal">
                          <span v-for="i in order.items" class="inline-block bg-white border border-stone-100 px-2 py-1 rounded-md mr-1 mb-1 shadow-sm">{{ i.name }} <span class="text-brand-600 font-bold">x{{ i.qty }}</span></span>
                        </td>
                        <td class="py-4 text-right font-bold text-stone-800">${{ order.totalAmount }}</td>
                        <td class="py-4 pr-4 text-center"><input type="checkbox" v-model="order.isPaid" @change="togglePaid(order)" class="w-5 h-5 rounded border-stone-300 text-brand-600 focus:ring-brand-500 cursor-pointer transition"></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div v-else-if="currentView === 'admin'" class="min-h-screen bg-stone-50 pb-20">
      
      <div class="bg-white/90 backdrop-blur-md px-6 py-4 shadow-sm sticky top-0 z-50 border-b border-stone-200 no-print">
        <div class="max-w-7xl mx-auto flex flex-col xl:flex-row justify-between items-center gap-4">
          <div class="flex flex-col md:flex-row items-center gap-6 w-full xl:w-auto">
            <div class="flex items-center gap-4">
               <h1 class="font-black text-xl text-stone-800 flex items-center gap-2">
                 <span class="w-10 h-10 bg-gradient-to-br from-brand-600 to-brand-500 text-white rounded-xl flex items-center justify-center text-lg shadow-lg shadow-brand-500/30"><i class="fas fa-chart-pie"></i></span>
                 ç®¡ç†å¾Œå°
               </h1>
            </div>
            <div class="hidden md:block w-px h-8 bg-stone-300"></div>
            <div class="flex gap-2 overflow-x-auto w-full md:w-auto hide-scroll pb-1">
               <button @click="adminTab='accounts'; fetchAdminAccounts()" :class="['px-4 py-2.5 rounded-xl text-sm font-bold transition-all whitespace-nowrap border', adminTab=='accounts'?'bg-stone-800 text-white border-stone-800 shadow-md':'bg-white text-stone-500 border-stone-200 hover:bg-stone-50']">ğŸ‘¥ å¸³è™Ÿç®¡ç†</button>
               <button @click="adminTab='items'; fetchAdminItems()" :class="['px-4 py-2.5 rounded-xl text-sm font-bold transition-all whitespace-nowrap border', adminTab=='items'?'bg-stone-800 text-white border-stone-800 shadow-md':'bg-white text-stone-500 border-stone-200 hover:bg-stone-50']">ğŸ“¦ ç”¢å“ç®¡ç†</button>
            </div>
          </div>
          <div class="flex gap-2 overflow-x-auto w-full xl:w-auto pb-1 md:pb-0 hide-scroll border-t md:border-t-0 border-stone-100 pt-3 md:pt-0">
             <button @click="adminTab='review'; fetchReviewList()" :class="['px-4 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center gap-2 whitespace-nowrap border', adminTab=='review'?'bg-red-500 text-white border-red-500 shadow-md shadow-red-500/30':'bg-white text-stone-500 border-stone-200 hover:bg-stone-50']">
               å¾…å¯©æ ¸ <span v-if="adminData.reviewList.length > 0" class="bg-white text-red-500 text-[10px] px-1.5 rounded-md font-black shadow-sm">{{ adminData.reviewList.length }}</span>
             </button>
             <button @click="adminTab='details'; fetchOrderDetails()" :class="['px-4 py-2.5 rounded-xl text-sm font-bold transition-all whitespace-nowrap border', adminTab=='details'?'bg-stone-800 text-white border-stone-800 shadow-md':'bg-white text-stone-500 border-stone-200 hover:bg-stone-50']">ğŸ“ è¨‚å–®</button>
             <button @click="adminTab='stock'; fetchStockList()" :class="['px-4 py-2.5 rounded-xl text-sm font-bold transition-all whitespace-nowrap border', adminTab=='stock'?'bg-stone-800 text-white border-stone-800 shadow-md':'bg-white text-stone-500 border-stone-200 hover:bg-stone-50']">ğŸ“Š å‚™è²¨</button>
             <button @click="adminTab='labels'; fetchLabelList()" :class="['px-4 py-2.5 rounded-xl text-sm font-bold transition-all whitespace-nowrap border', adminTab=='labels'?'bg-stone-800 text-white border-stone-800 shadow-md':'bg-white text-stone-500 border-stone-200 hover:bg-stone-50']">ğŸ·ï¸ æ¨™ç±¤</button>
             <div class="w-px h-8 bg-stone-300 mx-1 hidden md:block"></div>
             <button @click="logout" class="bg-stone-100 text-stone-500 px-3 py-2.5 rounded-xl text-sm font-bold hover:bg-stone-200 ml-2"><i class="fas fa-sign-out-alt"></i></button>
          </div>
        </div>
      </div>

      <div v-if="loading" class="text-center py-32 text-brand-400 no-print"><i class="fas fa-circle-notch fa-spin text-4xl"></i></div>
      
      <div v-else class="max-w-6xl mx-auto p-6">
        
        <div v-if="adminTab === 'review'" class="max-w-3xl mx-auto space-y-6 no-print">
           <div v-if="adminData.reviewList.length === 0" class="text-center py-20">
             <div class="bg-green-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-green-500 text-3xl shadow-sm"><i class="fas fa-check"></i></div>
             <p class="text-stone-400 font-bold text-lg">ç›®å‰æ²’æœ‰å¾…ç¢ºèªçš„åœ˜è³¼</p>
           </div>
           
           <div v-for="g in adminData.reviewList" :key="g.id" class="bg-white border-l-8 border-yellow-400 p-8 rounded-2xl shadow-lg flex flex-col md:flex-row justify-between items-start md:items-center gap-6 animate-slide-down">
              <div>
                 <div class="text-xs font-bold text-stone-400 mb-2 flex items-center gap-2">
                   <i class="far fa-clock"></i> {{ formatDate(g.createdAt) }}
                 </div>
                 <div class="text-2xl font-black text-stone-800 mb-2">{{ g.companyName }}</div>
                 <div class="inline-flex items-center gap-2 bg-yellow-50 text-yellow-700 px-3 py-1.5 rounded-lg text-sm font-bold">
                   <span class="w-2 h-2 bg-yellow-500 rounded-full animate-ping"></span>
                   ç­‰å¾…ç¢ºèªä¸­...
                 </div>
              </div>
              <button @click="confirmGroup(g)" class="w-full md:w-auto bg-stone-800 text-white px-8 py-4 rounded-xl font-bold shadow-xl hover:bg-black active:scale-95 transition flex items-center justify-center gap-2">
                 <span>ç¢ºèªæ¥æ”¶</span> <i class="fas fa-check"></i>
              </button>
           </div>
        </div>

        <div v-if="adminTab === 'items'" class="max-w-4xl mx-auto no-print">
          <div class="bg-white p-6 rounded-[2rem] shadow-xl border border-stone-100">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-black text-stone-800">ç”¢å“æ¸…å–®</h2>
              <button @click="openItemModal()" class="bg-brand-600 text-white px-4 py-2.5 rounded-xl font-bold text-sm hover:bg-brand-700 transition shadow-lg shadow-brand-500/20"><i class="fas fa-plus mr-1"></i> æ–°å¢ç”¢å“</button>
            </div>
            <div class="overflow-x-auto rounded-xl border border-stone-100">
              <table class="w-full text-left whitespace-nowrap">
                <thead class="text-stone-400 text-xs uppercase bg-stone-50 border-b border-stone-100">
                  <tr><th class="py-4 px-4">åœ–ç‰‡</th><th class="py-4 px-4">åˆ†é¡</th><th class="py-4">å“å</th><th class="py-4">åƒ¹æ ¼</th><th class="py-4 pr-4 text-right">æ“ä½œ</th></tr>
                </thead>
                <tbody class="divide-y divide-stone-50">
                  <tr v-for="item in adminItems" :key="item.docId" class="hover:bg-stone-50 transition group">
                    <td class="py-4 px-4">
                      <div v-if="item.image" class="w-12 h-12 rounded-lg bg-stone-100 overflow-hidden shadow-sm"><img :src="item.image" class="w-full h-full object-cover"></div>
                      <div v-else class="w-12 h-12 rounded-lg bg-stone-50 flex items-center justify-center text-stone-300 text-xs border border-stone-100"><i class="fas fa-image"></i></div>
                    </td>
                    <td class="py-4 px-4"><span class="bg-stone-100 px-2 py-1 rounded text-xs font-bold text-stone-500">{{ item.category || 'æœªåˆ†é¡' }}</span></td>
                    <td class="py-4 font-bold text-stone-700">{{ item.name }}</td>
                    <td class="py-4 text-brand-600 font-bold">${{ item.price }}</td>
                    <td class="py-4 pr-4 text-right">
                      <button @click="openItemModal(item)" class="text-stone-400 hover:text-brand-600 p-2 transition bg-transparent hover:bg-brand-50 rounded-lg"><i class="fas fa-edit"></i></button>
                      <button @click="deleteItem(item.docId)" class="text-stone-400 hover:text-red-500 p-2 transition bg-transparent hover:bg-red-50 rounded-lg"><i class="fas fa-trash"></i></button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div v-if="editingItem" class="fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-[60] flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-md rounded-[2rem] p-8 shadow-2xl max-h-[90vh] overflow-y-auto border border-white/20">
              <h3 class="text-xl font-black mb-6">{{ editingItem.docId ? 'ç·¨è¼¯ç”¢å“' : 'æ–°å¢ç”¢å“' }}</h3>
              <div class="space-y-4">
                <div class="flex flex-col items-center justify-center p-6 border-2 border-dashed border-stone-200 rounded-2xl bg-stone-50 hover:bg-white hover:border-brand-300 transition relative group cursor-pointer">
                  <input type="file" @change="handleImageUpload" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full z-10">
                  <div v-if="editingItem.image" class="relative z-0">
                     <img :src="editingItem.image" class="h-32 rounded-lg object-contain shadow-sm mb-2 group-hover:scale-105 transition">
                     <div class="text-xs text-stone-400 text-center font-bold">é»æ“Šæ›´æ›åœ–ç‰‡</div>
                  </div>
                  <div v-else class="text-center py-2">
                    <i class="fas fa-cloud-upload-alt text-3xl text-stone-300 mb-2 group-hover:text-brand-400 transition"></i>
                    <div class="text-sm font-bold text-stone-500">ä¸Šå‚³åœ–ç‰‡</div>
                    <div class="text-xs text-stone-400 mt-1">JPG, PNG</div>
                  </div>
                </div>
                <div><label class="text-xs font-bold text-stone-400 ml-1">åˆ†é¡</label><input v-model="editingItem.category" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šæ‹›ç‰Œã€è”¬é£Ÿ"></div>
                <div><label class="text-xs font-bold text-stone-400 ml-1">ç”¢å“åç¨±</label><input v-model="editingItem.name" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition"></div>
                <div><label class="text-xs font-bold text-stone-400 ml-1">åƒ¹æ ¼</label><input v-model.number="editingItem.price" type="number" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition"></div>
              </div>
              <div class="flex gap-3 mt-8">
                <button @click="editingItem = null" class="flex-1 py-3 bg-stone-100 text-stone-500 rounded-xl font-bold hover:bg-stone-200 transition">å–æ¶ˆ</button>
                <button @click="saveItem" class="flex-1 py-3 bg-brand-600 text-white rounded-xl font-bold hover:bg-brand-700 shadow-lg shadow-brand-500/30 transition">å„²å­˜</button>
              </div>
            </div>
          </div>
        </div>

        <div v-if="adminTab === 'accounts'" class="max-w-4xl mx-auto no-print">
            <div class="bg-white p-6 rounded-[2rem] shadow-xl border border-stone-100">
                <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-stone-800">åœ˜ä¸»å¸³è™Ÿç®¡ç†</h2>
                <button @click="openAccountModal()" class="bg-brand-600 text-white px-4 py-2.5 rounded-xl font-bold text-sm hover:bg-brand-700 transition shadow-lg shadow-brand-500/20"><i class="fas fa-user-plus mr-1"></i> æ–°å¢å¸³è™Ÿ</button>
                </div>
                <div class="overflow-x-auto rounded-xl border border-stone-100">
                <table class="w-full text-left whitespace-nowrap">
                    <thead class="text-stone-400 text-xs uppercase bg-stone-50 border-b border-stone-100">
                    <tr><th class="py-4 px-4">ID</th><th class="py-4">åœ˜ä¸»åç¨±</th><th class="py-4">å…¬å¸</th><th class="py-4">éƒ¨é–€</th><th class="py-4">é›»è©±</th><th class="py-4 pr-4 text-right">æ“ä½œ</th></tr>
                    </thead>
                    <tbody class="divide-y divide-stone-50">
                    <tr v-for="acc in adminAccounts" :key="acc.docId" class="hover:bg-stone-50 transition">
                        <td class="py-4 px-4"><span class="bg-stone-100 px-2 py-1 rounded text-xs font-bold font-mono text-stone-600">{{ acc.id }}</span></td>
                        <td class="py-4 font-bold text-brand-600">{{ acc.leaderName || '-' }}</td>
                        <td class="py-4 font-bold text-stone-700">{{ acc.name }}</td>
                        <td class="py-4 text-stone-500 text-sm">{{ acc.department || '-' }}</td>
                        <td class="py-4 text-stone-500 text-sm font-mono">{{ acc.phone || '-' }}</td>
                        <td class="py-4 pr-4 text-right">
                        <button @click="openAccountModal(acc)" class="text-stone-400 hover:text-brand-600 p-2 transition hover:bg-brand-50 rounded-lg"><i class="fas fa-edit"></i></button>
                        <button v-if="acc.id !== 'ADMIN'" @click="deleteAccount(acc.docId)" class="text-stone-400 hover:text-red-500 p-2 transition hover:bg-red-50 rounded-lg"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    </tbody>
                </table>
                </div>
            </div>

            <div v-if="editingAccount" class="fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-[60] flex items-center justify-center p-6">
                <div class="bg-white w-full max-w-md rounded-[2rem] p-8 shadow-2xl overflow-y-auto max-h-[90vh] border border-white/20">
                <h3 class="text-xl font-black mb-6">{{ editingAccount.docId ? 'ç·¨è¼¯å¸³è™Ÿ' : 'æ–°å¢å¸³è™Ÿ' }}</h3>
                <div class="space-y-4">
                    <div><label class="text-xs font-bold text-stone-400 ml-1">å¸³è™Ÿ ID (ç™»å…¥ç”¨)</label><input v-model="editingAccount.id" :disabled="editingAccount.docId" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition uppercase font-bold disabled:text-stone-400 disabled:bg-stone-100" placeholder="ä¾‹å¦‚ï¼šC001"><p v-if="!editingAccount.docId" class="text-[10px] text-stone-400 mt-1 ml-1">* æ–°å¢å¾Œ ID ç„¡æ³•ä¿®æ”¹</p></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-stone-400 ml-1">åœ˜ä¸»åç¨±</label><input v-model="editingAccount.leaderName" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜"></div>
                         <div><label class="text-xs font-bold text-stone-400 ml-1">é€£çµ¡é›»è©± (é è¨­)</label><input v-model="editingAccount.phone" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition" placeholder="09xx-xxx-xxx"></div>
                    </div>
                    <div><label class="text-xs font-bold text-stone-400 ml-1">å…¬å¸åç¨±</label><input v-model="editingAccount.name" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šå°ç©é›»"></div>
                    <div><label class="text-xs font-bold text-stone-400 ml-1">éƒ¨é–€</label><input v-model="editingAccount.department" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šç ”ç™¼éƒ¨"></div>
                    <div><label class="text-xs font-bold text-stone-400 ml-1">äº¤è²¨åœ°å€ (é è¨­)</label><input v-model="editingAccount.address" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition" placeholder="è«‹è¼¸å…¥è©³ç´°åœ°å€"></div>
                    <div><label class="text-xs font-bold text-stone-400 ml-1">å¯†ç¢¼</label><input v-model="editingAccount.password" type="text" class="w-full p-3 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-brand-500 outline-none transition" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"></div>
                </div>
                <div class="flex gap-3 mt-8">
                    <button @click="editingAccount = null" class="flex-1 py-3 bg-stone-100 text-stone-500 rounded-xl font-bold hover:bg-stone-200 transition">å–æ¶ˆ</button>
                    <button @click="saveAccount" class="flex-1 py-3 bg-brand-600 text-white rounded-xl font-bold hover:bg-brand-700 shadow-lg shadow-brand-500/30 transition">å„²å­˜</button>
                </div>
                </div>
            </div>
        </div>

        <div v-if="adminTab === 'details'" class="max-w-5xl mx-auto space-y-8 no-print">
           <div class="flex justify-between items-center bg-white p-6 rounded-2xl mb-6 shadow-sm border border-stone-100">
              <h2 class="text-xl font-black text-stone-800 flex items-center gap-2"><i class="fas fa-list-ul text-brand-500"></i> è¨‚å–®ç¸½è¦½</h2>
              <input type="date" v-model="orderDate" @change="fetchOrderDetails" class="border-2 border-stone-100 bg-stone-50 py-2 px-4 rounded-xl text-sm font-bold text-stone-600 focus:border-brand-500 outline-none cursor-pointer shadow-sm">
           </div>
           
           <div v-if="adminData.groupList.length === 0" class="text-center py-20 text-stone-300">è©²æ—¥æœŸç„¡è¨‚å–®</div>
           
           <div v-for="group in adminData.groupList" class="bg-white rounded-[1.5rem] shadow-soft border border-stone-200 overflow-hidden mb-8">
               <div class="bg-stone-50 p-6 border-b border-stone-200 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                  <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-white border border-stone-200 flex items-center justify-center text-stone-400 font-bold shadow-sm"><i class="fas fa-building text-lg"></i></div>
                    <div>
                      <h3 class="font-black text-xl text-stone-800 tracking-tight">{{ group.companyName }}</h3>
                      <div class="text-xs text-stone-400 font-mono mt-0.5 flex items-center gap-2">
                          <span>{{ orderDate }}</span>
                          <span v-if="group.groupOrderId" class="bg-stone-200 px-1.5 rounded text-[10px]">#{{group.groupOrderId.substring(0,6)}}</span>
                      </div>
                    </div>
                  </div>
                  <div class="flex items-center gap-6 w-full sm:w-auto justify-between sm:justify-end">
                    
                    <button @click="toggleGroupExpand(group)" class="text-xs font-bold text-brand-600 bg-brand-50 hover:bg-brand-100 px-3 py-2 rounded-lg transition flex items-center gap-1 border border-brand-100 shadow-sm">
                        <i :class="group.allExpanded ? 'fas fa-compress-arrows-alt' : 'fas fa-expand-arrows-alt'"></i>
                        {{ group.allExpanded ? 'å…¨éƒ¨æ”¶åˆ' : 'å±•é–‹æ˜ç´°' }}
                    </button>

                    <button v-if="group.groupOrderId" @click="rejectGroup(group.groupOrderId)" class="text-xs font-bold text-stone-400 hover:text-red-600 hover:bg-red-50 px-3 py-2 rounded-lg transition border border-transparent hover:border-red-100">
                      <i class="fas fa-undo mr-1"></i>æ•´åœ˜é€€å› (é‡é–‹)
                    </button>
                    <div class="text-right">
                      <div class="text-[10px] text-stone-400 font-bold uppercase tracking-widest mb-0.5">Total Amount</div>
                      <div class="font-black text-3xl text-brand-600 tracking-tighter">${{ group.total }}</div>
                    </div>
                  </div>
               </div>

               <div class="divide-y divide-stone-100">
                 <div v-for="order in group.orders" :key="order.id" class="transition bg-white">
                   
                   <div @click="order.expanded = !order.expanded" class="p-5 flex justify-between items-center cursor-pointer hover:bg-stone-50 group select-none">
                       <div class="flex items-center gap-4">
                           <div :class="['w-3 h-3 rounded-full shadow-sm ring-2 ring-offset-2 transition-colors', order.status === 'CONFIRMED' ? 'bg-green-500 ring-green-100' : 'bg-yellow-400 ring-yellow-100 animate-pulse']"></div>
                           <div class="font-black text-stone-700 text-lg group-hover:text-stone-900 transition-colors">{{ order.buyerName }}</div>
                       </div>

                       <div class="flex items-center gap-5">
                           <div class="font-bold text-stone-800 text-xl tracking-tight">${{ order.totalAmount }}</div>
                           <div :class="['w-8 h-8 rounded-full flex items-center justify-center transition-all duration-300', order.expanded ? 'bg-brand-50 text-brand-600 rotate-180' : 'bg-stone-50 text-stone-300 group-hover:bg-stone-200']">
                               <i class="fas fa-chevron-down"></i>
                           </div>
                       </div>
                   </div>

                   <div v-if="order.expanded" class="bg-stone-50/50 border-t border-dashed border-stone-100 px-6 pb-6 pt-2 animate-slide-down">
                       <div class="pl-7 space-y-2">
                           <div v-for="i in order.items" class="flex justify-between items-center text-sm border-b border-stone-100 border-dashed py-2 last:border-0 hover:bg-white/50 px-2 rounded transition">
                               <span class="text-stone-600 font-medium">{{ i.name }}</span>
                               <span class="font-bold text-stone-800">x{{ i.qty }}</span>
                           </div>
                       </div>
                       
                       <div v-if="order.note" class="ml-9 mt-3 flex items-start gap-2 text-xs font-bold text-brand-600 bg-brand-50 p-3 rounded-xl inline-block max-w-full">
                           <i class="fas fa-comment-dots mt-0.5"></i> 
                           <span class="leading-relaxed">{{ order.note }}</span>
                       </div>
                   </div>

                 </div>
               </div>
           </div>
        </div>

        <div v-if="adminTab === 'labels'">
          <div class="no-print bg-amber-50 border border-amber-200 text-amber-900 p-6 rounded-[1.5rem] mb-8 flex flex-col md:flex-row justify-between items-center gap-4 shadow-sm">
             <div class="flex flex-col gap-1">
                <div class="font-black text-lg flex items-center gap-2"><i class="fas fa-print"></i> æ¨™ç±¤åˆ—å°æ¨¡å¼</div>
                <div class="text-xs opacity-70">è«‹å°‡æ¨™ç±¤æ©Ÿè¨­å®šç‚º 62mmï¼Œä¸¦å–æ¶ˆé é¦–é å°¾</div>
             </div>
             <div class="flex items-center gap-3 bg-white p-2 rounded-xl shadow-sm border border-amber-100">
                <span class="text-xs font-bold text-stone-400 pl-2">æ—¥æœŸ</span>
                <input type="date" v-model="labelDate" @change="fetchLabelList" class="border-none bg-transparent py-1 px-1 text-sm font-bold text-stone-700 focus:ring-0 outline-none cursor-pointer">
             </div>
             <button onclick="window.print()" class="bg-stone-800 text-white px-6 py-3 rounded-xl hover:bg-black transition shadow-lg flex items-center gap-2 font-bold">åˆ—å°æ¨™ç±¤</button>
          </div>
          <div v-if="adminData.labelList.length === 0" class="text-center py-20 text-stone-300 no-print">è©²æ—¥æœŸç„¡ã€Œå·²ç¢ºèªã€æ¨™ç±¤å¯å°</div>
          <div class="print-area">
            <div v-for="l in adminData.labelList" class="label-card relative">
               <div class="border-b-2 border-black pb-1 mb-1">
                 <div class="flex justify-between items-baseline">
                    <div class="font-black text-xl leading-tight">{{ l.buyerName }}</div>
                    <div class="text-xs font-bold text-right truncate pl-2 max-w-[120px]">{{ l.companyName }}</div>
                 </div>
               </div>
               <div class="text-sm font-bold leading-tight min-h-[1.5cm]">
                 <div v-for="i in l.items" class="flex justify-between mb-1 items-start">
                   <span class="w-[85%]">{{ i.name }}</span><span class="w-[15%] text-right font-black">x{{ i.qty }}</span>
                 </div>
                 <div v-if="l.note" class="mt-2 pt-1 border-t border-black text-xs font-medium italic">è¨»: {{ l.note }}</div>
               </div>
               <div class="flex justify-between items-end pt-2 border-t-2 border-black mt-2">
                 <div class="text-[10px] font-mono">{{ labelDate }}</div><div class="font-black text-2xl">${{ l.totalAmount }}</div>
               </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, addDoc, serverTimestamp, orderBy, doc, updateDoc, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const { createApp, ref, computed } = Vue;

    const firebaseConfig = {
      apiKey: "AIzaSyDb3xTmnkscf9tC5znTBzkCfSzD0zLJTYk",
      authDomain: "jianmei-food-54760.firebaseapp.com",
      projectId: "jianmei-food-54760",
      storageBucket: "jianmei-food-54760.firebasestorage.app",
      messagingSenderId: "367136535654",
      appId: "1:367136535654:web:119d8cb066dfb378e1a9a7"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const db = getFirestore(firebaseApp);

    createApp({
      setup() {
        const currentView = ref('home');
        const loading = ref(false);
        const loadingDetail = ref(false);
        const submitting = ref(false);
        const inputCode = ref('');
        const buyerName = ref('');
        const note = ref('');
        const filterCat = ref('å…¨éƒ¨');
        const sessionInfo = ref({});
        const items = ref([]);
        const loginForm = ref({ id: '', pass: '' });
        const user = ref({});
        const leaderGroups = ref([]);
        const selectedGroup = ref(null);
        const selectedDetail = ref({ list: [], totalAmount: 0 });
        
        const todayStr = new Date().toISOString().split('T')[0];
        const orderDate = ref(todayStr);
        const stockDate = ref(todayStr);
        const labelDate = ref(todayStr);

        const adminTab = ref('details'); 
        const adminData = ref({ stockList: [], groupList: [], labelList: [], reviewList: [] });
        
        const adminItems = ref([]);
        const editingItem = ref(null);
        const previewImage = ref(null);
        
        const adminAccounts = ref([]);
        const editingAccount = ref(null);

        const verifyCode = async () => {
          if (!inputCode.value) return;
          loading.value = true;
          try {
            const q = query(collection(db, "groupOrders"), where("code", "==", inputCode.value.toUpperCase()), where("status", "==", "OPEN"));
            const snap = await getDocs(q);
            if (!snap.empty) {
              sessionInfo.value = { id: snap.docs[0].id, ...snap.docs[0].data() };
              await fetchItems();
              currentView.value = 'order';
            } else { alert("åºè™ŸéŒ¯èª¤ï¼Œæˆ–è©²åœ˜å·²çµå–®"); }
          } catch(e) { alert("é€£ç·šè¶…æ™‚"); } finally { loading.value = false; }
        };

        const fetchItems = async () => {
          const snap = await getDocs(collection(db, "items"));
          items.value = snap.docs.map(doc => {
            const data = doc.data();
            return { ...data, docId: doc.id };
          });
        };

        const submitOrder = async () => {
          if (!buyerName.value) return alert('è«‹è¼¸å…¥æ‚¨çš„å§“å');
          submitting.value = true;
          try {
            const cart = items.value.filter(i => i.qty > 0);
            await addDoc(collection(db, "orders"), {
              groupOrderId: sessionInfo.value.id,
              groupCode: sessionInfo.value.code,
              companyName: sessionInfo.value.companyName,
              buyerName: buyerName.value,
              items: cart,
              totalAmount: totalAmount.value,
              note: note.value,
              createdAt: serverTimestamp(),
              orderDate: new Date().toISOString().split('T')[0],
              isPaid: false,
              status: "PENDING"
            });
            alert('è¨‚è³¼æˆåŠŸï¼');
            currentView.value = 'home';
            inputCode.value = ''; buyerName.value = ''; note.value = '';
          } catch(e) { alert("é€å‡ºå¤±æ•—"); } finally { submitting.value = false; }
        };

        const handleLogin = async () => {
          if (!loginForm.value.id || !loginForm.value.pass) return alert('è«‹è¼¸å…¥å¸³å¯†');
          loading.value = true;
          try {
            const inputId = loginForm.value.id.toUpperCase().trim();
            const inputPass = String(loginForm.value.pass).trim();
            const q = query(collection(db, "companies"), where("id", "==", inputId), where("password", "==", inputPass));
            const snap = await getDocs(q);

            if (!snap.empty) {
              const userData = snap.docs[0].data();
              const safeCompanyName = userData.name || userData.companyName || inputId;
              user.value = { id: inputId, companyName: safeCompanyName, ...userData };
              
              if (inputId === 'ADMIN') {
                currentView.value = 'admin';
                adminTab.value = 'details';
                await fetchOrderDetails();
                await fetchReviewList();
              } else {
                currentView.value = 'leader';
                await fetchLeaderGroups();
              }
            } else { alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤"); }
          } catch (e) { alert("è³‡æ–™åº«éŒ¯èª¤"); } finally { loading.value = false; }
        };

        const fetchLeaderGroups = async () => {
          try {
            const q = query(collection(db, "groupOrders"), where("companyId", "==", user.value.id));
            const snap = await getDocs(q);
            const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            leaderGroups.value = list.sort((a, b) => {
                const tA = a.createdAt ? a.createdAt.seconds : 0;
                const tB = b.createdAt ? b.createdAt.seconds : 0;
                return tB - tA;
            });
          } catch(e) { console.error(e); }
        };

        const viewDetail = async (group) => {
          if (selectedGroup.value && selectedGroup.value.id === group.id) { selectedGroup.value = null; return; }
          selectedGroup.value = group;
          loadingDetail.value = true;
          try {
            const q = query(collection(db, "orders"), where("groupOrderId", "==", group.id));
            const snap = await getDocs(q);
            const orders = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            selectedDetail.value = { list: orders, totalAmount: orders.reduce((sum, o) => sum + (o.totalAmount || 0), 0) };
          } catch (e) { console.error(e); } finally { loadingDetail.value = false; }
        };

        const togglePaid = async (order) => {
          try { await updateDoc(doc(db, "orders", order.id), { isPaid: order.isPaid }); } catch(e) {}
        };

        const createGroup = async () => {
          loading.value = true;
          const newCode = Math.random().toString(36).substring(2, 8).toUpperCase();
          try {
            await addDoc(collection(db, "groupOrders"), {
              code: newCode,
              companyId: user.value.id,
              companyName: user.value.companyName,
              leaderName: user.value.leaderName || '',
              phone: user.value.phone || '',
              address: user.value.address || '',
              status: "OPEN",
              createdAt: serverTimestamp()
            });
            alert(`é–‹åœ˜æˆåŠŸï¼åºè™Ÿï¼š${newCode}`);
            await fetchLeaderGroups();
          } finally { loading.value = false; }
        };

        const submitGroup = async (group) => {
            if(!confirm(`ç¢ºå®šè¦çµå–®å—ï¼Ÿ\né€å‡ºå¾ŒåŒäº‹å°‡ç„¡æ³•å†ä¸‹å–®ï¼Œä¸¦æœƒé€šçŸ¥ç®¡ç†å“¡å‚™è²¨ã€‚`)) return;
            try {
                await updateDoc(doc(db, "groupOrders", group.id), { status: "SUBMITTED" });
                alert("å·²é€å‡ºçµ¦ç®¡ç†å“¡ç¢ºèªï¼");
                await fetchLeaderGroups();
            } catch(e) { alert("çµå–®å¤±æ•—ï¼š" + e.message); }
        };

        const recallGroup = async (group) => {
            if(!confirm("ç¢ºå®šè¦æ”¶å›å—ï¼Ÿ\næ”¶å›å¾Œç‹€æ…‹å°‡è®Šå›ã€Œé€²è¡Œä¸­ã€ï¼Œæ‚¨å¯ä»¥ç¹¼çºŒè®“åŒäº‹ä¸‹å–®ã€‚")) return;
            try {
                await updateDoc(doc(db, "groupOrders", group.id), { status: "OPEN" });
                alert("å·²æ”¶å›ï¼æ‚¨å¯ä»¥ç¹¼çºŒç·¨è¼¯ã€‚");
                await fetchLeaderGroups();
            } catch(e) { alert("æ”¶å›å¤±æ•—ï¼š" + e.message); }
        };

        const fetchReviewList = async () => {
            try {
                const qReview = query(collection(db, "groupOrders"), where("status", "==", "SUBMITTED"));
                const reviewSnap = await getDocs(qReview);
                adminData.value.reviewList = reviewSnap.docs.map(d => ({id: d.id, ...d.data()}));
            } catch(e) { console.error(e); }
        };

        const fetchOrderDetails = async () => {
            loading.value = true;
            try {
                const qOrders = query(collection(db, "orders"), where("orderDate", "==", orderDate.value));
                const orderSnap = await getDocs(qOrders);
                const allOrders = orderSnap.docs.map(d => ({
                    id: d.id, 
                    ...d.data(),
                    expanded: false // é è¨­æ”¶åˆ
                }));
                
                const groupMap = {};
                allOrders.forEach(o => {
                  const gid = o.groupOrderId || o.companyName || 'unknown';
                  if (!groupMap[gid]) {
                      groupMap[gid] = { 
                        groupOrderId: o.groupOrderId,
                        companyName: o.companyName || 'æ•£å®¢', 
                        orders: [], 
                        total: 0,
                        allExpanded: false // é è¨­å…¨éƒ¨æ”¶åˆ
                      };
                  }
                  groupMap[gid].orders.push(o);
                  if (o.status === 'CONFIRMED') {
                     groupMap[gid].total += o.totalAmount;
                  }
                });
                adminData.value.groupList = Object.values(groupMap);
            } finally { loading.value = false; }
        };

        // æ–°å¢ï¼šåˆ‡æ›æ•´åœ˜å±•é–‹ç‹€æ…‹
        const toggleGroupExpand = (group) => {
           group.allExpanded = !group.allExpanded;
           group.orders.forEach(o => o.expanded = group.allExpanded);
        };

        const fetchStockList = async () => {
            loading.value = true;
            try {
                const qOrders = query(collection(db, "orders"), where("orderDate", "==", stockDate.value), where("status", "==", "CONFIRMED"));
                const orderSnap = await getDocs(qOrders);
                const confirmedOrders = orderSnap.docs.map(d => ({id: d.id, ...d.data()}));

                const stockMap = {};
                confirmedOrders.forEach(o => {
                  if (o.items) o.items.forEach(i => stockMap[i.name] = (stockMap[i.name] || 0) + i.qty);
                });
                adminData.value.stockList = Object.keys(stockMap).map(name => ({ name, qty: stockMap[name] }));
            } finally { loading.value = false; }
        };

        const fetchLabelList = async () => {
            loading.value = true;
            try {
                const qOrders = query(collection(db, "orders"), where("orderDate", "==", labelDate.value), where("status", "==", "CONFIRMED"));
                const orderSnap = await getDocs(qOrders);
                const confirmedOrders = orderSnap.docs.map(d => ({id: d.id, ...d.data()}));
                
                adminData.value.labelList = confirmedOrders.sort((a, b) => (a.companyName || '').localeCompare(b.companyName || ''));
            } finally { loading.value = false; }
        };

        const fetchAdminData = async () => {
             if(adminTab.value === 'details') fetchOrderDetails();
             if(adminTab.value === 'stock') fetchStockList();
             if(adminTab.value === 'labels') fetchLabelList();
             if(adminTab.value === 'review') fetchReviewList();
        };

        const fetchAdminItems = async () => {
          loading.value = true;
          try {
            const snap = await getDocs(collection(db, "items"));
            adminItems.value = snap.docs.map(doc => {
              const data = doc.data();
              return { ...data, docId: doc.id };
            });
          } finally {
            loading.value = false;
          }
        };

        const openItemModal = (item = null) => {
          if (item) {
            editingItem.value = { ...item };
          } else {
            editingItem.value = { name: '', price: 0, category: '', image: '' };
          }
        };

        const handleImageUpload = (event) => {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
             const img = new Image();
             img.onload = () => {
                 const canvas = document.createElement('canvas');
                 const ctx = canvas.getContext('2d');
                 const MAX_WIDTH = 800;
                 let width = img.width;
                 let height = img.height;
                 if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                 canvas.width = width; canvas.height = height;
                 ctx.drawImage(img, 0, 0, width, height);
                 editingItem.value.image = canvas.toDataURL('image/jpeg', 0.6);
             };
             img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        };

        const saveItem = async () => {
          if (!editingItem.value.name || editingItem.value.price <= 0) return alert('è«‹å¡«å¯«æ­£ç¢ºå“åèˆ‡åƒ¹æ ¼');
          loading.value = true;
          try {
            const productData = {
                name: editingItem.value.name,
                price: editingItem.value.price,
                category: editingItem.value.category,
                image: editingItem.value.image || '' 
            };
            if (editingItem.value.docId) {
              await updateDoc(doc(db, "items", editingItem.value.docId), productData);
            } else {
              await addDoc(collection(db, "items"), productData);
            }
            editingItem.value = null;
            await fetchAdminItems();
            alert('å„²å­˜æˆåŠŸï¼');
          } catch (e) { alert('å„²å­˜å¤±æ•—ï¼š' + e.message); } finally { loading.value = false; }
        };

        const deleteItem = async (docId) => {
          if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç”¢å“å—ï¼Ÿé€™å°‡å½±éŸ¿ä¹‹å¾Œçš„é»é¤é¸å–®ã€‚')) return;
          try {
            await deleteDoc(doc(db, "items", docId));
            await fetchAdminItems();
          } catch (e) { alert('åˆªé™¤å¤±æ•—'); }
        };

        const fetchAdminAccounts = async () => {
            loading.value = true;
            try {
                const snap = await getDocs(collection(db, "companies"));
                adminAccounts.value = snap.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
            } finally { loading.value = false; }
        };

        const openAccountModal = (acc = null) => {
            if (acc) {
                editingAccount.value = { ...acc };
            } else {
                editingAccount.value = { id: '', password: '', name: '', department: '', leaderName: '', phone: '', address: '' };
            }
        };

        const saveAccount = async () => {
            if (!editingAccount.value.id || !editingAccount.value.password || !editingAccount.value.name) {
                return alert('IDã€å…¬å¸åç¨±ã€å¯†ç¢¼ç‚ºå¿…å¡«æ¬„ä½');
            }
            loading.value = true;
            try {
                const accData = {
                    id: editingAccount.value.id.toUpperCase(),
                    password: editingAccount.value.password,
                    name: editingAccount.value.name,
                    department: editingAccount.value.department || '',
                    leaderName: editingAccount.value.leaderName || '',
                    phone: editingAccount.value.phone || '',
                    address: editingAccount.value.address || ''
                };

                if (editingAccount.value.docId) {
                    await updateDoc(doc(db, "companies", editingAccount.value.docId), accData);
                } else {
                    const q = query(collection(db, "companies"), where("id", "==", accData.id));
                    const snap = await getDocs(q);
                    if (!snap.empty) { alert("æ­¤å¸³è™Ÿ ID å·²å­˜åœ¨ï¼"); loading.value = false; return; }
                    await addDoc(collection(db, "companies"), accData);
                }
                editingAccount.value = null;
                await fetchAdminAccounts();
                alert('å„²å­˜æˆåŠŸï¼');
            } catch (e) { alert('å„²å­˜å¤±æ•—ï¼š' + e.message); } finally { loading.value = false; }
        };

        const deleteAccount = async (docId) => {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å¸³è™Ÿå—ï¼Ÿ')) return;
            try {
                await deleteDoc(doc(db, "companies", docId));
                await fetchAdminAccounts();
            } catch (e) { alert('åˆªé™¤å¤±æ•—'); }
        };

        const confirmGroup = async (group) => {
            if(!confirm(`ç¢ºèªæ¥æ”¶ [${group.companyName}] çš„è¨‚å–®å—ï¼Ÿ`)) return;
            loading.value = true;
            try {
                await updateDoc(doc(db, "groupOrders", group.id), { status: "CONFIRMED" });
                const qOrders = query(collection(db, "orders"), where("groupOrderId", "==", group.id));
                const orderSnap = await getDocs(qOrders);
                const batch = writeBatch(db);
                orderSnap.docs.forEach(doc => { batch.update(doc.ref, { status: "CONFIRMED" }); });
                await batch.commit();
                alert("âœ… å·²ç¢ºèªæ¥æ”¶ï¼");
                await fetchReviewList();
            } finally { loading.value = false; }
        };

        const rejectGroup = async (groupId) => {
            if (!groupId) return alert("ç„¡æ³•è­˜åˆ¥åœ˜è³¼å–®è™Ÿ");
            if(!confirm("ç¢ºå®šè¦å°‡æ­¤åœ˜è³¼é€€å›ã€Œé€²è¡Œä¸­ã€ç‹€æ…‹å—ï¼Ÿ\n\næ³¨æ„ï¼šè©²åœ˜æ‰€æœ‰è¨‚å–®éƒ½æœƒè®Šæˆã€Œå¾…ç¢ºèªã€ã€‚")) return;
            loading.value = true;
            try {
                await updateDoc(doc(db, "groupOrders", groupId), { status: "OPEN" });
                const qOrders = query(collection(db, "orders"), where("groupOrderId", "==", groupId));
                const orderSnap = await getDocs(qOrders);
                const batch = writeBatch(db);
                orderSnap.docs.forEach(doc => { batch.update(doc.ref, { status: "PENDING" }); });
                await batch.commit();
                alert("âœ… å·²æ•´åœ˜é€€å›ï¼");
                if(adminTab.value === 'details') await fetchOrderDetails();
            } catch(e) { alert("é€€å›å¤±æ•—ï¼š" + e.message); } finally { loading.value = false; }
        };

        const logout = () => { location.reload(); };
        const formatDate = (ts) => ts ? new Date(ts.seconds*1000).toLocaleDateString() : 'å‰›å‰›';
        const categories = computed(() => ['å…¨éƒ¨', ...new Set(items.value.map(i => i.category || 'ç²¾é¸'))]);
        const filteredItems = computed(() => filterCat.value === 'å…¨éƒ¨' ? items.value : items.value.filter(i => (i.category||'ç²¾é¸') === filterCat.value));
        const totalQty = computed(() => items.value.reduce((s, i) => s + (i.qty || 0), 0));
        const totalAmount = computed(() => items.value.reduce((s, i) => s + (i.price * (i.qty || 0)), 0));

        return {
          currentView, loading, loadingDetail, submitting, inputCode, sessionInfo, buyerName, note, items, filterCat,
          loginForm, user, adminData, leaderGroups, selectedGroup, selectedDetail,
          adminTab,
          adminItems, editingItem, previewImage,
          adminAccounts, editingAccount,
          orderDate, stockDate, labelDate,
          verifyCode, handleLogin, submitOrder, logout, createGroup, submitGroup, recallGroup, confirmGroup, rejectGroup, formatDate, viewDetail, togglePaid, fetchAdminData,
          fetchAdminItems, openItemModal, handleImageUpload, saveItem, deleteItem,
          fetchAdminAccounts, openAccountModal, saveAccount, deleteAccount,
          fetchOrderDetails, fetchStockList, fetchLabelList, fetchReviewList,
          categories, filteredItems, totalQty, totalAmount,
          toggleGroupExpand // æ–°å¢çš„å‡½å¼
        };
      }
    }).mount('#app');
  </script>
</body>
</html>